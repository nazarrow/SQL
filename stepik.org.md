[![N|Solid](https://upload.wikimedia.org/wikipedia/commons/4/42/Stepik_logotype.png)](https://stepik.org/)
# [Интерактивный тренажер по SQL](https://stepik.org/63054)
> Для форматирования использовал [codebeautify.org](https://codebeautify.org/sqlformatter#)
---
## 1. Основы реляционной модели и SQL

### 1.1 Отношение (таблица)

✳ Шаг 4. Основные понятия реляционных баз данных

Основные принципы реляционных баз данных:

- все данные на концептуальном уровне представляются в виде объектов, заданных в виде строк и столбцов, называемых отношением, более распространенное название – таблица;
- в пересечение строки и столбца таблицы можно занести только одно значение;
- все операции выполняются над целыми отношениями и результатом этих операций является отношение.
 
Пример отношения: 

![](https://ucarecdn.com/5c077c69-ade0-401a-a9f0-d7efdd6c0ceb/)

На примере таблицы Сотрудник рассмотрим терминологию реляционных баз данных:

- отношение  – это структура данных целиком, набор записей (в обычном понимании – таблица) , в  примере –это Сотрудник;
- кортеж – это каждая строка , содержащая данные (более распространенный термин – запись ), например, <001, Борин С.А, 234-01-23, программист>, все кортежи в отношении должны быть различны;
- мощность – число кортежей в таблице (проще говоря, число записей), в данном случае 3, мощность отношения может быть любой (от 0 до бесконечности), порядок следования кортежей - неважен;
- атрибут – это столбец в таблице (более распространенный термин – поле ), в примере – Табельный номер, Фамилия И.О., Телефон, Должность) 
- размерность – это число атрибутов в таблице, в данном случае – 4;
- размерность отношения должна быть больше 0, порядок следования атрибутов существенен;
- домен атрибута – это допустимые значения (неповторяющиеся), которые можно занести в поле , например для атрибута Должность домен – {инженер, программист}.

❓*Задание. Для таблицы Сотрудник отметьте верные ячейки (В каждом столбце и строке - один правильный ответ).*

✔`РЕШЕНИЕ` ⤵️

|Ряды:	                             |Мощность	|Размерность	|Атрибут	|Кортеж	|Отношение	|Домен|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|002, Иванов И.И., 234-12-01, инженер| | | |✓| | |
|4	                             | |✓| | | | |
|{###-##-##}, где # - цифра от 0 до 9| | | | | |✓|	
|Сотрудник	                     | | | | |✓| |
|3	                             |✓| | | | | |
|Фамилия И.О.                        | | |✓ | | | |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Отношение, реляционная модель

❓*Задание. Отметьте ПРАВИЛЬНЫЕ имена, которые можно выбрать в качестве названий таблиц или полей.*

✔`РЕШЕНИЕ` ⤵️

✅name_book
☐book store
✅price_rub
☐price(rub)
✅store
☐name -author

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Выбор типов данных для полей 

❓*Задание. Сопоставьте значения и типы данных, с помощью которых их можно описать.*

✔`РЕШЕНИЕ` ⤵️

|VARCHAR(11) |DECIMAL(5, 2) |VARCHAR(5) |DECIMAL(7, 1) |INT |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|Слово, Предложение, Абзац|5.12, -0.99, 10.12|sql, mySql, data|56.1, 456.1, 3000|-34078, 55, 0|

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Создание таблицы 

❓*Задание. Сформулируйте SQL запрос для создания таблицы book. Структура таблицы book:*

|Поле|Тип, описание|
|:---------------:|:---------------:|
|book_id|INT PRIMARY KEY AUTO_INCREMENT|
|title|VARCHAR(50)|
|author|INT PRIMARY KEY AUTO_INCREMENT|
|price|DECIMAL(8, 2)|
|amount|INT|

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE book (
  book_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author VARCHAR(30), 
  price DECIMAL(8, 2), 
  amount INT
);
```

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Вставка записи в таблицу

❓*Задание. Занесите новую строку в таблицу book (текстовые значения (тип VARCHAR) заключать либо в двойные, либо в одинарные кавычки):*

| book_id | title              | author        | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| INT PRIMARY KEY AUTO_INCREMENT      | VARCHAR(50) | INT PRIMARY KEY AUTO_INCREMENT | DECIMAL(8, 2) | INT     |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    1, "Мастер и Маргарита", 
    "Булгаков М.А.", 670.99, 
    3
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title              | author        | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита | Булгаков М.А. | 670.99 | 3      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Занесите три последние записи в таблицу book,  первая запись уже добавлена на предыдущем шаге:*

| book_id | title              | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия      | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот              | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы  | Достоевский Ф.М. | 799.01 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    2, "Белая гвардия", "Булгаков М.А.", 
    540.50, 5
  );
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    3, "Идиот", "Достоевский Ф.М.", 
    460.00, 10
  );
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    4, "Братья Карамазовы", 
    "Достоевский Ф.М.", 
    799.01, 2
  );
```

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 1.2 Выборка данных

✳ Шаг 2. Выборка всех данных из таблицы

❓*Задание. Вывести информацию о всех книгах, хранящихся на складе.
Для этого: 
Напишите SQL запрос в окне кода; 
Отправьте на проверку (кнопка  Отправить); 
Если запрос работает неверно, исправьте его и снова отправьте на проверку.*

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Выборка отдельных столбцов

❓*Задание. Выбрать авторов, название книг и их цену из таблицы book.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title                 | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита    | 670.99 |
| Булгаков М.А.    | Белая гвардия         | 540.50 |
| Достоевский Ф.М. | Идиот                 | 460.00 |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01 |
| Есенин С.А.      | Стихотворения и поэмы | 650.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Выборка новых столбцов и присвоение им новых имен

❓*Задание. Выбрать названия книг и авторов из таблицы book, для поля title задать имя(псевдоним) Название, для поля author –  Автор.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title AS Название, 
  author AS Автор 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Название              | Автор            |
|:---------------:|:---------------:|
| Мастер и Маргарита    | Булгаков М.А.    |
| Белая гвардия         | Булгаков М.А.    |
| Идиот                 | Достоевский Ф.М. |
| Братья Карамазовы     | Достоевский Ф.М. |
| Стихотворения и поэмы | Есенин С.А.      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Выборка данных с созданием вычисляемого столбца

❓*Задание. Для упаковки каждой книги требуется один лист бумаги, цена которого 1 рубль 65 копеек. Посчитать стоимость упаковки для каждой книги (сколько денег потребуется, чтобы упаковать все экземпляры книги). В запросе вывести название книги, ее количество и стоимость упаковки, последний столбец назвать pack.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  amount, 
  amount * 1.65 AS pack 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | amount | pack  |
|:---------------:|:---------------:|:---------------:|
| Мастер и Маргарита    | 3      | 4.95  |
| Белая гвардия         | 5      | 8.25  |
| Идиот                 | 10     | 16.50 |
| Братья Карамазовы     | 2      | 3.30  |
| Стихотворения и поэмы | 15     | 24.75 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Выборка данных, вычисляемые столбцы, математические функции

❓*Задание. В конце года цену всех книг на складе пересчитывают – снижают ее на 30%. Написать SQL запрос, который из таблицы book выбирает названия, авторов, количества и вычисляет новые цены книг. Столбец с новой ценой назвать new_price, цену округлить до 2-х знаков после запятой.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author, 
  amount, 
  ROUND (
    (price * 0.7), 
    2
  ) AS new_price 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | author           | amount | new_price |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 469.69    |
| Белая гвардия         | Булгаков М.А.    | 5      | 378.35    |
| Идиот                 | Достоевский Ф.М. | 10     | 322.00    |
| Братья Карамазовы     | Достоевский Ф.М. | 2      | 559.31    |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 455.00    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Выборка данных, вычисляемые столбцы, логические функции

❓*Задание. При анализе продаж книг выяснилось, что наибольшей популярностью пользуются книги Михаила Булгакова, на втором месте книги Сергея Есенина. Исходя из этого решили поднять цену книг Булгакова на 10%, а цену книг Есенина - на 5%. Написать запрос, куда включить автора, название книги и новую цену, последний столбец назвать new_price. Значение округлить до двух знаков после запятой.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  ROUND (
    IF (
      author = "Булгаков М.А.", 
      price * 1.1, 
      IF (
        author = "Есенин С.А.", price * 1.05, 
        price * 1
      )
    ), 
    2
  ) AS new_price 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title                 | new_price |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита    | 738.09    |
| Булгаков М.А.    | Белая гвардия         | 594.55    |
| Достоевский Ф.М. | Идиот                 | 460.00    |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01    |
| Есенин С.А.      | Стихотворения и поэмы | 682.50    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Выборка данных по условию

❓*Задание. Вывести автора, название  и цены тех книг, количество которых меньше 10.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  amount < 10;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title              | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита | 670.99 |
| Булгаков М.А.    | Белая гвардия      | 540.50 |
| Достоевский Ф.М. | Братья Карамазовы  | 799.01 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Выборка данных, логические операции

❓*Задание. Вывести название, автора,  цену  и количество всех книг, цена которых меньше 500 или больше 600, а стоимость всех экземпляров этих книг больше или равна 5000.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author, 
  price, 
  amount 
FROM 
  book 
WHERE 
  (
    price < 500 
    OR price > 600
  ) 
  AND price * amount >= 5000;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | author      | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Стихотворения и поэмы | Есенин С.А. | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. Выборка данных, операторы BETWEEN, IN

❓*Задание. Вывести название и авторов тех книг, цены которых принадлежат интервалу от 540.50 до 800 (включая границы),  а количество или 2, или 3, или 5, или 7 .*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author 
FROM 
  book 
WHERE 
  price BETWEEN 540.50 
  AND 800 
  AND amount IN (2, 3, 5, 7);
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title              | author           |
|:---------------:|:---------------:|
| Мастер и Маргарита | Булгаков М.А.    |
| Белая гвардия      | Булгаков М.А.    |
| Братья Карамазовы  | Достоевский Ф.М. |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. Выборка данных с сортировкой

❓*Задание. Вывести  автора и название  книг, количество которых принадлежит интервалу от 2 до 14 (включая границы). Информацию  отсортировать сначала по авторам (в обратном алфавитном порядке), а затем по названиям книг (по алфавиту).*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title 
FROM 
  book 
WHERE 
  amount BETWEEN 2 
  AND 14 
ORDER BY 
  1 DESC, 
  2 ASC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title              |
|:---------------:|:---------------:|
| Достоевский Ф.М. | Братья Карамазовы  |
| Достоевский Ф.М. | Идиот              |
| Булгаков М.А.    | Белая гвардия      |
| Булгаков М.А.    | Мастер и Маргарита |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 12. Выборка данных, оператор LIKE

❓*Задание. Вывести название и автора тех книг, название которых состоит из двух и более слов, а инициалы автора содержат букву «С». Считать, что в названии слова отделяются друг от друга пробелами и не содержат знаков препинания, между фамилией автора и инициалами обязателен пробел, инициалы записываются без пробела в формате: буква, точка, буква, точка. Информацию отсортировать по названию книги в алфавитном порядке.*
>Важно! Только для этого шага в таблицу добавлены новые записи.

Важно! Только для этого шага в таблицу добавлены новые записи.
Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       |                       | Иванов С.С.      | 50.00  | 10     |
| 7       | Дети полуночи         | Рушди Салман     | 950.00 | 5      |
| 8       | Лирика                | Гумилев Н.С.     | 460.00 | 10     |
| 9       | Поэмы                 | Бехтерев С.С.    | 460.00 | 10     |
| 10      | Капитанская дочка     | Пушкин А.С.      | 520.50 | 7      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author 
FROM 
  book 
WHERE 
  title LIKE "_% _%" 
  AND author LIKE "_% %С.%" 
ORDER BY 
  title;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | author      |
|:---------------:|:---------------:|
| Капитанская дочка     | Пушкин А.С. |
| Стихотворения и поэмы | Есенин С.А. |


┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 1.3 Запросы, групповые операции

✳ Шаг 2. Выбор уникальных элементов столбца

❓*Задание. Отобрать различные (уникальные) элементы столбца amount таблицы book.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  amount 
FROM 
  book 
GROUP BY 
  amount;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| amount |
|:---------------:|
| 3      |
| 5      |
| 10     |
| 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Выборка данных, групповые функции SUM и COUNT

❓*Задание. Посчитать, количество различных книг и количество экземпляров книг каждого автора , хранящихся на складе.  Столбцы назвать Автор, Различных_книг и Количество_экземпляров соответственно.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author AS Автор, 
  COUNT(amount) AS Различных_книг, 
  SUM(amount) AS Количество_экземпляров 
FROM 
  book 
GROUP BY 
  author;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| Автор            | Различных_книг | Количество_экземпляров |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | 2              | 8                      |
| Достоевский Ф.М. | 3              | 23                     |
| Есенин С.А.      | 1              | 15                     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Выборка данных, групповые функции MIN, MAX и AVG

❓*Задание. Вывести фамилию и инициалы автора, минимальную, максимальную и среднюю цену книг каждого автора . Вычисляемые столбцы назвать Минимальная_цена, Максимальная_цена и Средняя_цена соответственно.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  MIN(price) AS Минимальная_цена, 
  MAX(price) AS Максимальная_цена, 
  AVG(price) AS Средняя_цена 
FROM 
  book 
GROUP BY 
  author;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | Минимальная_цена | Максимальная_цена | Средняя_цена |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | 540.50           | 670.99            | 605.745000   |
| Достоевский Ф.М. | 460.00           | 799.01            | 579.836667   |
| Есенин С.А.      | 650.00           | 650.00            | 650.000000   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Выборка данных c вычислением, групповые функции

❓*Задание. Для каждого автора вычислить суммарную стоимость книг S (имя столбца Стоимость), а также вычислить налог на добавленную стоимость  для полученных сумм (имя столбца НДС ) , который включен в стоимость и составляет k = 18%,  а также стоимость книг  (Стоимость_без_НДС) без него. Значения округлить до двух знаков после запятой. В запросе для расчета НДС(tax)  и Стоимости без НДС(S_without_tax) использовать следующие формулы:*

`tax = (S * k/100) / (1 + k/100)`
`S_without_tax = S / (1 + k/100)`

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  SUM(price * amount) AS Стоимость, 
  ROUND(
    SUM(price * amount) * 0.18 / 1.18, 
    2
  ) AS НДС, 
  ROUND(
    SUM(price * amount) / 1.18, 
    2
  ) AS Стоимость_без_НДС 
FROM 
  book 
GROUP BY 
  author;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | Стоимость | НДС     | Стоимость_без_НДС |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | 4715.47   | 719.31  | 3996.16           |
| Достоевский Ф.М. | 11802.03  | 1800.31 | 10001.72          |
| Есенин С.А.      | 9750.00   | 1487.29 | 8262.71           |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Вычисления по таблице целиком

❓*Задание. Вывести  цену самой дешевой книги, цену самой дорогой и среднюю цену уникальных книг на складе. Названия столбцов Минимальная_цена, Максимальная_цена, Средняя_цена соответственно. Среднюю цену округлить до двух знаков после запятой.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  MIN(price) AS Минимальная_цена, 
  MAX(price) AS Максимальная_цена, 
  ROUND(
    AVG(price), 
    2
  ) AS Средняя_цена 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| Минимальная_цена | Максимальная_цена | Средняя_цена |
|:---------------:|:---------------:|:---------------:|
| 460.00           | 799.01            | 600.17       |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Выборка данных по условию, групповые функции

❓*Задание. Вычислить среднюю цену и суммарную стоимость тех книг, количество экземпляров которых принадлежит интервалу от 5 до 14, включительно. Столбцы назвать Средняя_цена и Стоимость, значения округлить до 2-х знаков после запятой.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  ROUND(
    AVG(price), 
    2
  ) AS Средняя_цена, 
  ROUND(
    SUM(price * amount), 
    2
  ) AS Стоимость 
FROM 
  book 
WHERE 
  amount BETWEEN 5 
  AND 14;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| Средняя_цена | Стоимость |
|:---------------:|:---------------:|
| 493.67       | 12107.50  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Выборка данных по условию, групповые функции, WHERE и HAVING

❓*Задание. Посчитать стоимость всех экземпляров каждого автора без учета книг «Идиот» и «Белая гвардия». В результат включить только тех авторов, у которых суммарная стоимость книг (без учета книг «Идиот» и «Белая гвардия») более 5000 руб. Вычисляемый столбец назвать Стоимость. Результат отсортировать по убыванию стоимости.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  SUM(price * amount) AS Стоимость 
FROM 
  book 
WHERE 
  title <> "Идиот" 
  AND title <> "Белая гвардия" 
GROUP BY 
  author 
HAVING 
  SUM(price * amount) > 5000 
ORDER BY 
  Стоимость DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | Стоимость |
|:---------------:|:---------------:|
| Есенин С.А.      | 9750.00   |
| Достоевский Ф.М. | 7202.03   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 1.4 Вложенные запросы

✳ Шаг 2. Вложенный запрос, возвращающий одно значение

❓*Задание. Вывести информацию (автора, название и цену) о  книгах, цены которых меньше или равны средней цене книг на складе. Информацию вывести в отсортированном по убыванию цены виде. Среднее вычислить как среднее по цене книги.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  price <= (
    SELECT 
      AVG(price) 
    FROM 
      book
  ) 
ORDER BY 
  price DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title         | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Белая гвардия | 540.50 |
| Достоевский Ф.М. | Игрок         | 480.50 |
| Достоевский Ф.М. | Идиот         | 460.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Использование вложенного запроса в выражении

❓*Задание. Вывести информацию (автора, название и цену) о тех книгах, цены которых превышают минимальную цену книги на складе не более чем на 150 рублей в отсортированном по возрастанию цены виде.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 7       | Евгений Онегин        | Пушкин А.С.      | 610.00 | 10     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  price - (
    SELECT 
      MIN(price) 
    FROM 
      book
  ) <= 150 
ORDER BY 
  3 ASC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title          | price  |
|:---------------:|:---------------:|:---------------:|
| Достоевский Ф.М. | Идиот          | 460.00 |
| Достоевский Ф.М. | Игрок          | 480.50 |
| Булгаков М.А.    | Белая гвардия  | 540.50 |
| Пушкин А.С.      | Евгений Онегин | 610.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Вложенный запрос, оператор IN

❓*Задание. Вывести информацию (автора, книгу и количество) о тех книгах, количество экземпляров которых в таблице book не дублируется.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  amount 
FROM 
  book 
WHERE 
  amount IN (
    SELECT 
      amount 
    FROM 
      book 
    GROUP BY 
      amount 
    HAVING 
      COUNT(amount) = 1
  );
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author        | title                 | amount |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А. | Белая гвардия         | 5      |
| Есенин С.А.   | Стихотворения и поэмы | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Вложенный запрос, операторы ANY и ALL

❓*Задание 5. Вывести информацию о книгах(автор, название, цена), цена которых меньше самой большой из минимальных цен, вычисленных для каждого автора.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  price < ANY (
    SELECT 
      MIN(price) 
    FROM 
      book 
    GROUP BY 
      author
  );
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title         | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Белая гвардия | 540.50 |
| Достоевский Ф.М. | Идиот         | 460.00 |
| Достоевский Ф.М. | Игрок         | 480.50 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Вложенный запрос после SELECT

❓*Задание. Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на складе стало одинаковое количество экземпляров каждой книги, равное значению самого большего количества экземпляров одной книги на складе. Вывести название книги, ее автора, текущее количество экземпляров на складе и количество заказываемых экземпляров книг. Последнему столбцу присвоить имя Заказ. В результат не включать книги, которые заказывать не нужно.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author, 
  amount, 
  (
    SELECT 
      MAX(amount) 
    FROM 
      book
  ) - amount AS Заказ 
FROM 
  book 
WHERE 
  amount <> (
    SELECT 
      MAX(amount) 
    FROM 
      book
  );
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title              | author           | amount | Заказ |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 1.5 Запросы корректировки данных

✳ Шаг 2. Создание пустой таблицы

❓*Задание. Создать таблицу поставка (supply), которая имеет ту же структуру, что и таблиц book.*

| Поле              | Тип, описание           | 
|:---------------:|:---------------:|
| supply_id       | INT PRIMARY KEY AUTO_INCREMENT    | 
| title           | VARCHAR(50)    | 
| author          | VARCHAR(30) | 
| price           | DECIMAL(8, 2) | 
| amount          | INT |

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE supply (
  supply_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author VARCHAR(30), 
  price DECIMAL(8, 2), 
  amount INT
);
```

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Добавление записей в таблицу

❓*Задание. Занесите в таблицу supply четыре записи, чтобы получилась следующая таблица:*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Лирика          | Пастернак Б.Л.	 | 518.99	 | 2      |
| 2       | Черный человек  | Есенин С.А.      | 570.20	 | 6     |
| 3       | Белая гвардия   | Булгаков М.А.    | 540.50 | 7     |
| 4       | Идиот           | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO supply (
  supply_id, title, author, price, amount
) 
VALUES 
  (
    1, "Лирика", "Пастернак Б.Л.", 
    518.99, 2
  ), 
  (
    2, "Черный человек", 
    "Есенин С.А.", 570.20, 6
  ), 
  (
    3, "Белая гвардия", "Булгаков М.А.", 
    540.50, 7
  ), 
  (
    4, "Идиот", "Достоевский Ф.М.", 
    360.80, 3
  );
  ```
🔎 `РЕЗУЛЬТАТ` ⤵️

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Добавление записей из другой таблицы

❓*Задание. Добавить из таблицы supply в таблицу book, все книги, кроме книг, написанных Булгаковым М.А. и Достоевским Ф.М.*

Структура и наполнение таблиц book и supply:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Лирика          | Пастернак Б.Л.	 | 518.99	 | 2      |
| 2       | Черный человек  | Есенин С.А.      | 570.20	 | 6     |
| 3       | Белая гвардия   | Булгаков М.А.    | 540.50 | 7     |
| 4       | Идиот           | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (title, author, price, amount) 
SELECT 
  title, 
  author, 
  price, 
  amount 
FROM 
  supply 
WHERE 
  author NOT IN(
    "Булгаков М.А.", "Достоевский Ф.М."
  );
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Добавление записей, вложенные запросы

❓*Задание. Занести из таблицы supply в таблицу book только те книги, авторов которых нет в  book.*

Структура и наполнение таблиц book и supply:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Лирика          | Пастернак Б.Л.	 | 518.99	 | 2      |
| 2       | Черный человек  | Есенин С.А.      | 570.20	 | 6     |
| 3       | Белая гвардия   | Булгаков М.А.    | 540.50 | 7     |
| 4       | Идиот           | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (title, author, price, amount) 
SELECT 
  title, 
  author, 
  price, 
  amount 
FROM 
  supply 
WHERE 
  author NOT IN(
    SELECT 
      author 
    FROM 
      book
  );
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Запросы на обновление

❓*Задание. Уменьшить на 10% цену тех книг в таблице book, количество которых принадлежит интервалу от 5 до 10, включая границы.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
SET 
  price = 0.9 * price 
WHERE 
  amount BETWEEN 5 
  AND 10;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 486.45 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 414.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Запросы на обновление нескольких столбцов

❓*Задание. В таблице book необходимо скорректировать значение для покупателя в столбце buy таким образом, чтобы оно не превышало количество экземпляров книг, указанных в столбце amount. А цену тех книг, которые покупатель не заказывал, снизить на 10%.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount | buy |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 18  |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
SET 
  buy = IF(buy > amount, amount, buy), 
  price = IF(buy = 0, 0.9 * price, price);
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount | buy |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 603.89 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 719.11 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 15  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Запросы на обновление нескольких таблиц

❓*Задание. Для тех книг в таблице book , которые есть в таблице supply, не только увеличить их количество в таблице book ( увеличить их количество на значение столбца amountтаблицы supply), но и пересчитать их цену (для каждой книги найти сумму цен из таблиц book и supply и разделить на 2).*

Структура и наполнение таблиц book и supply:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book, 
  supply 
SET 
  book.amount = book.amount + supply.amount, 
  book.price = (book.price + supply.price)/ 2 
WHERE 
  book.title = supply.title 
  AND book.author = supply.author;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 410.40 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Запросы на удаление

❓*Задание. Удалить из таблицы supply книги тех авторов, общее количество экземпляров книг которых в таблице book превышает 10.*

Структура и наполнение таблиц book и supply:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  supply 
WHERE 
  author IN (
    SELECT 
      author 
    FROM 
      book 
    GROUP BY 
      author 
    HAVING 
      SUM(amount) > 10
  );
SELECT 
  * 
FROM 
  supply;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| supply_id | title         | author         | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика        | Пастернак Б.Л. | 518.99 | 2      |
| 3         | Белая гвардия | Булгаков М.А.  | 540.50 | 7      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. Запросы на создание таблицы

❓*Задание. Создать таблицу заказ (ordering), куда включить авторов и названия тех книг, количество экземпляров которых в таблице book меньше среднего количества экземпляров книг в таблице book. В таблицу включить столбец   amount, в котором для всех книг указать одинаковое значение - среднее количество экземпляров книг в таблице book.*

Структура и наполнение таблицы book:

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE ordering AS 
SELECT 
  author, 
  title, 
  (
    SELECT 
      ROUND(
        AVG(amount)
      ) 
    FROM 
      book
  ) AS amount 
FROM 
  book 
WHERE 
  amount < (
    SELECT 
      ROUND(
        AVG(amount)
      ) 
    FROM 
      book
  );
SELECT 
  * 
FROM 
  ordering;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title              | amount |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита | 7      |
| Булгаков М.А.    | Белая гвардия      | 7      |
| Достоевский Ф.М. | Братья Карамазовы  | 7      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 1.6 Таблица "Командировки", запросы на выборку

✳ Шаг 2.

❓*Задание. Вывести из таблицы trip информацию о командировках тех сотрудников, фамилия которых заканчивается на букву «а», в отсортированном по убыванию даты последнего дня командировки виде. В результат включить столбцы name, city, per_diem, date_first, date_last.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  per_diem, 
  date_first, 
  date_last 
FROM 
  trip 
WHERE 
  name LIKE "%а %" 
ORDER by 
  date_last DESC;
SELECT 
  * 
FROM 
  trip;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| Федорова А.Ю. | Томск           | 450.00   | 2020-06-20 | 2020-06-26 |
| Абрамова К.А. | Санкт-Петербург | 700.00   | 2020-05-28 | 2020-06-04 |
| Федорова А.Ю. | Новосибирск     | 450.00   | 2020-05-25 | 2020-06-04 |
| Абрамова К.А. | Москва          | 700.00   | 2020-04-06 | 2020-04-14 |
| Абрамова К.А. | Москва          | 700.00   | 2020-02-23 | 2020-03-01 |
| Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3.

❓*Задание. Вывести в алфавитном порядке фамилии и инициалы тех сотрудников, которые были в командировке в Москве.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name 
FROM 
  trip 
WHERE 
  city = "Москва" 
GROUP BY 
  name 
ORDER BY 
  name ASC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          |
|:---------------:|
| Абрамова К.А. |
| Баранов П.Е.  |
| Колесов С.П.  |
| Лебедев Т.К.  |
| Семенов И.В.  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4.

❓*Задание. Для каждого города посчитать, сколько раз сотрудники в нем были.  Информацию вывести в отсортированном в алфавитном порядке по названию городов. Вычисляемый столбец назвать Количество.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  city, 
  COUNT(name) AS Количество 
FROM 
  trip 
GROUP BY 
  city 
ORDER BY 
  city ASC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| city            | Количество |
|:---------------:|:---------------:|
| Владивосток     | 3          |
| Воронеж         | 1          |
| Москва          | 7          |
| Новосибирск     | 4          |
| Санкт-Петербург | 3          |
| Томск           | 2          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Оператор LIMIT

❓*Задание. Вывести два города, в которых чаще всего были в командировках сотрудники. Вычисляемый столбец назвать Количество.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  city, 
  COUNT(name) AS Количество 
FROM 
  trip 
GROUP BY 
  city 
ORDER BY 
  2 DESC 
LIMIT 
  2;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| city        | Количество |
|:---------------:|:---------------:|
| Москва      | 7          |
| Новосибирск | 4          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6.

❓*Задание. Вывести информацию о командировках во все города кроме Москвы и Санкт-Петербурга (фамилии и инициалы сотрудников, город ,  длительность командировки в днях, при этом первый и последний день относится к периоду командировки). Последний столбец назвать Длительность. Информацию вывести в упорядоченном по убыванию длительности поездки, а потом по убыванию названий городов (в обратном алфавитном порядке).*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  (
    DATEDIFF(date_last, date_first) + 1
  ) AS Длительность 
FROM 
  trip 
WHERE 
  city NOT IN (
    'Москва', 'Санкт-Петербург'
  ) 
ORDER BY 
  Длительность DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city        | Длительность |
|:---------------:|:---------------:|:---------------:|
| Ильиных Г.Р.  | Владивосток | 22           |
| Баранов П.Е.  | Новосибирск | 17           |
| Колесов С.П.  | Новосибирск | 15           |
| Абрамова К.А. | Владивосток | 14           |
| Лебедев Т.К.  | Томск       | 12           |
| Абрамова К.А. | Владивосток | 12           |
| Федорова А.Ю. | Новосибирск | 11           |
| Колесов С.П.  | Новосибирск | 10           |
| Федорова А.Ю. | Томск       | 7            |
| Баранов П.Е.  | Воронеж     | 7            |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7.

❓*Задание. Вывести информацию о командировках сотрудника(ов), которые были самыми короткими по времени. В результат включить столбцы name, city, date_first, date_last.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  date_first, 
  date_last 
FROM 
  trip 
WHERE 
  DATEDIFF(date_last, date_first) IN(
    SELECT 
      MIN(
        DATEDIFF(date_last, date_first)
      ) 
    FROM 
      trip
  );
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name         | city            | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Семенов И.В. | Санкт-Петербург | 2020-06-01 | 2020-06-03 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8.

❓*Задание. Вывести информацию о командировках, начало и конец которых относятся к одному месяцу (год может быть любой). В результат включить столбцы name, city, date_first, date_last. Строки отсортировать сначала в алфавитном порядке по названию города, а затем по фамилии сотрудника.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  date_first, 
  date_last 
FROM 
  trip 
WHERE 
  MONTH(date_first) = MONTH(date_last) 
ORDER BY 
  city, 
  name;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city            | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Абрамова К.А. | Владивосток     | 2020-01-14 | 2020-01-27 |
| Абрамова К.А. | Владивосток     | 2020-07-02 | 2020-07-13 |
| Баранов П.Е.  | Воронеж         | 2020-07-19 | 2020-07-25 |
| Абрамова К.А. | Москва          | 2020-04-06 | 2020-04-14 |
| Баранов П.Е.  | Москва          | 2020-01-12 | 2020-01-17 |
| Баранов П.Е.  | Москва          | 2020-02-14 | 2020-02-22 |
| Колесов С.П.  | Москва          | 2020-02-01 | 2020-02-06 |
| Лебедев Т.К.  | Москва          | 2020-03-03 | 2020-03-06 |
| Семенов И.В.  | Москва          | 2020-01-23 | 2020-01-31 |
| Колесов С.П.  | Новосибирск     | 2020-06-03 | 2020-06-12 |
| Семенов И.В.  | Санкт-Петербург | 2020-06-01 | 2020-06-03 |
| Лебедев Т.К.  | Томск           | 2020-05-20 | 2020-05-31 |
| Федорова А.Ю. | Томск           | 2020-06-20 | 2020-06-26 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9.

❓*Задание. Вывести название месяца и количество командировок для каждого месяца. Считаем, что командировка относится к некоторому месяцу, если она началась в этом месяце. Информацию вывести сначала в отсортированном по убыванию количества, а потом в алфавитном порядке по названию месяца виде. Название столбцов – Месяц и Количество.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  MONTHNAME(date_first) AS Месяц, 
  (
    COUNT(date_first)
  ) AS Количество 
FROM 
  trip 
GROUP BY 
  1 
ORDER BY 
  2 DESC, 
  1;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| Месяц    | Количество |
|:---------------:|:---------------:|
| February | 4          |
| January  | 4          |
| June     | 3          |
| May      | 3          |
| April    | 2          |
| July     | 2          |
| March    | 2          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10.

❓*Задание. Вывести сумму суточных (произведение количества дней командировки и размера суточных) для командировок, первый день которых пришелся на февраль или март 2020 года. Значение суточных для каждой командировки занесено в столбец per_diem. Вывести фамилию и инициалы сотрудника, город, первый день командировки и сумму суточных. Последний столбец назвать Сумма. Информацию отсортировать сначала  в алфавитном порядке по фамилиям сотрудников, а затем по убыванию суммы суточных.*

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  date_first, 
  (
    DATEDIFF(date_last + 1, date_first) * per_diem
  ) AS Сумма 
FROM 
  trip 
WHERE 
  MONTHNAME(date_first) IN("February", "March") 
ORDER BY 
  1, 
  4 DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city            | date_first | Сумма   |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Абрамова К.А. | Москва          | 2020-02-23 | 5600.00 |
| Баранов П.Е.  | Москва          | 2020-02-14 | 6300.00 |
| Колесов С.П.  | Новосибирск     | 2020-02-27 | 6750.00 |
| Колесов С.П.  | Москва          | 2020-02-01 | 4200.00 |
| Лебедев Т.К.  | Москва          | 2020-03-03 | 2800.00 |
| Семенов И.В.  | Санкт-Петербург | 2020-03-29 | 5600.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11.

❓*Задание. Вывести фамилию с инициалами и общую сумму суточных, полученных за все командировки для тех сотрудников, которые были в командировках больше чем 3 раза, в отсортированном по убыванию сумм суточных виде. Последний столбец назвать Сумма.
Только для этого задания изменена строка таблицы trip:*

|4	|Ильиных Г.Р.	|Владивосток	|450	|2020-01-12	|2020-03-02|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|

Структура и наполнение таблицы trip:

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-03-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  SUM(
    (
      DATEDIFF(date_last, date_first) + 1
    ) * per_diem
  ) AS Сумма 
FROM 
  trip 
WHERE 
  name IN(
    SELECT 
      name 
    FROM 
      trip 
    GROUP BY 
      name 
    HAVING 
      COUNT(name) > 3
  ) 
GROUP BY 
  name 
ORDER BY 
  2 DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | Сумма    |
|:---------------:|:---------------:|
| Абрамова К.А. | 29200.00 |
| Баранов П.Е.  | 21300.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 1.7 Таблица "Нарушения ПДД", запросы корректировки

✳ Шаг 2.

❓*Задание. Создать таблицу fine следующей структуры:*

|Поле	          |Описание|
|:-------------:|:---------------:|
|fine_id	      |ключевой столбец целого типа с автоматическим увеличением значения ключа на 1|
|name	          |строка длиной 30|
|number_plate	  |строка длиной 6|
|violation	    |строка длиной 50|
|sum_fine	      |вещественное число, максимальная длина 8, количество знаков после запятой 2|
|date_violation	|дата|
|date_payment	  |дата|

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE fine (
  fine_id INT PRIMARY KEY AUTO_INCREMENT, 
  name VARCHAR(30), 
  number_plate VARCHAR(6), 
  violation VARCHAR(50), 
  sum_fine DECIMAL(8, 2), 
  date_violation DATE, 
  date_payment DATE
);
```
🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3.

❓*Задание. В таблицу fine первые 5 строк уже занесены. Добавить в таблицу записи с ключевыми значениями 6, 7, 8.*

|fine_id	|name	|number_plate	|violation	|sum_fine	|date_violation	|date_payment|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|1	|Баранов П.Е.	|Р523ВТ	|Превышение скорости(от 40 до 60)	|500.00	    |2020-01-12	||2020-01-17|
|2	|Абрамова К.А.|О111АВ	|Проезд на запрещающий сигнал	    |1000.00	  |2020-01-14	|2020-02-27|
|3	|Яковлев Г.Р.	|Т330ТТ	|Превышение скорости(от 20 до 40)	|500.00	    |2020-01-23	|2020-02-23|
|4	|Яковлев Г.Р.	|М701АА	|Превышение скорости(от 20 до 40)	|           |2020-01-12 |	         | 
|5	|Колесов С.П.	|К892АХ	|Превышение скорости(от 20 до 40)	|         	|2020-02-01 |	         | 
|6	|Баранов П.Е.	|Р523ВТ	|Превышение скорости(от 40 до 60)	|           |2020-02-14 |	         |  
|7	|Абрамова К.А.|О111АВ	|Проезд на запрещающий сигнал	 	  |           |2020-02-23 |	         | 	 
|8	|Яковлев Г.Р.	|Т330ТТ	|Проезд на запрещающий сигнал	 	  |         	|2020-03-03 |	         |  

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO fine (
  name, number_plate, violation, sum_fine, 
  date_violation, date_payment
) 
VALUES 
  (
    "Баранов П.Е.", "Р523ВТ", 
    "Превышение скорости(от 40 до 60)", 
    NULL, "2020-02-14", NULL
  ), 
  (
    "Абрамова К.А.", "О111АВ", 
    "Проезд на запрещающий сигнал", 
    NULL, "2020-02-23", NULL
  ), 
  (
    "Яковлев Г.Р.", "Т330ТТ", 
    "Проезд на запрещающий сигнал", 
    NULL, "2020-03-03", NULL
  );
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | number_plate | violation                        | sum_fine | date_violation   | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12       | 2020-01-17   |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14       | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23       | 2020-02-23   |
| Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | NULL     | 2020-01-12       | NULL         |
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | NULL     | 2020-02-01       | NULL         |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | NULL     | 2020-02-14       | NULL         |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | NULL     | 2020-02-23       | NULL         |
| Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | NULL     | 2020-03-03       | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Использование временного имени таблицы (алиаса)

❓*Задание. Занести в таблицу fine суммы штрафов, которые должен оплатить водитель, в соответствии с данными из таблицы traffic_violation. При этом суммы заносить только в пустые поля столбца  sum_fine.
Таблица traffic_violationсоздана и заполнена.*

Структура и наполнение исходной таблицы fine (без ключевого столбца) и таблицыtraffic_violation:

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment | 
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | NULL     | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | NULL     | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | NULL     | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| NULL     | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| NULL     | 2020-03-03     | NULL         |

| violation_id | violation                        | sum_fine |
|:---------------:|:---------------:|:---------------:|
| 1            | Превышение скорости(от 20 до 40) | 500.00   |
| 2            | Превышение скорости(от 40 до 60) | 1000.00  |
| 3            | Проезд на запрещающий сигнал     | 1000.00  |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  fine AS f, 
  traffic_violation AS tv 
SET 
  f.sum_fine = tv.sum_fine 
WHERE 
  f.sum_fine IS NULL 
  AND f.violation = tv.violation;
SELECT 
  * 
FROM 
  fine;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 1000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Группировка данных по нескольким столбцам

❓*Задание. Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило   два и более раз. При этом учитывать все нарушения, независимо от того оплачены они или нет. Информацию отсортировать в алфавитном порядке, сначала по фамилии водителя, потом по номеру машины и, наконец, по нарушению.*

Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  number_plate, 
  violation 
FROM 
  fine 
GROUP BY 
  name, 
  number_plate, 
  violation 
HAVING 
  COUNT(violation) > 1 
ORDER BY 
  1, 
  2, 
  3;
SELECT 
  * 
FROM 
  fine;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 1000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. В таблице fine увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей.*

Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  fine, 
  (
    SELECT 
      name, 
      number_plate, 
      violation 
    FROM 
      fine 
    GROUP BY 
      name, 
      number_plate, 
      violation 
    HAVING 
      COUNT(violation) > 1 
    ORDER BY 
      1, 
      2, 
      3
  ) AS query_in 
SET 
  fine.sum_fine = sum_fine * 2 
WHERE 
  date_payment IS NULL 
  AND fine.name = query_in.name 
  AND fine.number_plate = query_in.number_plate 
  AND fine.violation = query_in.violation;
SELECT 
  * 
FROM 
  fine;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Водители оплачивают свои штрафы. В таблице payment занесены даты их оплаты:*

|payment_id	|name	|number_plate	|violation	|date_violation	|date_payment|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|1	|Яковлев Г.Р.	|М701АА	|Превышение скорости(от 20 до 40)	|2020-01-12	|2020-01-22|
|2	|Баранов П.Е.	|Р523ВТ	|Превышение скорости(от 40 до 60)	|2020-02-14	|2020-03-06|
|3	|Яковлев Г.Р.	|Т330ТТ	|Проезд на запрещающий сигнал	|2020-03-03	|2020-03-23|

*Необходимо:*
*в таблицу fine занести дату оплаты соответствующего штрафа из таблицы payment;* 
*уменьшить начисленный штраф в таблице fine в два раза  (только для тех штрафов, информация о которых занесена в таблицу payment) , если оплата произведена не позднее 20 дней со дня нарушения.*

Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  fine AS f, 
  payment AS p 
SET 
  f.date_payment = p.date_payment, 
  f.sum_fine = IF (
    DATEDIFF(
      p.date_payment, p.date_violation
    ) <= 20, 
    f.sum_fine / 2, 
    f.sum_fine
  ) 
WHERE 
  f.name = p.name 
  AND f.number_plate = p.number_plate 
  AND f.violation = p.violation 
  AND f.date_violation = p.date_violation 
  AND f.date_payment IS NULL;
SELECT 
  * 
FROM 
  fine;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 250.00   | 2020-01-12     | 2020-01-22   |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | 2020-03-06   |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03     | 2020-03-23   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Создать новую таблицу back_payment, куда внести информацию о неоплаченных штрафах (Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа  и  дату нарушения) из таблицы fine.*

Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 250.00   | 2020-01-12     | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE back_payment AS 
SELECT 
  name, 
  number_plate, 
  violation, 
  sum_fine, 
  date_violation 
FROM 
  fine 
WHERE 
  date_payment IS NULL;
SELECT 
  * 
FROM 
  back_payment;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | number_plate | violation                        | sum_fine | date_violation |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Удалить из таблицы fine информацию о нарушениях, совершенных раньше 1 февраля 2020 года.*

Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 250.00   | 2020-01-12     | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  fine 
WHERE 
  date_violation < "2020-02-01";
SELECT 
  * 
FROM 
  fine;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | 2020-03-05   |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03     | 2020-03-22   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

## 2. Запросы SQL к связанным таблицам

### 2.1 Связи между таблицами

✳ Шаг 6. 

❓*Задание. Создать таблицу author следующей структуры:*

|Поле	|Тип, описание|
|:---------------:|:---------------:|
|author_id	|INT PRIMARY KEY AUTO_INCREMENT|
|name_author	|VARCHAR(50)|

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE author(
  author_id INT PRIMARY KEY AUTO_INCREMENT, 
  name_author VARCHAR(50)
);
```
🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Заполнить таблицу author. В нее включить следующих авторов:
-Булгаков М.А.
-Достоевский Ф.М.
-Есенин С.А.
-Пастернак Б.Л.*

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO author (name_author) 
VALUES 
  ("Булгаков М.А."), 
  (
    "Достоевский Ф.М."
  ), 
  ("Есенин С.А."), 
  ("Пастернак Б.Л.");
SELECT 
  * 
FROM 
  author;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Создание таблицы с внешними ключами

❓*Задание. Перепишите запрос на создание таблицы book , чтобы ее структура соответствовала структуре, показанной на логической схеме (таблица genre уже создана, порядок следования столбцов - как на логической схеме в таблице book, genre_id  - внешний ключ) . Для genre_id ограничение о недопустимости пустых значений не задавать. В качестве главной таблицы для описания поля  genre_idиспользовать таблицу genre следующей структуры:*

|Поле	|Тип, описание|
|:---------------:|:---------------:|
|genre_id	|INT PRIMARY KEY AUTO_INCREMENT|
|name_genre	|VARCHAR(30)|

*Логическая схема (нужно создать только таблицу book):*

![](https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE book (
  book_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author_id INT NOT NULL, 
  genre_id INT, 
  price DECIMAL(8, 2), 
  amount INT, 
  FOREIGN KEY (author_id) REFERENCES author (author_id), 
  FOREIGN KEY (genre_id) REFERENCES genre (genre_id)
);
```
🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Действия при удалении записи главной таблицы

❓*Задание. Создать таблицу book той же структуры, что и на предыдущем шаге. Будем считать, что при удалении автора из таблицы author, должны удаляться все записи о книгах из таблицы book, написанные этим автором. А при удалении жанра из таблицы genre для соответствующей записи book установить значение Null в столбце genre_id.*

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE book (
  book_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author_id INT NOT NULL, 
  genre_id INT, 
  price DECIMAL(8, 2), 
  amount INT, 
  FOREIGN KEY (author_id) REFERENCES author (author_id) ON DELETE CASCADE, 
  FOREIGN KEY (genre_id) REFERENCES genre (genre_id) ON DELETE 
  SET 
    NULL
);
```
🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. 

❓*Задание. Добавьте три последние записи (с ключевыми значениями 6, 7, 8) в таблицу book, первые 5 записей уже добавлены:*

|book_id	|title	|author_id	|genre_id	|price	|amount|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|1	|Мастер и Маргарита	|1	|1	|670.99	|3|
|2	|Белая гвардия	|1	|1	|540.50	|5|
|3	|Идиот	|2	|1	|460.00	|10|
|4	|Братья Карамазовы	|2	|1	|799.01	|3|
|5	|Игрок	|2	|1	|480.50	|10|
|6	|Стихотворения и поэмы	|3	|2	|650.00	|15|
|7	|Черный человек	|3	|2	|570.20	|6|
|8	|Лирика	|4	|2	|518.99	|2|

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book(
  title, author_id, genre_id, price, 
  amount
) 
VALUES 
  (
    "Стихотворения и поэмы", 
    3, 2, 650.00, 15
  ), 
  (
    "Черный человек", 3, 
    2, 570.20, 6
  ), 
  ("Лирика", 4, 2, 518.99, 2);
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 2.2 Запросы на выборку, соединение таблиц

✳ Шаг 2. Соединение INNER JOIN

❓*Задание. Вывести название, жанр и цену тех книг, количество которых больше 8, в отсортированном по убыванию цены виде.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  name_genre, 
  price 
FROM 
  book 
  INNER JOIN genre ON book.genre_id = genre.genre_id 
WHERE 
  book.amount > 8 
ORDER BY 
  3 DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | name_genre | price  |
|:---------------:|:---------------:|:---------------:|
| Стихотворения и поэмы | Поэзия     | 650.00 |
| Игрок                 | Роман      | 480.50 |
| Идиот                 | Роман      | 460.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Внешнее соединение LEFT и RIGHT OUTER JOIN

❓*Задание. Вывести все жанры, которые не представлены в книгах на складе.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_genre 
FROM 
  genre 
  LEFT JOIN book ON genre.genre_id = book.genre_id 
WHERE 
  book.genre_id IS NULL;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_genre  |
|:---------------:|
| Приключения |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Перекрестное соединение CROSS JOIN

❓*Задание. Есть список городов, хранящийся в таблице city:*

|city_id	|name_city|
|:---------------:|:---------------:|
|1	|Москва|
|2	|Санкт-Петербург|
|3	|Владивосток|

*Необходимо в каждом городе провести выставку книг каждого автора в течение 2020 года. Дату проведения выставки выбрать случайным образом. Создать запрос, который выведет город, автора и дату проведения выставки. Последний столбец назвать Дата. Информацию вывести, отсортировав сначала в алфавитном порядке по названиям городов, а потом по убыванию дат проведения выставок.*

*Структура таблицы:*

![Структура таблицы:](https://ucarecdn.com/4d2b7a6d-ef2f-4597-a12f-87b3af48494e/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица city:*

| city_id | name_city       |
|:---------------:|:---------------:|
| 1       | Москва          |
| 2       | Санкт-Петербург |
| 3       | Владивосток     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_city, 
  name_author, 
  (
    DATE_ADD(
      "2020-01-01", 
      INTERVAL FLOOR(
        RAND() * 365
      ) DAY
    )
  ) AS Дата 
FROM 
  author CROSS 
  JOIN city 
ORDER BY 
  1 ASC, 
  Дата DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_city       | name_author      | Дата       |
|:---------------:|:---------------:|:---------------:|
| Владивосток     | Есенин С.А.      | 2020-11-29 |
| Владивосток     | Лермонтов М.Ю.   | 2020-09-28 |
| Владивосток     | Достоевский Ф.М. | 2020-06-11 |
| Владивосток     | Булгаков М.А.    | 2020-03-18 |
| Владивосток     | Пастернак Б.Л.   | 2020-02-08 |
| Москва          | Достоевский Ф.М. | 2020-12-07 |
| Москва          | Лермонтов М.Ю.   | 2020-07-11 |
| Москва          | Булгаков М.А.    | 2020-04-28 |
| Москва          | Пастернак Б.Л.   | 2020-02-14 |
| Москва          | Есенин С.А.      | 2020-01-30 |
| Санкт-Петербург | Есенин С.А.      | 2020-10-06 |
| Санкт-Петербург | Булгаков М.А.    | 2020-05-23 |
| Санкт-Петербург | Лермонтов М.Ю.   | 2020-05-08 |
| Санкт-Петербург | Пастернак Б.Л.   | 2020-04-14 |
| Санкт-Петербург | Достоевский Ф.М. | 2020-04-02 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Запросы на выборку из нескольких таблиц

❓*Задание. Вывести информацию о книгах (жанр, книга, автор), относящихся к жанру, включающему слово «роман» в отсортированном по названиям книг виде.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |


✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_genre, 
  title, 
  name_author 
FROM 
  book 
  JOIN genre ON book.genre_id = genre.genre_id 
  JOIN author ON book.author_id = author.author_id 
WHERE 
  name_genre = "Роман" 
ORDER BY 
  2;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_genre | title              | name_author      |
|:---------------:|:---------------:|:---------------:|
| Роман      | Белая гвардия      | Булгаков М.А.    |
| Роман      | Братья Карамазовы  | Достоевский Ф.М. |
| Роман      | Игрок              | Достоевский Ф.М. |
| Роман      | Идиот              | Достоевский Ф.М. |
| Роман      | Мастер и Маргарита | Булгаков М.А.    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Запросы для нескольких таблиц с группировкой

❓*Задание. Посчитать количество экземпляров  книг каждого автора из таблицы author.  Вывести тех авторов,  количество книг которых меньше 10, в отсортированном по возрастанию количества виде. Последний столбец назвать Количество.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |


✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_author, 
  SUM(amount) AS Количество 
FROM 
  author AS a 
  LEFT JOIN book AS b ON a.author_id = b.author_id 
GROUP BY 
  name_author 
HAVING 
  Количество < 10 
  OR Количество IS NULL 
ORDER BY 
  Количество ASC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_author    | Количество |
|:----------:|:---------------:|
| Лермонтов М.Ю. | NULL       |
| Пастернак Б.Л. | 2          |
| Булгаков М.А.  | 8          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Запросы для нескольких таблиц со вложенными запросами

❓*Задание. Вывести в алфавитном порядке всех авторов, которые пишут только в одном жанре. Поскольку у нас в таблицах так занесены данные, что у каждого автора книги только в одном жанре,  для этого запроса внесем изменения в таблицу book. Пусть у нас  книга Есенина «Черный человек» относится к жанру «Роман», а книга Булгакова «Белая гвардия» к «Приключениям» (эти изменения в таблицы уже внесены).*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 3        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 1        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_author 
FROM 
  author AS a 
  JOIN book AS b ON b.author_id = a.author_id 
  JOIN genre AS g ON g.genre_id = b.genre_id 
GROUP BY 
  name_author 
HAVING 
  COUNT(
    DISTINCT(name_genre)
  ) = 1;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_author      |
|:---------------:|
| Достоевский Ф.М. |
| Пастернак Б.Л.   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Вложенные запросы в операторах соединения

❓*Задание. Вывести информацию о книгах (название книги, фамилию и инициалы автора, название жанра, цену и количество экземпляров книги), написанных в самых популярных жанрах, в отсортированном в алфавитном порядке по названию книг виде. Самым популярным считать жанр, общее количество экземпляров книг которого на складе максимально.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

Структура и наполнение таблиц:
*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 4       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 5       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 6       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 7       | Лирика                | 4         | 2        | 518.99 | 10     |
| 8       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 9       | Герой нашего времени  | 5         | 3        | 570.59 | 2      |
| 10      | Доктор Живаго         | 4         | 3        | 740.50 | 5      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  name_author, 
  name_genre, 
  price, 
  amount 
FROM 
  book 
  JOIN genre ON book.genre_id = genre.genre_id 
  JOIN author ON book.author_id = author.author_id 
WHERE 
  book.genre_id IN(
    SELECT 
      query_in_2.genre_id 
    FROM 
      (
        SELECT 
          genre.genre_id, 
          SUM(amount) AS sum_amount 
        FROM 
          genre 
          JOIN book ON genre.genre_id = book.genre_id 
        GROUP BY 
          book.genre_id 
        ORDER BY 
          sum_amount DESC 
        LIMIT 
          1
      ) query_in_1 
      JOIN (
        SELECT 
          genre.genre_id, 
          SUM(amount) AS sum_amount 
        FROM 
          genre 
          JOIN book ON genre.genre_id = book.genre_id 
        GROUP BY 
          book.genre_id 
        ORDER BY 
          sum_amount DESC
      ) query_in_2 ON query_in_1.sum_amount = query_in_2.sum_amount
  ) 
ORDER BY 
  title;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | name_author      | name_genre | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Белая гвардия         | Булгаков М.А.    | Роман      | 540.50 | 5      |
| Братья Карамазовы     | Достоевский Ф.М. | Роман      | 799.01 | 3      |
| Игрок                 | Достоевский Ф.М. | Роман      | 480.50 | 10     |
| Идиот                 | Достоевский Ф.М. | Роман      | 460.00 | 10     |
| Лирика                | Пастернак Б.Л.   | Поэзия     | 518.99 | 10     |
| Мастер и Маргарита    | Булгаков М.А.    | Роман      | 670.99 | 3      |
| Стихотворения и поэмы | Есенин С.А.      | Поэзия     | 650.00 | 15     |
| Черный человек        | Есенин С.А.      | Поэзия     | 570.20 | 6      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Операция соединение, использование USING()

❓*Задание. Если в таблицах supply  и book есть одинаковые книги, которые имеют равную цену,  вывести их название и автора, а также посчитать общее количество экземпляров книг в таблицах supply и book,  столбцы назвать Название, Автор  и Количество.*

*Схема данных:*

![Схема данных:](https://ucarecdn.com/6de130b3-aac2-4216-82bb-7421c2a614ad/)

Структура и наполнение таблиц:
*Таблица supply:*

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго  | Пастернак Б.Л.   | 618.99 | 3      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Евгений Онегин | Пушкин А.С.      | 440.80 | 5      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title AS Название, 
  name_author AS Автор, 
  SUM(book.amount + supply.amount) AS Количество 
FROM 
  supply 
  INNER JOIN book USING(price, title) 
  INNER JOIN author ON author.name_author = supply.author 
GROUP BY 
  author.name_author, 
  book.title;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| Название       | Автор       | Количество |
|:---------------:|:---------------:|:---------------:|
| Черный человек | Есенин С.А. | 12         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 2.3 Запросы корректировки, соединение таблиц

*Структура и наполнение  таблиц*
*Концептуальная схема базы данных:*

![](https://ucarecdn.com/f95c8b49-0d5c-45e0-9e35-6261f7cbbbe8/)

*Логическая схема базы данных:*

![](https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/)

✳ Шаг 2. Запросы на обновление, связанные таблицы

❓*Задание. Для книг, которые уже есть на складе (в таблице book), но по другой цене, чем в поставке (supply),  необходимо в таблице book увеличить количество на значение, указанное в поставке,  и пересчитать цену. А в таблице  supply обнулить количество этих книг. Формула для пересчета цены:*  
*price = (p1∗k1 + p2∗k2) / (k1+k2)*  
*где  p1, p2 - цена книги в таблицах book и supply;*  
*k1, k2 - количество книг в таблицах book и supply.*

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
  JOIN author ON author.author_id = book.author_id 
  JOIN supply ON book.title = supply.title 
  AND supply.author = author.name_author 
SET 
  book.amount = book.amount + supply.amount, 
  book.price = (
    book.price * book.amount + supply.price * supply.amount
  ) / (book.amount + supply.amount), 
  supply.amount = 0 
WHERE 
  book.price <> supply.price;
SELECT 
  * 
FROM 
  book;
SELECT 
  * 
FROM 
  supply;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Запросы на добавление, связанные таблицы

❓*Задание. Включить новых авторов в таблицу author с помощью запроса на добавление, а затем вывести все данные из таблицы author.  Новыми считаются авторы, которые есть в таблице supply, но нет в таблице author.*  

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO author (name_author) 
SELECT 
  supply.author 
FROM 
  author 
  RIGHT JOIN supply ON author.name_author = supply.author 
WHERE 
  name_author IS NULL;
SELECT 
  * 
FROM 
  author;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Запрос на добавление, связанные таблицы

❓*Задание. Добавить новые книги из таблицы supply в таблицу book на основе сформированного выше запроса. Затем вывести для просмотра таблицу book.*  

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 0      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 0      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book(title, author_id, price, amount) 
SELECT 
  title, 
  author_id, 
  price, 
  amount 
FROM 
  author 
  INNER JOIN supply ON author.name_author = supply.author 
WHERE 
  amount <> 0;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | NULL     | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | NULL     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | NULL     | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Запрос на обновление, вложенные запросы

❓*Задание. Занести для книги «Стихотворения и поэмы» Лермонтова жанр «Поэзия», а для книги «Остров сокровищ» Стивенсона - «Приключения». (Использовать два запроса).*  

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | Null     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | Null     | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
SET 
  genre_id = (
    SELECT 
      genre_id 
    FROM 
      genre 
    WHERE 
      name_genre = "Поэзия"
  ) 
WHERE 
  book.title = "Стихотворения и поэмы";
UPDATE 
  book 
SET 
  genre_id = (
    SELECT 
      genre_id 
    FROM 
      genre 
    WHERE 
      name_genre = "Приключения"
  ) 
WHERE 
  book.title = "Остров сокровищ";
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Каскадное удаление записей связанных таблиц

❓*Задание. Удалить всех авторов и все их книги, общее количество книг которых меньше 20.*  

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  author 
WHERE 
  author_id IN (
    SELECT 
      author_id 
    FROM 
      book 
    GROUP BY 
      author_id 
    HAVING 
      SUM(amount) < 20
  );
SELECT 
  * 
FROM 
  author;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Удаление записей главной таблицы с сохранением записей в зависимой

❓*Задание. Удалить все жанры, к которым относится меньше 4-х книг. В таблице book для этих жанров установить значение Null.*  

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  genre 
WHERE 
  genre_id IN (
    SELECT 
      genre_id 
    FROM 
      book 
    GROUP BY 
      genre_id 
    HAVING 
      COUNT(title) < 4
  );
SELECT 
  * 
FROM 
  genre;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| genre_id | name_genre |
|:---------------:|:---------------:|
| 1        | Роман      |
| 2        | Поэзия     |

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | NULL     | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Удаление записей, использование связанных таблиц

❓*Задание. Удалить всех авторов, которые пишут в жанре "Поэзия". Из таблицы book удалить все книги этих авторов. В запросе для отбора авторов использовать полное название жанра, а не его id.*  

Структура и наполнение таблиц:
*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  author USING author 
  INNER JOIN book ON author.author_id = book.author_id 
  INNER JOIN genre ON genre.genre_id = book.genre_id 
WHERE 
  name_genre = 'Поэзия';
SELECT 
  * 
FROM 
  author;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 6         | Стивенсон Р.Л.   |

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия      | 1         | 1        | 540.50 | 12     |
| 3       | Идиот              | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы  | 2         | 1        | 799.01 | 3      |
| 5       | Игрок              | 2         | 1        | 480.50 | 10     |
| 11      | Остров сокровищ    | 6         | 3        | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 2.4 База данных «Интернет-магазин книг», запросы на выборку

В интернет-магазине продаются книги. Каждая книга имеет название, написана одним автором, относится к одному жанру, имеет определенную цену. В магазине в наличии есть несколько экземпляров каждой книги.   
Покупатель регистрируется на сайте интернет-магазина, задает свое имя и фамилию, электронную почту и город проживания. Он может сформировать один или несколько заказов, для каждого заказа написать какие-то пожелания. Каждый заказ включает одну или несколько книг, каждую книгу можно заказать в нескольких экземплярах. Затем заказ проходит ряд последовательных этапов (операций): оплачивается, упаковывается, передается курьеру или транспортной компании для транспортировки и, наконец, доставляется покупателю. Фиксируется дата каждой операции. Для каждого города известно среднее время доставки книг.  
При этом в магазине ведется учет книг, при покупке их количество уменьшается, при поступлении товара увеличивается, при исчерпании количества – оформляется заказ и пр.  
В данном уроке сначала будет построена концептуальная модель базы данных, затем ее логическая модель. Также будут определены структура и содержание таблиц базы данных «Интернет-магазин книг».

Логическая схема базы данных:

![](https://ucarecdn.com/bbf07d33-64e8-4391-8cde-4fcb75d4cec1/)

Логическая модель базы данных:

![](https://ucarecdn.com/bad26356-5e34-4945-a9d4-0748686a6b54/)

Наполнение таблиц:

![](https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/)

✳ Шаг 5. Запросы на основе трех и более связанных таблиц

❓*Задание. Вывести все заказы Баранова Павла (id заказа, какие книги, по какой цене и в каком количестве он заказал) в отсортированном по номеру заказа и названиям книг виде.* 

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy.buy_id, 
  book.title, 
  book.price, 
  buy_book.amount 
FROM 
  client 
  INNER JOIN buy ON client.client_id = buy.client_id 
  INNER JOIN buy_book ON buy.buy_id = buy_book.buy_id 
  INNER JOIN book ON buy_book.book_id = book.book_id 
WHERE 
  name_client = "Баранов Павел" 
ORDER BY 
  buy_id, 
  title;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | title              | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1      | Идиот              | 460.00 | 1      |
| 1      | Мастер и Маргарита | 670.99 | 1      |
| 1      | Черный человек     | 570.20 | 2      |
| 4      | Игрок              | 480.50 | 1      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Посчитать, сколько раз была заказана каждая книга, для книги вывести ее автора (нужно посчитать, в каком количестве заказов фигурирует каждая книга).  Вывести фамилию и инициалы автора, название книги, последний столбец назвать Количество. Результат отсортировать сначала  по фамилиям авторов, а потом по названиям книг.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/c9356f96-1b19-42ce-8c9e-e7a8169734fc/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_author, 
  title, 
  COUNT(buy_book.amount) AS Количество 
FROM 
  author 
  INNER JOIN book USING(author_id) 
  LEFT JOIN buy_book USING(book_id) 
GROUP BY 
  book.title, 
  name_author 
ORDER BY 
  name_author, 
  title;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_author      | title                 | Количество |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Белая гвардия         | 1          |
| Булгаков М.А.    | Мастер и Маргарита    | 2          |
| Достоевский Ф.М. | Братья Карамазовы     | 0          |
| Достоевский Ф.М. | Игрок                 | 1          |
| Достоевский Ф.М. | Идиот                 | 2          |
| Есенин С.А.      | Стихотворения и поэмы | 0          |
| Есенин С.А.      | Черный человек        | 1          |
| Пастернак Б.Л.   | Лирика                | 1          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Вывести города, в которых живут клиенты, оформлявшие заказы в интернет-магазине. Указать количество заказов в каждый город, этот столбец назвать Количество. Информацию вывести по убыванию количества заказов, а затем в алфавитном порядке по названию городов.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/1e4836b9-6cf8-41bd-9f82-38b11c7882aa/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_city, 
  COUNT(buy_id) AS Количество 
FROM 
  city 
  INNER JOIN client ON city.city_id = client.city_id 
  INNER JOIN buy ON client.client_id = buy.client_id 
GROUP BY 
  name_city 
ORDER BY 
  2 DESC, 
  name_city;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_city       | Количество |
|:---------------:|:---------------:|
| Владивосток     | 2          |
| Москва          | 1          |
| Санкт-Петербург | 1          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Вывести номера всех оплаченных заказов и даты, когда они были оплачены.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/a6be5406-fcef-4a74-89bc-eb7833621092/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy_id, 
  date_step_end 
FROM 
  step 
  INNER JOIN buy_step ON step.step_id = buy_step.step_id 
WHERE 
  date_step_end IS NOT NULL 
  AND buy_step.step_id = 1;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | date_step_end |
|:---------------:|:---------------:|
| 1      | 2020-02-20    |
| 2      | 2020-02-28    |
| 3      | 2020-03-05    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Вывести информацию о каждом заказе: его номер, кто его сформировал (фамилия пользователя) и его стоимость (сумма произведений количества заказанных книг и их цены), в отсортированном по номеру заказа виде. Последний столбец назвать Стоимость.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/cce071e8-3a35-4642-8fff-460f0899e4eb/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy.buy_id, 
  name_client, 
  SUM(buy_book.amount * book.price) AS Стоимость 
FROM 
  buy_book 
  INNER JOIN book ON book.book_id = buy_book.book_id 
  INNER JOIN buy ON buy.buy_id = buy_book.buy_id 
  INNER JOIN client ON client.client_id = buy.client_id 
GROUP BY 
  buy_id 
ORDER BY 
  buy_id;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | name_client    | Стоимость |
|:---------------:|:---------------:|:---------------:|
| 1      | Баранов Павел  | 2271.39   |
| 2      | Семенонов Иван | 1037.98   |
| 3      | Абрамова Катя  | 2131.49   |
| 4      | Баранов Павел  | 480.50    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. 

❓*Задание. Вывести номера заказов (buy_id) и названия этапов,  на которых они в данный момент находятся. Если заказ доставлен –  информацию о нем не выводить. Информацию отсортировать по возрастанию buy_id.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/0178ea29-ab37-4ce9-83ac-bd49d2636c20/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy_id, 
  name_step 
FROM 
  buy_step 
  INNER JOIN step ON buy_step.step_id = step.step_id 
WHERE 
  date_step_beg IS NOT NULL 
  AND date_step_end IS NULL 
ORDER BY 
  buy_id, 
  name_step;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | name_step       |
|:---------------:|:---------------:|
| 2      | Транспортировка |
| 3      | Доставка        |
| 4      | Оплата          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. 

❓*Задание. В таблице city для каждого города указано количество дней, за которые заказ может быть доставлен в этот город (рассматривается только этап Транспортировка). Для тех заказов, которые прошли этап транспортировки, вывести количество дней за которое заказ реально доставлен в город. А также, если заказ доставлен с опозданием, указать количество дней задержки, в противном случае вывести 0. В результат включить номер заказа (buy_id), а также вычисляемые столбцы Количество_дней и Опоздание. Информацию вывести в отсортированном по номеру заказа виде.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/6b3c2d87-7353-48e6-adfd-26c338886f4a/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy_step.buy_id, 
  DATEDIFF(date_step_end, date_step_beg) AS Количество_дней, 
  IF(
    DATEDIFF(date_step_end, date_step_beg) > city.days_delivery, 
    DATEDIFF(date_step_end, date_step_beg) - city.days_delivery, 
    0
  ) AS Опоздание 
FROM 
  buy_step 
  INNER JOIN step ON buy_step.step_id = step.step_id 
  INNER JOIN buy ON buy_step.buy_id = buy.buy_id 
  INNER JOIN client ON buy.client_id = client.client_id 
  INNER JOIN city ON client.city_id = city.city_id 
WHERE 
  buy_step.step_id = 3 
  AND date_step_end IS NOT NULL 
ORDER BY 
  buy_id;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | Количество_дней | Опоздание |
|:---------------:|:---------------:|:---------------:|
| 1      | 14              | 2         |
| 3      | 4               | 0         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 12. 

❓*Задание. Выбрать всех клиентов, которые заказывали книги Достоевского, информацию вывести в отсортированном по алфавиту виде. В решении используйте фамилию автора, а не его id.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/81b4c54e-bfb0-4582-9df9-279b6be0154e/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  DISTINCT name_client 
FROM 
  client 
  INNER JOIN buy USING(client_id) 
  INNER JOIN buy_book USING(buy_id) 
  INNER JOIN book USING(book_id) 
  INNER JOIN author USING(author_id) 
WHERE 
  author.name_author = 'Достоевский Ф.М.' 
ORDER BY 
  name_client;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_client   |
|:---------------:|
| Абрамова Катя |
| Баранов Павел |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 13. 

❓*Задание. Вывести жанр (или жанры), в котором было заказано больше всего экземпляров книг, указать это количество. Последний столбец назвать Количество.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/710494ce-e3a3-4d4b-8f10-5ab41b474b31/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_genre, 
  SUM(buy_book.amount) AS Количество 
FROM 
  genre 
  INNER JOIN book USING(genre_id) 
  INNER JOIN buy_book USING(book_id) 
GROUP BY 
  1 
HAVING 
  Количество = (
    SELECT 
      MAX(sum_amount) AS max_sum_amount 
    FROM 
      (
        SELECT 
          name_genre, 
          SUM(buy_book.amount) AS sum_amount 
        FROM 
          genre 
          INNER JOIN book ON genre.genre_id = book.genre_id 
          INNER JOIN buy_book ON book.book_id = buy_book.book_id 
        GROUP BY 
          name_genre
      ) AS query_in
  );
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_genre | Количество |
|:---------------:|:---------------:|
| Роман      | 7          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 14. 

❓*Задание. Сравнить ежемесячную выручку от продажи книг за текущий и предыдущий годы. Для этого вывести год, месяц, сумму выручки в отсортированном сначала по возрастанию месяцев, затем по возрастанию лет виде. Название столбцов: Год, Месяц, Сумма.* 

*Фрагмент логической схемы базы данных (в запросе НЕ ОБЯЗАТЕЛЬНО использовать все таблицы):*

![](https://ucarecdn.com/843369b4-8065-4023-99bf-60a08aaafa34/)

*Информация о продажах предыдущего года хранится в архивной таблице buy_archive, которая создается в конце года на основе информации из таблиц базы данных и имеет следующую структуру:*

|Название столбца	|Описание|
|buy_archive_id		|ключевой столбец|
|buy_id	id		|заказов, выбирается из таблицы buy|
|client_id		|id клиентов, выбирается из из таблицы client|
|book_id		|id книги, выбирается из таблицы book|
|date_payment		|дата оплаты заказа, выбирается из столбца date_step_end|
|таблицы buy_step 	|этапа «Оплата» соответствующего заказа|
|price			|цена книги в текущем заказе из таблицы book (хранится, так как цена может измениться)|
|amount			|количество купленных книг в текущем заказе, из таблицы buy_book|

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  YEAR(date_payment) AS Год, 
  MONTHNAME(date_payment) AS Месяц, 
  SUM(price * amount) AS Сумма 
FROM 
  buy_archive 
GROUP BY 
  1, 
  2 
UNION ALL 
SELECT 
  YEAR(date_step_end) AS Год, 
  MONTHNAME(date_step_end) AS Месяц, 
  SUM(price * buy_book.amount) AS Сумма 
FROM 
  buy_step 
  INNER JOIN buy_book USING(buy_id) 
  INNER JOIN book USING(book_id) 
WHERE 
  date_step_end IS NOT NULL 
  AND step_id = 1 
GROUP BY 
  1, 
  2 
ORDER BY 
  2 ASC, 
  1 ASC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| Год  | Месяц    | Сумма   |
|:---------------:|:---------------:|:---------------:|
| 2019 | February | 5626.30 |
| 2020 | February | 3309.37 |
| 2019 | March    | 6857.50 |
| 2020 | March    | 2131.49 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 15. 

❓*Задание. Для каждой отдельной книги необходимо вывести информацию о количестве проданных экземпляров и их стоимости за 2020 и 2019 год . Вычисляемые столбцы назвать Количество и Сумма. Информацию отсортировать по убыванию стоимости.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/d5c5d16e-32eb-4caa-8fc8-6982cda2ac32/)

*Информация о продажах прошлого года хранится в таблице buy_archive следующей структуры:*

![](https://ucarecdn.com/bd089cc7-acb0-442e-a276-4995f7ade4b1/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  SUM(Количество) AS Количество, 
  SUM(Сумма) AS Сумма 
FROM 
  (
    SELECT 
      book.title, 
      SUM(buy_book.amount) AS Количество, 
      SUM(book.price * buy_book.amount) AS Сумма 
    FROM 
      book 
      INNER JOIN buy_book USING(book_id) 
      INNER JOIN buy ON buy_book.buy_id = buy.buy_id 
      INNER JOIN buy_step ON buy_step.buy_id = buy.buy_id 
      INNER JOIN step ON buy_step.step_id = step.step_id 
    WHERE 
      step.name_step = 'Оплата' 
      AND buy_step.date_step_end IS NOT NULL 
    GROUP BY 
      1 
    UNION ALL 
    SELECT 
      book.title, 
      SUM(buy_archive.amount) AS Количество, 
      SUM(
        buy_archive.price * buy_archive.amount
      ) AS Сумма 
    FROM 
      buy_archive 
      INNER JOIN book USING(book_id) 
    GROUP BY 
      1
  ) AS query_in 
GROUP BY 
  title 
ORDER BY 
  Сумма DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | Количество | Сумма   |
|:---------------:|:---------------:|:---------------:|
| Братья Карамазовы     | 8          | 6247.20 |
| Мастер и Маргарита    | 6          | 4024.38 |
| Идиот                 | 5          | 2281.80 |
| Белая гвардия         | 3          | 1581.10 |
| Черный человек        | 2          | 1140.40 |
| Лирика                | 2          | 1037.98 |
| Игрок                 | 2          | 961.80  |
| Стихотворения и поэмы | 1          | 650.00  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### 2.5 База данных «Интернет-магазин книг», запросы корректировки

✳ Шаг 2. 

❓*Задание. Включить нового человека в таблицу с клиентами. Его имя Попов Илья, его email popov@test, проживает он в Москве.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/2d95c7c4-3164-4d35-b195-6dea9308e5ae/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO client (name_client, city_id, email) 
SELECT 
  'Попов Илья', 
  city_id, 
  'popov@test' 
FROM 
  city 
WHERE 
  name_city = 'Москва';
SELECT 
  * 
FROM 
  client;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| client_id | name_client     | city_id | email          |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Баранов Павел   | 3       | baranov@test   |
| 2         | Абрамова Катя   | 1       | abramova@test  |
| 3         | Семенонов Иван  | 2       | semenov@test   |
| 4         | Яковлева Галина | 1       | yakovleva@test |
| 5         | Попов Илья      | 1       | popov@test     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Создать новый заказ для Попова Ильи. Его комментарий для заказа: «Связаться со мной по вопросу доставки».* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/410c7a2e-696d-4865-b9b6-a176350d5cbd/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO buy(buy_description, client_id) 
SELECT 
  'Связаться со мной по вопросу доставки', 
  client_id 
FROM 
  client 
WHERE 
  name_client = 'Попов Илья';
SELECT 
  * 
FROM 
  buy;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | buy_description                       | client_id |
|:---------------:|:---------------:|:---------------:|
| 1      | Доставка только вечером               | 1         |
| 2      | NULL                                  | 3         |
| 3      | Упаковать каждую книгу по отдельности | 2         |
| 4      | NULL                                  | 1         |
| 5      | Связаться со мной по вопросу доставки | 5         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. В таблицу buy_book добавить заказ с номером 5. Этот заказ должен содержать книгу Пастернака «Лирика» в количестве двух экземпляров и книгу Булгакова «Белая гвардия» в одном экземпляре.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/b6bd319d-0d03-4b9a-86a2-98ac762fa4dc/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO buy_book(buy_id, book_id, amount) 
SELECT 
  5, 
  book_id, 
  2 
FROM 
  book 
  INNER JOIN author USING(author_id) 
WHERE 
  author.name_author LIKE 'Пастернак%' 
  AND book.title LIKE 'Лирика%' 
UNION 
SELECT 
  5, 
  book_id, 
  1 
FROM 
  book 
  INNER JOIN author USING(author_id) 
WHERE 
  author.name_author LIKE 'Булгаков%' 
  AND book.title LIKE 'Белая гвардия%';
SELECT 
  * 
FROM 
  buy_book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_book_id | buy_id | book_id | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 1      |
| 2           | 1      | 7       | 2      |
| 3           | 1      | 3       | 1      |
| 4           | 2      | 8       | 2      |
| 5           | 3      | 3       | 2      |
| 6           | 3      | 2       | 1      |
| 7           | 3      | 1       | 1      |
| 8           | 4      | 5       | 1      |
| 9           | 5      | 8       | 2      |
| 10          | 5      | 2       | 1      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. 

❓*Задание. Количество тех книг на складе, которые были включены в заказ с номером 5, уменьшить на то количество, которое в заказе с номером 5  указано.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/96d439bc-b2d4-4850-9762-ade76851aa9e/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
  INNER JOIN buy_book USING(book_id) 
SET 
  book.amount = book.amount - buy_book.amount 
WHERE 
  buy_book.buy_id = 5 
  AND book.book_id = buy_book.book_id;
SELECT 
  * 
FROM 
  book;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 4      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 0      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Создать счет (таблицу buy_pay) на оплату заказа с номером 5, в который включить название книг, их автора, цену, количество заказанных книг и  стоимость. Последний столбец назвать Стоимость. Информацию в таблицу занести в отсортированном по названиям книг виде.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/cf0254ce-b399-4abd-afa4-29c3613272b0/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE buy_pay AS 
SELECT 
  title, 
  name_author, 
  price, 
  buy_book.amount, 
  book.price * buy_book.amount AS Стоимость 
FROM 
  buy_book 
  JOIN book USING(book_id) 
  JOIN author USING(author_id) 
WHERE 
  buy_book.buy_id = 5 
ORDER BY 
  book.title;
SELECT 
  * 
FROM 
  buy_pay;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| title         | name_author    | price  | amount | Стоимость |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Белая гвардия | Булгаков М.А.  | 540.50 | 1      | 540.50    |
| Лирика        | Пастернак Б.Л. | 518.99 | 2      | 1037.98   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Создать общий счет (таблицу buy_pay) на оплату заказа с номером 5. Куда включить номер заказа, количество книг в заказе (название столбца Количество) и его общую стоимость (название столбца Итого). Для решения используйте ОДИН запрос.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/44e123c6-e706-43d9-8f5e-e54c3e35338f/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE buy_pay AS 
SELECT 
  buy_id, 
  SUM(buy_book.amount) AS Количество, 
  SUM(book.price * buy_book.amount) AS Итого 
FROM 
  buy_book 
  JOIN book USING(book_id) 
  JOIN author USING(author_id) 
WHERE 
  buy_book.buy_id = 5;
SELECT 
  * 
FROM 
  buy_pay;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | Количество | Итого   |
|:---------------:|:---------------:|:---------------:|
| 5      | 3          | 1578.48 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. В таблицу buy_step для заказа с номером 5 включить все этапы из таблицы step, которые должен пройти этот заказ. В столбцы date_step_beg и date_step_end всех записей занести Null.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/b104b25f-4a80-4b07-ab1a-f73c25dc3e0b/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO buy_step(buy_id, step_id) 
SELECT 
  buy_id, 
  step_id 
FROM 
  step CROSS 
  JOIN buy 
WHERE 
  buy_id = 5;
SELECT 
  * 
FROM 
  buy_step;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | NULL          | NULL          |
| 18          | 5      | 2       | NULL          | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. В таблицу buy_step занести дату 12.04.2020 выставления счета на оплату заказа с номером 5.  
Правильнее было бы занести не конкретную, а текущую дату. Это можно сделать с помощью функции Now(). Но при этом в разные дни будут вставляться разная дата, и задание нельзя будет проверить, поэтому  вставим дату 12.04.2020.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/82bcc6a0-9bef-4202-acdf-fed95bdeab67/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  buy_step 
  JOIN step USING(step_id) 
SET 
  date_step_beg = '2020-04-12' 
WHERE 
  buy_step.buy_id = 5 
  AND name_step = 'Оплата';
SELECT 
  * 
FROM 
  buy_step;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | 2020-04-12    | NULL          |
| 18          | 5      | 2       | NULL          | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. 

❓*Задание. Завершить этап «Оплата» для заказа с номером 5, вставив в столбец date_step_end дату 13.04.2020, и начать следующий этап («Упаковка»), задав в столбце date_step_beg для этого этапа ту же дату.  
Реализовать два запроса для завершения этапа и начала следующего. Они должны быть записаны в общем виде, чтобы его можно было применять для любых этапов, изменив только текущий этап. Для примера пусть это будет этап «Оплата».* 

*Фрагмент предметной области:*

![](https://ucarecdn.com/38630f8f-d5ae-4284-8133-bee549683afc/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  buy_step 
  JOIN step USING(step_id) 
SET 
  date_step_end = '2020-04-13' 
WHERE 
  buy_step.buy_id = 5 
  AND name_step = 'Оплата';
UPDATE 
  buy_step 
SET 
  date_step_beg = '2020-04-13' 
WHERE 
  buy_id = 5 
  AND step_id = (
    SELECT 
      step_id + 1 
    FROM 
      step 
    WHERE 
      name_step = 'Оплата'
  );
SELECT 
  * 
FROM 
  buy_step;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

|buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | 2020-04-12    | 2020-04-13    |
| 18          | 5      | 2       | 2020-04-13    | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

## Базы данных и SQL запросы

### 3.1 База данных «Тестирование», запросы на выборку

В университете реализуется on-line тестирование по нескольким дисциплинам. Каждая дисциплина включает некоторое количество вопросов. Ответы на вопрос представлены в виде вариантов ответов, один из этих вариантов правильный.  
Студент регистрируется в системе, указав свое имя, фамилию и отчество. После этого он может проходить тестирование по одной или нескольким дисциплинам. Студент имеет несколько попыток для прохождения тестирования  (необходимо сохранять дату попытки). Каждому студенту случайным образом выбирается набор вопросов по дисциплине и формируется индивидуальный тест. Студент отвечает на вопросы, выбирая один из предложенных вариантов ответа.  
После окончания тестирования  вычисляется и сохраняется результат (в процентах) попытки.

Концептуальная схема базы данных:

![](https://ucarecdn.com/c3a958bc-1805-4da5-b4b9-e77343f65024/)

Логическая схема базы данных:

![](https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/)

✳ Шаг 2. 

❓*Задание. Вывести студентов, которые сдавали дисциплину «Основы баз данных», указать дату попытки и результат. Информацию вывести по убыванию результатов тестирования.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/d46b4a8e-ef49-4335-815b-f3d685f63a13/)

*Наполнение таблиц attempt, student, subject:*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_student, 
  date_attempt, 
  result 
FROM 
  student 
  JOIN attempt USING(student_id) 
  JOIN subject USING(subject_id) 
WHERE 
  name_subject = 'Основы баз данных' 
ORDER BY 
  3 DESC;
```
🔎 `РЕЗУЛЬТАТ` ⤵️

| name_student    | date_attempt | result |
|:---------------:|:---------------:|:---------------:|
| Яковлева Галина | 2020-04-21   | 100    |
| Баранов Павел   | 2020-03-23   | 67     |
| Яковлева Галина | 2020-03-26   | 0      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉
