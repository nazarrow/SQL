[![N|Solid](https://upload.wikimedia.org/wikipedia/commons/4/42/Stepik_logotype.png)](https://stepik.org/)
# [Интерактивный тренажер по SQL](https://stepik.org/63054)
> Для форматирования использовал [codebeautify.org](https://codebeautify.org/sqlformatter#)

🔖 Подарок от авторов курса

*Поздравляем, большинство шагов курса Вы уже прошли!  
Чтобы Вам удобнее было ориентироваться по пройденному материалу - скачайте файл по [ссылке](https://stepik.org/media/attachments/course/63054/SQL.pdf)  
В нем собрана информация по всем шагам курса. Через оглавление документа можно быстро перейти к нужному шагу.*

Навигация:
1. Основы реляционной модели и SQL
+ [1.1 Отношение (таблица)](#One)
+ [1.2 Выборка данных](#OneTwo)
+ [1.3 Запросы, групповые операции](#OneThree)
+ [1.4 Вложенные запросы](#OneFour)
+ [1.5 Запросы корректировки данных](#OneFive)
+ [1.6 Таблица "Командировки", запросы на выборку](#OneSix)
+ [1.7 Таблица "Нарушения ПДД", запросы корректировки](#OneSeven)
2. Запросы SQL к связанным таблицам
+ [2.1 Связи между таблицами](#Two)
+ [2.2 Запросы на выборку, соединение таблиц](#TwoTwo)
+ [2.3 Запросы корректировки, соединение таблиц](#TwoThree)
+ [2.4 База данных «Интернет-магазин книг», запросы на выборку](#TwoFour)
+ [2.5 База данных «Интернет-магазин книг», запросы корректировки](#TwoFive)
3. Базы данных и SQL запросы
+ [3.1 База данных «Тестирование», запросы на выборку](#ThreeOne)
+ [3.2 База данных «Тестирование», запросы корректировки](#ThreeTwo)
+ [3.3 База данных «Абитуриент», запросы на выборку](#ThreeThree)
+ [3.4 База данных «Абитуриент», запросы корректировки](#ThreeFour)
+ [3.5 База данных "Учебная аналитика по курсу"](#ThreeFive)
4. SQL запросы пользователей
+ [4.1 База данных «Интернет-магазин книг», часть 1](#FourOne)
+ [4.2 База данных «Интернет-магазин книг», часть 2](#FourTwo)
+ [4.3 База данных «Интернет-магазин книг», часть 3](#FourThree)
+ [4.4 База данных «Тестирование»](#FourFour)
---
## 1. Основы реляционной модели и SQL

### <a name="One"></a> 1.1 Отношение (таблица)

✳ Шаг 4. Основные понятия реляционных баз данных

Основные принципы реляционных баз данных:

- все данные на концептуальном уровне представляются в виде объектов, заданных в виде строк и столбцов, называемых отношением, более распространенное название – таблица;
- в пересечение строки и столбца таблицы можно занести только одно значение;
- все операции выполняются над целыми отношениями и результатом этих операций является отношение.
 
Пример отношения: 

![](https://ucarecdn.com/5c077c69-ade0-401a-a9f0-d7efdd6c0ceb/)

На примере таблицы Сотрудник рассмотрим терминологию реляционных баз данных:

- отношение  – это структура данных целиком, набор записей (в обычном понимании – таблица) , в  примере –это Сотрудник;
- кортеж – это каждая строка , содержащая данные (более распространенный термин – запись ), например, <001, Борин С.А, 234-01-23, программист>, все кортежи в отношении должны быть различны;
- мощность – число кортежей в таблице (проще говоря, число записей), в данном случае 3, мощность отношения может быть любой (от 0 до бесконечности), порядок следования кортежей - неважен;
- атрибут – это столбец в таблице (более распространенный термин – поле ), в примере – Табельный номер, Фамилия И.О., Телефон, Должность) 
- размерность – это число атрибутов в таблице, в данном случае – 4;
- размерность отношения должна быть больше 0, порядок следования атрибутов существенен;
- домен атрибута – это допустимые значения (неповторяющиеся), которые можно занести в поле , например для атрибута Должность домен – {инженер, программист}.

❓*Задание. Для таблицы Сотрудник отметьте верные ячейки (В каждом столбце и строке - один правильный ответ).*

✔`РЕШЕНИЕ` ⤵️

|Ряды:	                             |Мощность	|Размерность	|Атрибут	|Кортеж	|Отношение	|Домен|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|002, Иванов И.И., 234-12-01, инженер| | | |✓| | |
|4	                             | |✓| | | | |
|{###-##-##}, где # - цифра от 0 до 9| | | | | |✓|	
|Сотрудник	                     | | | | |✓| |
|3	                             |✓| | | | | |
|Фамилия И.О.                        | | |✓ | | | |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Отношение, реляционная модель

❓*Задание. Отметьте ПРАВИЛЬНЫЕ имена, которые можно выбрать в качестве названий таблиц или полей.*

✔`РЕШЕНИЕ` ⤵️

✅name_book
☐book store
✅price_rub
☐price(rub)
✅store
☐name -author

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Выбор типов данных для полей 

❓*Задание. Сопоставьте значения и типы данных, с помощью которых их можно описать.*

✔`РЕШЕНИЕ` ⤵️

|VARCHAR(11) |DECIMAL(5, 2) |VARCHAR(5) |DECIMAL(7, 1) |INT |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|Слово, Предложение, Абзац|5.12, -0.99, 10.12|sql, mySql, data|56.1, 456.1, 3000|-34078, 55, 0|

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Создание таблицы 

❓*Задание. Сформулируйте SQL запрос для создания таблицы book. Структура таблицы book:*

|Поле|Тип, описание|
|:---------------:|:---------------:|
|book_id|INT PRIMARY KEY AUTO_INCREMENT|
|title|VARCHAR(50)|
|author|INT PRIMARY KEY AUTO_INCREMENT|
|price|DECIMAL(8, 2)|
|amount|INT|

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE book (
  book_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author VARCHAR(30), 
  price DECIMAL(8, 2), 
  amount INT
);
```

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Вставка записи в таблицу

❓*Задание. Занесите новую строку в таблицу book (текстовые значения (тип VARCHAR) заключать либо в двойные, либо в одинарные кавычки):*

| book_id | title              | author        | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| INT PRIMARY KEY AUTO_INCREMENT      | VARCHAR(50) | INT PRIMARY KEY AUTO_INCREMENT | DECIMAL(8, 2) | INT     |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    1, "Мастер и Маргарита", 
    "Булгаков М.А.", 670.99, 
    3
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title              | author        | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита | Булгаков М.А. | 670.99 | 3      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Занесите три последние записи в таблицу book,  первая запись уже добавлена на предыдущем шаге:*

| book_id | title              | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия      | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот              | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы  | Достоевский Ф.М. | 799.01 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    2, "Белая гвардия", "Булгаков М.А.", 
    540.50, 5
  );
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    3, "Идиот", "Достоевский Ф.М.", 
    460.00, 10
  );
INSERT INTO book (
  book_id, title, author, price, amount
) 
VALUES 
  (
    4, "Братья Карамазовы", 
    "Достоевский Ф.М.", 
    799.01, 2
  );
```

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="OneTwo"></a> 1.2 Выборка данных

✳ Шаг 2. Выборка всех данных из таблицы

❓*Задание. Вывести информацию о всех книгах, хранящихся на складе.
Для этого: 
Напишите SQL запрос в окне кода; 
Отправьте на проверку (кнопка  Отправить); 
Если запрос работает неверно, исправьте его и снова отправьте на проверку.*

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Выборка отдельных столбцов

❓*Задание. Выбрать авторов, название книг и их цену из таблицы book.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title                 | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита    | 670.99 |
| Булгаков М.А.    | Белая гвардия         | 540.50 |
| Достоевский Ф.М. | Идиот                 | 460.00 |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01 |
| Есенин С.А.      | Стихотворения и поэмы | 650.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Выборка новых столбцов и присвоение им новых имен

❓*Задание. Выбрать названия книг и авторов из таблицы book, для поля title задать имя(псевдоним) Название, для поля author –  Автор.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title AS Название, 
  author AS Автор 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Название              | Автор            |
|:---------------:|:---------------:|
| Мастер и Маргарита    | Булгаков М.А.    |
| Белая гвардия         | Булгаков М.А.    |
| Идиот                 | Достоевский Ф.М. |
| Братья Карамазовы     | Достоевский Ф.М. |
| Стихотворения и поэмы | Есенин С.А.      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Выборка данных с созданием вычисляемого столбца

❓*Задание. Для упаковки каждой книги требуется один лист бумаги, цена которого 1 рубль 65 копеек. Посчитать стоимость упаковки для каждой книги (сколько денег потребуется, чтобы упаковать все экземпляры книги). В запросе вывести название книги, ее количество и стоимость упаковки, последний столбец назвать pack.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  amount, 
  amount * 1.65 AS pack 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | amount | pack  |
|:---------------:|:---------------:|:---------------:|
| Мастер и Маргарита    | 3      | 4.95  |
| Белая гвардия         | 5      | 8.25  |
| Идиот                 | 10     | 16.50 |
| Братья Карамазовы     | 2      | 3.30  |
| Стихотворения и поэмы | 15     | 24.75 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Выборка данных, вычисляемые столбцы, математические функции

❓*Задание. В конце года цену всех книг на складе пересчитывают – снижают ее на 30%. Написать SQL запрос, который из таблицы book выбирает названия, авторов, количества и вычисляет новые цены книг. Столбец с новой ценой назвать new_price, цену округлить до 2-х знаков после запятой.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author, 
  amount, 
  ROUND (
    (price * 0.7), 
    2
  ) AS new_price 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | author           | amount | new_price |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 469.69    |
| Белая гвардия         | Булгаков М.А.    | 5      | 378.35    |
| Идиот                 | Достоевский Ф.М. | 10     | 322.00    |
| Братья Карамазовы     | Достоевский Ф.М. | 2      | 559.31    |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 455.00    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Выборка данных, вычисляемые столбцы, логические функции

❓*Задание. При анализе продаж книг выяснилось, что наибольшей популярностью пользуются книги Михаила Булгакова, на втором месте книги Сергея Есенина. Исходя из этого решили поднять цену книг Булгакова на 10%, а цену книг Есенина - на 5%. Написать запрос, куда включить автора, название книги и новую цену, последний столбец назвать new_price. Значение округлить до двух знаков после запятой.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  ROUND (
    IF (
      author = "Булгаков М.А.", 
      price * 1.1, 
      IF (
        author = "Есенин С.А.", price * 1.05, 
        price * 1
      )
    ), 
    2
  ) AS new_price 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title                 | new_price |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита    | 738.09    |
| Булгаков М.А.    | Белая гвардия         | 594.55    |
| Достоевский Ф.М. | Идиот                 | 460.00    |
| Достоевский Ф.М. | Братья Карамазовы     | 799.01    |
| Есенин С.А.      | Стихотворения и поэмы | 682.50    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Выборка данных по условию

❓*Задание. Вывести автора, название  и цены тех книг, количество которых меньше 10.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  amount < 10;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title              | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита | 670.99 |
| Булгаков М.А.    | Белая гвардия      | 540.50 |
| Достоевский Ф.М. | Братья Карамазовы  | 799.01 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Выборка данных, логические операции

❓*Задание. Вывести название, автора,  цену  и количество всех книг, цена которых меньше 500 или больше 600, а стоимость всех экземпляров этих книг больше или равна 5000.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author, 
  price, 
  amount 
FROM 
  book 
WHERE 
  (
    price < 500 
    OR price > 600
  ) 
  AND price * amount >= 5000;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | author      | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Стихотворения и поэмы | Есенин С.А. | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. Выборка данных, операторы BETWEEN, IN

❓*Задание. Вывести название и авторов тех книг, цены которых принадлежат интервалу от 540.50 до 800 (включая границы),  а количество или 2, или 3, или 5, или 7.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author 
FROM 
  book 
WHERE 
  price BETWEEN 540.50 
  AND 800 
  AND amount IN (2, 3, 5, 7);
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title              | author           |
|:---------------:|:---------------:|
| Мастер и Маргарита | Булгаков М.А.    |
| Белая гвардия      | Булгаков М.А.    |
| Братья Карамазовы  | Достоевский Ф.М. |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. Выборка данных с сортировкой

❓*Задание. Вывести  автора и название  книг, количество которых принадлежит интервалу от 2 до 14 (включая границы). Информацию  отсортировать сначала по авторам (в обратном алфавитном порядке), а затем по названиям книг (по алфавиту).*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title 
FROM 
  book 
WHERE 
  amount BETWEEN 2 
  AND 14 
ORDER BY 
  1 DESC, 
  2 ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title              |
|:---------------:|:---------------:|
| Достоевский Ф.М. | Братья Карамазовы  |
| Достоевский Ф.М. | Идиот              |
| Булгаков М.А.    | Белая гвардия      |
| Булгаков М.А.    | Мастер и Маргарита |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 12. Выборка данных, оператор LIKE

❓*Задание. Вывести название и автора тех книг, название которых состоит из двух и более слов, а инициалы автора содержат букву «С». Считать, что в названии слова отделяются друг от друга пробелами и не содержат знаков препинания, между фамилией автора и инициалами обязателен пробел, инициалы записываются без пробела в формате: буква, точка, буква, точка. Информацию отсортировать по названию книги в алфавитном порядке.*


*Важно! Только для этого шага в таблицу добавлены новые записи.  
Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       |                       | Иванов С.С.      | 50.00  | 10     |
| 7       | Дети полуночи         | Рушди Салман     | 950.00 | 5      |
| 8       | Лирика                | Гумилев Н.С.     | 460.00 | 10     |
| 9       | Поэмы                 | Бехтерев С.С.    | 460.00 | 10     |
| 10      | Капитанская дочка     | Пушкин А.С.      | 520.50 | 7      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author 
FROM 
  book 
WHERE 
  title LIKE "_% _%" 
  AND author LIKE "_% %С.%" 
ORDER BY 
  title;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | author      |
|:---------------:|:---------------:|
| Капитанская дочка     | Пушкин А.С. |
| Стихотворения и поэмы | Есенин С.А. |


┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="OneThree"></a> 1.3 Запросы, групповые операции

✳ Шаг 2. Выбор уникальных элементов столбца

❓*Задание. Отобрать различные (уникальные) элементы столбца amount таблицы book.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  amount 
FROM 
  book 
GROUP BY 
  amount;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| amount |
|:---------------:|
| 3      |
| 5      |
| 10     |
| 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Выборка данных, групповые функции SUM и COUNT

❓*Задание. Посчитать, количество различных книг и количество экземпляров книг каждого автора , хранящихся на складе.  Столбцы назвать Автор, Различных_книг и Количество_экземпляров соответственно.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author AS Автор, 
  COUNT(amount) AS Различных_книг, 
  SUM(amount) AS Количество_экземпляров 
FROM 
  book 
GROUP BY 
  author;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Автор            | Различных_книг | Количество_экземпляров |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | 2              | 8                      |
| Достоевский Ф.М. | 3              | 23                     |
| Есенин С.А.      | 1              | 15                     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Выборка данных, групповые функции MIN, MAX и AVG

❓*Задание. Вывести фамилию и инициалы автора, минимальную, максимальную и среднюю цену книг каждого автора . Вычисляемые столбцы назвать Минимальная_цена, Максимальная_цена и Средняя_цена соответственно.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  MIN(price) AS Минимальная_цена, 
  MAX(price) AS Максимальная_цена, 
  AVG(price) AS Средняя_цена 
FROM 
  book 
GROUP BY 
  author;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | Минимальная_цена | Максимальная_цена | Средняя_цена |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | 540.50           | 670.99            | 605.745000   |
| Достоевский Ф.М. | 460.00           | 799.01            | 579.836667   |
| Есенин С.А.      | 650.00           | 650.00            | 650.000000   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Выборка данных c вычислением, групповые функции

❓*Задание. Для каждого автора вычислить суммарную стоимость книг S (имя столбца Стоимость), а также вычислить налог на добавленную стоимость  для полученных сумм (имя столбца НДС ) , который включен в стоимость и составляет k = 18%,  а также стоимость книг  (Стоимость_без_НДС) без него. Значения округлить до двух знаков после запятой. В запросе для расчета НДС(tax)  и Стоимости без НДС(S_without_tax) использовать следующие формулы:*

`tax = (S * k/100) / (1 + k/100)`
`S_without_tax = S / (1 + k/100)`

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  SUM(price * amount) AS Стоимость, 
  ROUND(
    SUM(price * amount) * 0.18 / 1.18, 
    2
  ) AS НДС, 
  ROUND(
    SUM(price * amount) / 1.18, 
    2
  ) AS Стоимость_без_НДС 
FROM 
  book 
GROUP BY 
  author;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | Стоимость | НДС     | Стоимость_без_НДС |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | 4715.47   | 719.31  | 3996.16           |
| Достоевский Ф.М. | 11802.03  | 1800.31 | 10001.72          |
| Есенин С.А.      | 9750.00   | 1487.29 | 8262.71           |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Вычисления по таблице целиком

❓*Задание. Вывести  цену самой дешевой книги, цену самой дорогой и среднюю цену уникальных книг на складе. Названия столбцов Минимальная_цена, Максимальная_цена, Средняя_цена соответственно. Среднюю цену округлить до двух знаков после запятой.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  MIN(price) AS Минимальная_цена, 
  MAX(price) AS Максимальная_цена, 
  ROUND(
    AVG(price), 
    2
  ) AS Средняя_цена 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Минимальная_цена | Максимальная_цена | Средняя_цена |
|:---------------:|:---------------:|:---------------:|
| 460.00           | 799.01            | 600.17       |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Выборка данных по условию, групповые функции

❓*Задание. Вычислить среднюю цену и суммарную стоимость тех книг, количество экземпляров которых принадлежит интервалу от 5 до 14, включительно. Столбцы назвать Средняя_цена и Стоимость, значения округлить до 2-х знаков после запятой.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  ROUND(
    AVG(price), 
    2
  ) AS Средняя_цена, 
  ROUND(
    SUM(price * amount), 
    2
  ) AS Стоимость 
FROM 
  book 
WHERE 
  amount BETWEEN 5 
  AND 14;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Средняя_цена | Стоимость |
|:---------------:|:---------------:|
| 493.67       | 12107.50  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Выборка данных по условию, групповые функции, WHERE и HAVING

❓*Задание. Посчитать стоимость всех экземпляров каждого автора без учета книг «Идиот» и «Белая гвардия». В результат включить только тех авторов, у которых суммарная стоимость книг (без учета книг «Идиот» и «Белая гвардия») более 5000 руб. Вычисляемый столбец назвать Стоимость. Результат отсортировать по убыванию стоимости.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  SUM(price * amount) AS Стоимость 
FROM 
  book 
WHERE 
  title <> "Идиот" 
  AND title <> "Белая гвардия" 
GROUP BY 
  author 
HAVING 
  SUM(price * amount) > 5000 
ORDER BY 
  Стоимость DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | Стоимость |
|:---------------:|:---------------:|
| Есенин С.А.      | 9750.00   |
| Достоевский Ф.М. | 7202.03   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="OneFour"></a> 1.4 Вложенные запросы

✳ Шаг 2. Вложенный запрос, возвращающий одно значение

❓*Задание. Вывести информацию (автора, название и цену) о  книгах, цены которых меньше или равны средней цене книг на складе. Информацию вывести в отсортированном по убыванию цены виде. Среднее вычислить как среднее по цене книги.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  price <= (
    SELECT 
      AVG(price) 
    FROM 
      book
  ) 
ORDER BY 
  price DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title         | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Белая гвардия | 540.50 |
| Достоевский Ф.М. | Игрок         | 480.50 |
| Достоевский Ф.М. | Идиот         | 460.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Использование вложенного запроса в выражении

❓*Задание. Вывести информацию (автора, название и цену) о тех книгах, цены которых превышают минимальную цену книги на складе не более чем на 150 рублей в отсортированном по возрастанию цены виде.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 7       | Евгений Онегин        | Пушкин А.С.      | 610.00 | 10     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  price - (
    SELECT 
      MIN(price) 
    FROM 
      book
  ) <= 150 
ORDER BY 
  3 ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title          | price  |
|:---------------:|:---------------:|:---------------:|
| Достоевский Ф.М. | Идиот          | 460.00 |
| Достоевский Ф.М. | Игрок          | 480.50 |
| Булгаков М.А.    | Белая гвардия  | 540.50 |
| Пушкин А.С.      | Евгений Онегин | 610.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Вложенный запрос, оператор IN

❓*Задание. Вывести информацию (автора, книгу и количество) о тех книгах, количество экземпляров которых в таблице book не дублируется.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  amount 
FROM 
  book 
WHERE 
  amount IN (
    SELECT 
      amount 
    FROM 
      book 
    GROUP BY 
      amount 
    HAVING 
      COUNT(amount) = 1
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author        | title                 | amount |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А. | Белая гвардия         | 5      |
| Есенин С.А.   | Стихотворения и поэмы | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Вложенный запрос, операторы ANY и ALL

❓*Задание 5. Вывести информацию о книгах(автор, название, цена), цена которых меньше самой большой из минимальных цен, вычисленных для каждого автора.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  author, 
  title, 
  price 
FROM 
  book 
WHERE 
  price < ANY (
    SELECT 
      MIN(price) 
    FROM 
      book 
    GROUP BY 
      author
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title         | price  |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Белая гвардия | 540.50 |
| Достоевский Ф.М. | Идиот         | 460.00 |
| Достоевский Ф.М. | Игрок         | 480.50 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Вложенный запрос после SELECT

❓*Задание. Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на складе стало одинаковое количество экземпляров каждой книги, равное значению самого большего количества экземпляров одной книги на складе. Вывести название книги, ее автора, текущее количество экземпляров на складе и количество заказываемых экземпляров книг. Последнему столбцу присвоить имя Заказ. В результат не включать книги, которые заказывать не нужно.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  author, 
  amount, 
  (
    SELECT 
      MAX(amount) 
    FROM 
      book
  ) - amount AS Заказ 
FROM 
  book 
WHERE 
  amount <> (
    SELECT 
      MAX(amount) 
    FROM 
      book
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title              | author           | amount | Заказ |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="OneFive"></a> 1.5 Запросы корректировки данных

✳ Шаг 2. Создание пустой таблицы

❓*Задание. Создать таблицу поставка (supply), которая имеет ту же структуру, что и таблиц book.*

| Поле              | Тип, описание           | 
|:---------------:|:---------------:|
| supply_id       | INT PRIMARY KEY AUTO_INCREMENT    | 
| title           | VARCHAR(50)    | 
| author          | VARCHAR(30) | 
| price           | DECIMAL(8, 2) | 
| amount          | INT |

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE supply (
  supply_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author VARCHAR(30), 
  price DECIMAL(8, 2), 
  amount INT
);
```

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Добавление записей в таблицу

❓*Задание. Занесите в таблицу supply четыре записи, чтобы получилась следующая таблица:*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Лирика          | Пастернак Б.Л.	 | 518.99	 | 2      |
| 2       | Черный человек  | Есенин С.А.      | 570.20	 | 6     |
| 3       | Белая гвардия   | Булгаков М.А.    | 540.50 | 7     |
| 4       | Идиот           | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO supply (
  supply_id, title, author, price, amount
) 
VALUES 
  (
    1, "Лирика", "Пастернак Б.Л.", 
    518.99, 2
  ), 
  (
    2, "Черный человек", 
    "Есенин С.А.", 570.20, 6
  ), 
  (
    3, "Белая гвардия", "Булгаков М.А.", 
    540.50, 7
  ), 
  (
    4, "Идиот", "Достоевский Ф.М.", 
    360.80, 3
  );
  ```
  
🔎 `РЕЗУЛЬТАТ` ⤵️

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Добавление записей из другой таблицы

❓*Задание. Добавить из таблицы supply в таблицу book, все книги, кроме книг, написанных Булгаковым М.А. и Достоевским Ф.М.*

*Структура и наполнение таблиц book и supply:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Лирика          | Пастернак Б.Л.	 | 518.99	 | 2      |
| 2       | Черный человек  | Есенин С.А.      | 570.20	 | 6     |
| 3       | Белая гвардия   | Булгаков М.А.    | 540.50 | 7     |
| 4       | Идиот           | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (title, author, price, amount) 
SELECT 
  title, 
  author, 
  price, 
  amount 
FROM 
  supply 
WHERE 
  author NOT IN(
    "Булгаков М.А.", "Достоевский Ф.М."
  );
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Добавление записей, вложенные запросы

❓*Задание. Занести из таблицы supply в таблицу book только те книги, авторов которых нет в  book.*

*Структура и наполнение таблиц book и supply:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Лирика          | Пастернак Б.Л.	 | 518.99	 | 2      |
| 2       | Черный человек  | Есенин С.А.      | 570.20	 | 6     |
| 3       | Белая гвардия   | Булгаков М.А.    | 540.50 | 7     |
| 4       | Идиот           | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book (title, author, price, amount) 
SELECT 
  title, 
  author, 
  price, 
  amount 
FROM 
  supply 
WHERE 
  author NOT IN(
    SELECT 
      author 
    FROM 
      book
  );
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Запросы на обновление

❓*Задание. Уменьшить на 10% цену тех книг в таблице book, количество которых принадлежит интервалу от 5 до 10, включая границы.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
SET 
  price = 0.9 * price 
WHERE 
  amount BETWEEN 5 
  AND 10;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 486.45 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 414.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Запросы на обновление нескольких столбцов

❓*Задание. В таблице book необходимо скорректировать значение для покупателя в столбце buy таким образом, чтобы оно не превышало количество экземпляров книг, указанных в столбце amount. А цену тех книг, которые покупатель не заказывал, снизить на 10%.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount | buy |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 18  |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
SET 
  buy = IF(buy > amount, amount, buy), 
  price = IF(buy = 0, 0.9 * price, price);
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount | buy |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 603.89 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 719.11 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 15  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Запросы на обновление нескольких таблиц

❓*Задание. Для тех книг в таблице book , которые есть в таблице supply, не только увеличить их количество в таблице book ( увеличить их количество на значение столбца amountтаблицы supply), но и пересчитать их цену (для каждой книги найти сумму цен из таблиц book и supply и разделить на 2).*

*Структура и наполнение таблиц book и supply:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book, 
  supply 
SET 
  book.amount = book.amount + supply.amount, 
  book.price = (book.price + supply.price)/ 2 
WHERE 
  book.title = supply.title 
  AND book.author = supply.author;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 410.40 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Запросы на удаление

❓*Задание. Удалить из таблицы supply книги тех авторов, общее количество экземпляров книг которых в таблице book превышает 10.*

*Структура и наполнение таблиц book и supply:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  supply 
WHERE 
  author IN (
    SELECT 
      author 
    FROM 
      book 
    GROUP BY 
      author 
    HAVING 
      SUM(amount) > 10
  );
SELECT 
  * 
FROM 
  supply;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| supply_id | title         | author         | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Лирика        | Пастернак Б.Л. | 518.99 | 2      |
| 3         | Белая гвардия | Булгаков М.А.  | 540.50 | 7      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. Запросы на создание таблицы

❓*Задание. Создать таблицу заказ (ordering), куда включить авторов и названия тех книг, количество экземпляров которых в таблице book меньше среднего количества экземпляров книг в таблице book. В таблицу включить столбец   amount, в котором для всех книг указать одинаковое значение - среднее количество экземпляров книг в таблице book.*

*Структура и наполнение таблицы book:*

| book_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE ordering AS 
SELECT 
  author, 
  title, 
  (
    SELECT 
      ROUND(
        AVG(amount)
      ) 
    FROM 
      book
  ) AS amount 
FROM 
  book 
WHERE 
  amount < (
    SELECT 
      ROUND(
        AVG(amount)
      ) 
    FROM 
      book
  );
SELECT 
  * 
FROM 
  ordering;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author           | title              | amount |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Мастер и Маргарита | 7      |
| Булгаков М.А.    | Белая гвардия      | 7      |
| Достоевский Ф.М. | Братья Карамазовы  | 7      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="OneSix"></a> 1.6 Таблица "Командировки", запросы на выборку

✳ Шаг 2.

❓*Задание. Вывести из таблицы trip информацию о командировках тех сотрудников, фамилия которых заканчивается на букву «а», в отсортированном по убыванию даты последнего дня командировки виде. В результат включить столбцы name, city, per_diem, date_first, date_last.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  per_diem, 
  date_first, 
  date_last 
FROM 
  trip 
WHERE 
  name LIKE "%а %" 
ORDER by 
  date_last DESC;
SELECT 
  * 
FROM 
  trip;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| Федорова А.Ю. | Томск           | 450.00   | 2020-06-20 | 2020-06-26 |
| Абрамова К.А. | Санкт-Петербург | 700.00   | 2020-05-28 | 2020-06-04 |
| Федорова А.Ю. | Новосибирск     | 450.00   | 2020-05-25 | 2020-06-04 |
| Абрамова К.А. | Москва          | 700.00   | 2020-04-06 | 2020-04-14 |
| Абрамова К.А. | Москва          | 700.00   | 2020-02-23 | 2020-03-01 |
| Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3.

❓*Задание. Вывести в алфавитном порядке фамилии и инициалы тех сотрудников, которые были в командировке в Москве.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name 
FROM 
  trip 
WHERE 
  city = "Москва" 
GROUP BY 
  name 
ORDER BY 
  name ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          |
|:---------------:|
| Абрамова К.А. |
| Баранов П.Е.  |
| Колесов С.П.  |
| Лебедев Т.К.  |
| Семенов И.В.  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4.

❓*Задание. Для каждого города посчитать, сколько раз сотрудники в нем были.  Информацию вывести в отсортированном в алфавитном порядке по названию городов. Вычисляемый столбец назвать Количество.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  city, 
  COUNT(name) AS Количество 
FROM 
  trip 
GROUP BY 
  city 
ORDER BY 
  city ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| city            | Количество |
|:---------------:|:---------------:|
| Владивосток     | 3          |
| Воронеж         | 1          |
| Москва          | 7          |
| Новосибирск     | 4          |
| Санкт-Петербург | 3          |
| Томск           | 2          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Оператор LIMIT

❓*Задание. Вывести два города, в которых чаще всего были в командировках сотрудники. Вычисляемый столбец назвать Количество.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  city, 
  COUNT(name) AS Количество 
FROM 
  trip 
GROUP BY 
  city 
ORDER BY 
  2 DESC 
LIMIT 
  2;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| city        | Количество |
|:---------------:|:---------------:|
| Москва      | 7          |
| Новосибирск | 4          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6.

❓*Задание. Вывести информацию о командировках во все города кроме Москвы и Санкт-Петербурга (фамилии и инициалы сотрудников, город ,  длительность командировки в днях, при этом первый и последний день относится к периоду командировки). Последний столбец назвать Длительность. Информацию вывести в упорядоченном по убыванию длительности поездки, а потом по убыванию названий городов (в обратном алфавитном порядке).*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  (
    DATEDIFF(date_last, date_first) + 1
  ) AS Длительность 
FROM 
  trip 
WHERE 
  city NOT IN (
    'Москва', 'Санкт-Петербург'
  ) 
ORDER BY 
  Длительность DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city        | Длительность |
|:---------------:|:---------------:|:---------------:|
| Ильиных Г.Р.  | Владивосток | 22           |
| Баранов П.Е.  | Новосибирск | 17           |
| Колесов С.П.  | Новосибирск | 15           |
| Абрамова К.А. | Владивосток | 14           |
| Лебедев Т.К.  | Томск       | 12           |
| Абрамова К.А. | Владивосток | 12           |
| Федорова А.Ю. | Новосибирск | 11           |
| Колесов С.П.  | Новосибирск | 10           |
| Федорова А.Ю. | Томск       | 7            |
| Баранов П.Е.  | Воронеж     | 7            |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7.

❓*Задание. Вывести информацию о командировках сотрудника(ов), которые были самыми короткими по времени. В результат включить столбцы name, city, date_first, date_last.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  date_first, 
  date_last 
FROM 
  trip 
WHERE 
  DATEDIFF(date_last, date_first) IN(
    SELECT 
      MIN(
        DATEDIFF(date_last, date_first)
      ) 
    FROM 
      trip
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name         | city            | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Семенов И.В. | Санкт-Петербург | 2020-06-01 | 2020-06-03 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8.

❓*Задание. Вывести информацию о командировках, начало и конец которых относятся к одному месяцу (год может быть любой). В результат включить столбцы name, city, date_first, date_last. Строки отсортировать сначала в алфавитном порядке по названию города, а затем по фамилии сотрудника.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  date_first, 
  date_last 
FROM 
  trip 
WHERE 
  MONTH(date_first) = MONTH(date_last) 
ORDER BY 
  city, 
  name;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city            | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Абрамова К.А. | Владивосток     | 2020-01-14 | 2020-01-27 |
| Абрамова К.А. | Владивосток     | 2020-07-02 | 2020-07-13 |
| Баранов П.Е.  | Воронеж         | 2020-07-19 | 2020-07-25 |
| Абрамова К.А. | Москва          | 2020-04-06 | 2020-04-14 |
| Баранов П.Е.  | Москва          | 2020-01-12 | 2020-01-17 |
| Баранов П.Е.  | Москва          | 2020-02-14 | 2020-02-22 |
| Колесов С.П.  | Москва          | 2020-02-01 | 2020-02-06 |
| Лебедев Т.К.  | Москва          | 2020-03-03 | 2020-03-06 |
| Семенов И.В.  | Москва          | 2020-01-23 | 2020-01-31 |
| Колесов С.П.  | Новосибирск     | 2020-06-03 | 2020-06-12 |
| Семенов И.В.  | Санкт-Петербург | 2020-06-01 | 2020-06-03 |
| Лебедев Т.К.  | Томск           | 2020-05-20 | 2020-05-31 |
| Федорова А.Ю. | Томск           | 2020-06-20 | 2020-06-26 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9.

❓*Задание. Вывести название месяца и количество командировок для каждого месяца. Считаем, что командировка относится к некоторому месяцу, если она началась в этом месяце. Информацию вывести сначала в отсортированном по убыванию количества, а потом в алфавитном порядке по названию месяца виде. Название столбцов – Месяц и Количество.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  MONTHNAME(date_first) AS Месяц, 
  (
    COUNT(date_first)
  ) AS Количество 
FROM 
  trip 
GROUP BY 
  1 
ORDER BY 
  2 DESC, 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Месяц    | Количество |
|:---------------:|:---------------:|
| February | 4          |
| January  | 4          |
| June     | 3          |
| May      | 3          |
| April    | 2          |
| July     | 2          |
| March    | 2          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10.

❓*Задание. Вывести сумму суточных (произведение количества дней командировки и размера суточных) для командировок, первый день которых пришелся на февраль или март 2020 года. Значение суточных для каждой командировки занесено в столбец per_diem. Вывести фамилию и инициалы сотрудника, город, первый день командировки и сумму суточных. Последний столбец назвать Сумма. Информацию отсортировать сначала  в алфавитном порядке по фамилиям сотрудников, а затем по убыванию суммы суточных.*

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-02-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
|...|
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  city, 
  date_first, 
  (
    DATEDIFF(date_last + 1, date_first) * per_diem
  ) AS Сумма 
FROM 
  trip 
WHERE 
  MONTHNAME(date_first) IN("February", "March") 
ORDER BY 
  1, 
  4 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | city            | date_first | Сумма   |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Абрамова К.А. | Москва          | 2020-02-23 | 5600.00 |
| Баранов П.Е.  | Москва          | 2020-02-14 | 6300.00 |
| Колесов С.П.  | Новосибирск     | 2020-02-27 | 6750.00 |
| Колесов С.П.  | Москва          | 2020-02-01 | 4200.00 |
| Лебедев Т.К.  | Москва          | 2020-03-03 | 2800.00 |
| Семенов И.В.  | Санкт-Петербург | 2020-03-29 | 5600.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11.

❓*Задание. Вывести фамилию с инициалами и общую сумму суточных, полученных за все командировки для тех сотрудников, которые были в командировках больше чем 3 раза, в отсортированном по убыванию сумм суточных виде. Последний столбец назвать Сумма.  
Только для этого задания изменена строка таблицы trip:*

|4	|Ильиных Г.Р.	|Владивосток	|450	|2020-01-12	|2020-03-02|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|

*Структура и наполнение таблицы trip:*

| trip_id | name          | city            | per_diem | date_first | date_last  |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Москва          | 700.00   | 2020-01-12 | 2020-01-17 |
| 2       | Абрамова К.А. | Владивосток     | 450.00   | 2020-01-14 | 2020-01-27 |
| 3       | Семенов И.В.  | Москва          | 700.00   | 2020-01-23 | 2020-01-31 |
| 4       | Ильиных Г.Р.  | Владивосток     | 450.00   | 2020-01-12 | 2020-03-02 |
| 5       | Колесов С.П.  | Москва          | 700.00   | 2020-02-01 | 2020-02-06 |
| 6       | Баранов П.Е.  | Москва          | 700.00   | 2020-02-14 | 2020-02-22 |
                          ...
| 19      | Абрамова К.А. | Владивосток     | 450.00   | 2020-07-02 | 2020-07-13 |
| 20      | Баранов П.Е.  | Воронеж         | 450.00   | 2020-07-19 | 2020-07-25 |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  SUM(
    (
      DATEDIFF(date_last, date_first) + 1
    ) * per_diem
  ) AS Сумма 
FROM 
  trip 
WHERE 
  name IN(
    SELECT 
      name 
    FROM 
      trip 
    GROUP BY 
      name 
    HAVING 
      COUNT(name) > 3
  ) 
GROUP BY 
  name 
ORDER BY 
  2 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | Сумма    |
|:---------------:|:---------------:|
| Абрамова К.А. | 29200.00 |
| Баранов П.Е.  | 21300.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="OneSeven"></a> 1.7 Таблица "Нарушения ПДД", запросы корректировки

✳ Шаг 2.

❓*Задание. Создать таблицу fine следующей структуры:*

|Поле	          |Описание|
|:-------------:|:---------------:|
|fine_id	      |ключевой столбец целого типа с автоматическим увеличением значения ключа на 1|
|name	          |строка длиной 30|
|number_plate	  |строка длиной 6|
|violation	    |строка длиной 50|
|sum_fine	      |вещественное число, максимальная длина 8, количество знаков после запятой 2|
|date_violation	|дата|
|date_payment	  |дата|

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE fine (
  fine_id INT PRIMARY KEY AUTO_INCREMENT, 
  name VARCHAR(30), 
  number_plate VARCHAR(6), 
  violation VARCHAR(50), 
  sum_fine DECIMAL(8, 2), 
  date_violation DATE, 
  date_payment DATE
);
```

🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3.

❓*Задание. В таблицу fine первые 5 строк уже занесены. Добавить в таблицу записи с ключевыми значениями 6, 7, 8.*

|fine_id	|name	|number_plate	|violation	|sum_fine	|date_violation	|date_payment|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|1	|Баранов П.Е.	|Р523ВТ	|Превышение скорости(от 40 до 60)	|500.00	    |2020-01-12	||2020-01-17|
|2	|Абрамова К.А.|О111АВ	|Проезд на запрещающий сигнал	    |1000.00	  |2020-01-14	|2020-02-27|
|3	|Яковлев Г.Р.	|Т330ТТ	|Превышение скорости(от 20 до 40)	|500.00	    |2020-01-23	|2020-02-23|
|4	|Яковлев Г.Р.	|М701АА	|Превышение скорости(от 20 до 40)	|           |2020-01-12 |	         | 
|5	|Колесов С.П.	|К892АХ	|Превышение скорости(от 20 до 40)	|         	|2020-02-01 |	         | 
|6	|Баранов П.Е.	|Р523ВТ	|Превышение скорости(от 40 до 60)	|           |2020-02-14 |	         |  
|7	|Абрамова К.А.|О111АВ	|Проезд на запрещающий сигнал	 	  |           |2020-02-23 |	         | 	 
|8	|Яковлев Г.Р.	|Т330ТТ	|Проезд на запрещающий сигнал	 	  |         	|2020-03-03 |	         |  

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO fine (
  name, number_plate, violation, sum_fine, 
  date_violation, date_payment
) 
VALUES 
  (
    "Баранов П.Е.", "Р523ВТ", 
    "Превышение скорости(от 40 до 60)", 
    NULL, "2020-02-14", NULL
  ), 
  (
    "Абрамова К.А.", "О111АВ", 
    "Проезд на запрещающий сигнал", 
    NULL, "2020-02-23", NULL
  ), 
  (
    "Яковлев Г.Р.", "Т330ТТ", 
    "Проезд на запрещающий сигнал", 
    NULL, "2020-03-03", NULL
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | number_plate | violation                        | sum_fine | date_violation   | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12       | 2020-01-17   |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14       | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23       | 2020-02-23   |
| Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | NULL     | 2020-01-12       | NULL         |
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | NULL     | 2020-02-01       | NULL         |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | NULL     | 2020-02-14       | NULL         |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | NULL     | 2020-02-23       | NULL         |
| Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | NULL     | 2020-03-03       | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Использование временного имени таблицы (алиаса)

❓*Задание. Занести в таблицу fine суммы штрафов, которые должен оплатить водитель, в соответствии с данными из таблицы traffic_violation. При этом суммы заносить только в пустые поля столбца  sum_fine.
Таблица traffic_violationсоздана и заполнена.*

*Структура и наполнение исходной таблицы fine (без ключевого столбца) и таблицыtraffic_violation:*

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment | 
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | NULL     | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | NULL     | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | NULL     | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| NULL     | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| NULL     | 2020-03-03     | NULL         |

| violation_id | violation                        | sum_fine |
|:---------------:|:---------------:|:---------------:|
| 1            | Превышение скорости(от 20 до 40) | 500.00   |
| 2            | Превышение скорости(от 40 до 60) | 1000.00  |
| 3            | Проезд на запрещающий сигнал     | 1000.00  |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  fine AS f, 
  traffic_violation AS tv 
SET 
  f.sum_fine = tv.sum_fine 
WHERE 
  f.sum_fine IS NULL 
  AND f.violation = tv.violation;
SELECT 
  * 
FROM 
  fine;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 1000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Группировка данных по нескольким столбцам

❓*Задание. Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило   два и более раз. При этом учитывать все нарушения, независимо от того оплачены они или нет. Информацию отсортировать в алфавитном порядке, сначала по фамилии водителя, потом по номеру машины и, наконец, по нарушению.*

*Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:*

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name, 
  number_plate, 
  violation 
FROM 
  fine 
GROUP BY 
  name, 
  number_plate, 
  violation 
HAVING 
  COUNT(violation) > 1 
ORDER BY 
  1, 
  2, 
  3;
SELECT 
  * 
FROM 
  fine;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 1000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. В таблице fine увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей.*

*Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:*

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 1000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 1000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  fine, 
  (
    SELECT 
      name, 
      number_plate, 
      violation 
    FROM 
      fine 
    GROUP BY 
      name, 
      number_plate, 
      violation 
    HAVING 
      COUNT(violation) > 1 
    ORDER BY 
      1, 
      2, 
      3
  ) AS query_in 
SET 
  fine.sum_fine = sum_fine * 2 
WHERE 
  date_payment IS NULL 
  AND fine.name = query_in.name 
  AND fine.number_plate = query_in.number_plate 
  AND fine.violation = query_in.violation;
SELECT 
  * 
FROM 
  fine;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Водители оплачивают свои штрафы. В таблице payment занесены даты их оплаты:*

|payment_id	|name	|number_plate	|violation	|date_violation	|date_payment|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|1	|Яковлев Г.Р.	|М701АА	|Превышение скорости(от 20 до 40)	|2020-01-12	|2020-01-22|
|2	|Баранов П.Е.	|Р523ВТ	|Превышение скорости(от 40 до 60)	|2020-02-14	|2020-03-06|
|3	|Яковлев Г.Р.	|Т330ТТ	|Проезд на запрещающий сигнал	|2020-03-03	|2020-03-23|

*Необходимо:*
*в таблицу fine занести дату оплаты соответствующего штрафа из таблицы payment;* 
*уменьшить начисленный штраф в таблице fine в два раза  (только для тех штрафов, информация о которых занесена в таблицу payment) , если оплата произведена не позднее 20 дней со дня нарушения.*

*Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:*

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 500.00   | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 1000.00  | 2020-03-03     | NULL         |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  fine AS f, 
  payment AS p 
SET 
  f.date_payment = p.date_payment, 
  f.sum_fine = IF (
    DATEDIFF(
      p.date_payment, p.date_violation
    ) <= 20, 
    f.sum_fine / 2, 
    f.sum_fine
  ) 
WHERE 
  f.name = p.name 
  AND f.number_plate = p.number_plate 
  AND f.violation = p.violation 
  AND f.date_violation = p.date_violation 
  AND f.date_payment IS NULL;
SELECT 
  * 
FROM 
  fine;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 250.00   | 2020-01-12     | 2020-01-22   |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | 2020-03-06   |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03     | 2020-03-23   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Создать новую таблицу back_payment, куда внести информацию о неоплаченных штрафах (Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа  и  дату нарушения) из таблицы fine.*

*Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:*

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 250.00   | 2020-01-12     | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE back_payment AS 
SELECT 
  name, 
  number_plate, 
  violation, 
  sum_fine, 
  date_violation 
FROM 
  fine 
WHERE 
  date_payment IS NULL;
SELECT 
  * 
FROM 
  back_payment;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name          | number_plate | violation                        | sum_fine | date_violation |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Удалить из таблицы fine информацию о нарушениях, совершенных раньше 1 февраля 2020 года.*

*Структура и наполнение таблицы fine (без ключевого столбца) перед выполнением этого шага:*

| name          | number_plate | violation                    | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | 250.00   | 2020-01-12     | 2020-01-22   |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | 500.00   | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 2000.00  | 2020-02-14     | 2020-03-05   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| 2000.00  | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| 500.00   | 2020-03-03     | 2020-03-22   |

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  fine 
WHERE 
  date_violation < "2020-02-01";
SELECT 
  * 
FROM 
  fine;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | 2020-03-05   |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03     | 2020-03-22   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

## 2. Запросы SQL к связанным таблицам

### <a name="Two"></a> 2.1 Связи между таблицами

✳ Шаг 6. 

❓*Задание. Создать таблицу author следующей структуры:*

|Поле	|Тип, описание|
|:---------------:|:---------------:|
|author_id	|INT PRIMARY KEY AUTO_INCREMENT|
|name_author	|VARCHAR(50)|

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE author(
  author_id INT PRIMARY KEY AUTO_INCREMENT, 
  name_author VARCHAR(50)
);
```

🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Заполнить таблицу author. В нее включить следующих авторов:
-Булгаков М.А.  
-Достоевский Ф.М.  
-Есенин С.А.  
-Пастернак Б.Л.*

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO author (name_author) 
VALUES 
  ("Булгаков М.А."), 
  (
    "Достоевский Ф.М."
  ), 
  ("Есенин С.А."), 
  ("Пастернак Б.Л.");
SELECT 
  * 
FROM 
  author;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Создание таблицы с внешними ключами

❓*Задание. Перепишите запрос на создание таблицы book , чтобы ее структура соответствовала структуре, показанной на логической схеме (таблица genre уже создана, порядок следования столбцов - как на логической схеме в таблице book, genre_id  - внешний ключ) . Для genre_id ограничение о недопустимости пустых значений не задавать. В качестве главной таблицы для описания поля  genre_idиспользовать таблицу genre следующей структуры:*

|Поле	|Тип, описание|
|:---------------:|:---------------:|
|genre_id	|INT PRIMARY KEY AUTO_INCREMENT|
|name_genre	|VARCHAR(30)|

*Логическая схема (нужно создать только таблицу book):*

![](https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE book (
  book_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author_id INT NOT NULL, 
  genre_id INT, 
  price DECIMAL(8, 2), 
  amount INT, 
  FOREIGN KEY (author_id) REFERENCES author (author_id), 
  FOREIGN KEY (genre_id) REFERENCES genre (genre_id)
);
```

🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Действия при удалении записи главной таблицы

❓*Задание. Создать таблицу book той же структуры, что и на предыдущем шаге. Будем считать, что при удалении автора из таблицы author, должны удаляться все записи о книгах из таблицы book, написанные этим автором. А при удалении жанра из таблицы genre для соответствующей записи book установить значение Null в столбце genre_id.*

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE book (
  book_id INT PRIMARY KEY AUTO_INCREMENT, 
  title VARCHAR(50), 
  author_id INT NOT NULL, 
  genre_id INT, 
  price DECIMAL(8, 2), 
  amount INT, 
  FOREIGN KEY (author_id) REFERENCES author (author_id) ON DELETE CASCADE, 
  FOREIGN KEY (genre_id) REFERENCES genre (genre_id) ON DELETE 
  SET 
    NULL
);
```

🔎 `РЕЗУЛЬТАТ` ⤵️

`Affected rows: 0`

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. 

❓*Задание. Добавьте три последние записи (с ключевыми значениями 6, 7, 8) в таблицу book, первые 5 записей уже добавлены:*

|book_id	|title	|author_id	|genre_id	|price	|amount|
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
|1	|Мастер и Маргарита	|1	|1	|670.99	|3|
|2	|Белая гвардия	|1	|1	|540.50	|5|
|3	|Идиот	|2	|1	|460.00	|10|
|4	|Братья Карамазовы	|2	|1	|799.01	|3|
|5	|Игрок	|2	|1	|480.50	|10|
|6	|Стихотворения и поэмы	|3	|2	|650.00	|15|
|7	|Черный человек	|3	|2	|570.20	|6|
|8	|Лирика	|4	|2	|518.99	|2|

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book(
  title, author_id, genre_id, price, 
  amount
) 
VALUES 
  (
    "Стихотворения и поэмы", 
    3, 2, 650.00, 15
  ), 
  (
    "Черный человек", 3, 
    2, 570.20, 6
  ), 
  ("Лирика", 4, 2, 518.99, 2);
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="TwoTwo"></a> 2.2 Запросы на выборку, соединение таблиц

✳ Шаг 2. Соединение INNER JOIN

❓*Задание. Вывести название, жанр и цену тех книг, количество которых больше 8, в отсортированном по убыванию цены виде.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  name_genre, 
  price 
FROM 
  book 
  INNER JOIN genre ON book.genre_id = genre.genre_id 
WHERE 
  book.amount > 8 
ORDER BY 
  3 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | name_genre | price  |
|:---------------:|:---------------:|:---------------:|
| Стихотворения и поэмы | Поэзия     | 650.00 |
| Игрок                 | Роман      | 480.50 |
| Идиот                 | Роман      | 460.00 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Внешнее соединение LEFT и RIGHT OUTER JOIN

❓*Задание. Вывести все жанры, которые не представлены в книгах на складе.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_genre 
FROM 
  genre 
  LEFT JOIN book ON genre.genre_id = book.genre_id 
WHERE 
  book.genre_id IS NULL;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_genre  |
|:---------------:|
| Приключения |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Перекрестное соединение CROSS JOIN

❓*Задание. Есть список городов, хранящийся в таблице city:*

|city_id	|name_city|
|:---------------:|:---------------:|
|1	|Москва|
|2	|Санкт-Петербург|
|3	|Владивосток|

*Необходимо в каждом городе провести выставку книг каждого автора в течение 2020 года. Дату проведения выставки выбрать случайным образом. Создать запрос, который выведет город, автора и дату проведения выставки. Последний столбец назвать Дата. Информацию вывести, отсортировав сначала в алфавитном порядке по названиям городов, а потом по убыванию дат проведения выставок.*

*Структура таблицы:*

![Структура таблицы:](https://ucarecdn.com/4d2b7a6d-ef2f-4597-a12f-87b3af48494e/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица city:*

| city_id | name_city       |
|:---------------:|:---------------:|
| 1       | Москва          |
| 2       | Санкт-Петербург |
| 3       | Владивосток     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_city, 
  name_author, 
  (
    DATE_ADD(
      "2020-01-01", 
      INTERVAL FLOOR(
        RAND() * 365
      ) DAY
    )
  ) AS Дата 
FROM 
  author CROSS 
  JOIN city 
ORDER BY 
  1 ASC, 
  Дата DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_city       | name_author      | Дата       |
|:---------------:|:---------------:|:---------------:|
| Владивосток     | Есенин С.А.      | 2020-11-29 |
| Владивосток     | Лермонтов М.Ю.   | 2020-09-28 |
| Владивосток     | Достоевский Ф.М. | 2020-06-11 |
| Владивосток     | Булгаков М.А.    | 2020-03-18 |
| Владивосток     | Пастернак Б.Л.   | 2020-02-08 |
| Москва          | Достоевский Ф.М. | 2020-12-07 |
| Москва          | Лермонтов М.Ю.   | 2020-07-11 |
| Москва          | Булгаков М.А.    | 2020-04-28 |
| Москва          | Пастернак Б.Л.   | 2020-02-14 |
| Москва          | Есенин С.А.      | 2020-01-30 |
| Санкт-Петербург | Есенин С.А.      | 2020-10-06 |
| Санкт-Петербург | Булгаков М.А.    | 2020-05-23 |
| Санкт-Петербург | Лермонтов М.Ю.   | 2020-05-08 |
| Санкт-Петербург | Пастернак Б.Л.   | 2020-04-14 |
| Санкт-Петербург | Достоевский Ф.М. | 2020-04-02 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Запросы на выборку из нескольких таблиц

❓*Задание. Вывести информацию о книгах (жанр, книга, автор), относящихся к жанру, включающему слово «роман» в отсортированном по названиям книг виде.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |


✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_genre, 
  title, 
  name_author 
FROM 
  book 
  JOIN genre ON book.genre_id = genre.genre_id 
  JOIN author ON book.author_id = author.author_id 
WHERE 
  name_genre = "Роман" 
ORDER BY 
  2;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_genre | title              | name_author      |
|:---------------:|:---------------:|:---------------:|
| Роман      | Белая гвардия      | Булгаков М.А.    |
| Роман      | Братья Карамазовы  | Достоевский Ф.М. |
| Роман      | Игрок              | Достоевский Ф.М. |
| Роман      | Идиот              | Достоевский Ф.М. |
| Роман      | Мастер и Маргарита | Булгаков М.А.    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Запросы для нескольких таблиц с группировкой

❓*Задание. Посчитать количество экземпляров  книг каждого автора из таблицы author.  Вывести тех авторов,  количество книг которых меньше 10, в отсортированном по возрастанию количества виде. Последний столбец назвать Количество.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |


✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_author, 
  SUM(amount) AS Количество 
FROM 
  author AS a 
  LEFT JOIN book AS b ON a.author_id = b.author_id 
GROUP BY 
  name_author 
HAVING 
  Количество < 10 
  OR Количество IS NULL 
ORDER BY 
  Количество ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_author    | Количество |
|:----------:|:---------------:|
| Лермонтов М.Ю. | NULL       |
| Пастернак Б.Л. | 2          |
| Булгаков М.А.  | 8          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Запросы для нескольких таблиц со вложенными запросами

❓*Задание. Вывести в алфавитном порядке всех авторов, которые пишут только в одном жанре. Поскольку у нас в таблицах так занесены данные, что у каждого автора книги только в одном жанре,  для этого запроса внесем изменения в таблицу book. Пусть у нас  книга Есенина «Черный человек» относится к жанру «Роман», а книга Булгакова «Белая гвардия» к «Приключениям» (эти изменения в таблицы уже внесены).*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 3        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 1        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_author 
FROM 
  author AS a 
  JOIN book AS b ON b.author_id = a.author_id 
  JOIN genre AS g ON g.genre_id = b.genre_id 
GROUP BY 
  name_author 
HAVING 
  COUNT(
    DISTINCT(name_genre)
  ) = 1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_author      |
|:---------------:|
| Достоевский Ф.М. |
| Пастернак Б.Л.   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Вложенные запросы в операторах соединения

❓*Задание. Вывести информацию о книгах (название книги, фамилию и инициалы автора, название жанра, цену и количество экземпляров книги), написанных в самых популярных жанрах, в отсортированном в алфавитном порядке по названию книг виде. Самым популярным считать жанр, общее количество экземпляров книг которого на складе максимально.*

*Логическая схема базы данных:*

![Логическая схема базы данных](https://ucarecdn.com/26d5d90a-3e95-46bc-807d-10fb53d10f25/)

*Структура и наполнение таблиц:*

*Таблица genre:*

| genre_id | name_genre  |
|:---------------:|:---------------:|
| 1        | Роман       |
| 2        | Поэзия      |
| 3        | Приключения |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 4       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 5       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 6       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 7       | Лирика                | 4         | 2        | 518.99 | 10     |
| 8       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 9       | Герой нашего времени  | 5         | 3        | 570.59 | 2      |
| 10      | Доктор Живаго         | 4         | 3        | 740.50 | 5      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  name_author, 
  name_genre, 
  price, 
  amount 
FROM 
  book 
  JOIN genre ON book.genre_id = genre.genre_id 
  JOIN author ON book.author_id = author.author_id 
WHERE 
  book.genre_id IN(
    SELECT 
      query_in_2.genre_id 
    FROM 
      (
        SELECT 
          genre.genre_id, 
          SUM(amount) AS sum_amount 
        FROM 
          genre 
          JOIN book ON genre.genre_id = book.genre_id 
        GROUP BY 
          book.genre_id 
        ORDER BY 
          sum_amount DESC 
        LIMIT 
          1
      ) query_in_1 
      JOIN (
        SELECT 
          genre.genre_id, 
          SUM(amount) AS sum_amount 
        FROM 
          genre 
          JOIN book ON genre.genre_id = book.genre_id 
        GROUP BY 
          book.genre_id 
        ORDER BY 
          sum_amount DESC
      ) query_in_2 ON query_in_1.sum_amount = query_in_2.sum_amount
  ) 
ORDER BY 
  title;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | name_author      | name_genre | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Белая гвардия         | Булгаков М.А.    | Роман      | 540.50 | 5      |
| Братья Карамазовы     | Достоевский Ф.М. | Роман      | 799.01 | 3      |
| Игрок                 | Достоевский Ф.М. | Роман      | 480.50 | 10     |
| Идиот                 | Достоевский Ф.М. | Роман      | 460.00 | 10     |
| Лирика                | Пастернак Б.Л.   | Поэзия     | 518.99 | 10     |
| Мастер и Маргарита    | Булгаков М.А.    | Роман      | 670.99 | 3      |
| Стихотворения и поэмы | Есенин С.А.      | Поэзия     | 650.00 | 15     |
| Черный человек        | Есенин С.А.      | Поэзия     | 570.20 | 6      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. Операция соединение, использование USING()

❓*Задание. Если в таблицах supply  и book есть одинаковые книги, которые имеют равную цену,  вывести их название и автора, а также посчитать общее количество экземпляров книг в таблицах supply и book,  столбцы назвать Название, Автор  и Количество.*

*Схема данных:*

![Схема данных:](https://ucarecdn.com/6de130b3-aac2-4216-82bb-7421c2a614ad/)

*Структура и наполнение таблиц:*

*Таблица supply:*

| supply_id | title          | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго  | Пастернак Б.Л.   | 618.99 | 3      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Евгений Онегин | Пушкин А.С.      | 440.80 | 5      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |

*Таблица author:*

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |

*Таблица book:*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title AS Название, 
  name_author AS Автор, 
  SUM(book.amount + supply.amount) AS Количество 
FROM 
  supply 
  INNER JOIN book USING(price, title) 
  INNER JOIN author ON author.name_author = supply.author 
GROUP BY 
  author.name_author, 
  book.title;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Название       | Автор       | Количество |
|:---------------:|:---------------:|:---------------:|
| Черный человек | Есенин С.А. | 12         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="TwoThree"></a> 2.3 Запросы корректировки, соединение таблиц

*Концептуальная схема базы данных:*

![](https://ucarecdn.com/f95c8b49-0d5c-45e0-9e35-6261f7cbbbe8/)

*Логическая схема базы данных:*

![](https://ucarecdn.com/95045d96-412d-4e10-88f2-7ac6b13fada6/)

✳ Шаг 2. Запросы на обновление, связанные таблицы

❓*Задание. Для книг, которые уже есть на складе (в таблице book), но по другой цене, чем в поставке (supply),  необходимо в таблице book увеличить количество на значение, указанное в поставке,  и пересчитать цену. А в таблице  supply обнулить количество этих книг. Формула для пересчета цены:*  
*price = (p1∗k1 + p2∗k2) / (k1+k2)*  
*где  p1, p2 - цена книги в таблицах book и supply;*  
*k1, k2 - количество книг в таблицах book и supply.*

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
  JOIN author ON author.author_id = book.author_id 
  JOIN supply ON book.title = supply.title 
  AND supply.author = author.name_author 
SET 
  book.amount = book.amount + supply.amount, 
  book.price = (
    book.price * book.amount + supply.price * supply.amount
  ) / (book.amount + supply.amount), 
  supply.amount = 0 
WHERE 
  book.price <> supply.price;
SELECT 
  * 
FROM 
  book;
SELECT 
  * 
FROM 
  supply;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. Запросы на добавление, связанные таблицы

❓*Задание. Включить новых авторов в таблицу author с помощью запроса на добавление, а затем вывести все данные из таблицы author.  Новыми считаются авторы, которые есть в таблице supply, но нет в таблице author.*  

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO author (name_author) 
SELECT 
  supply.author 
FROM 
  author 
  RIGHT JOIN supply ON author.name_author = supply.author 
WHERE 
  name_author IS NULL;
SELECT 
  * 
FROM 
  author;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. Запрос на добавление, связанные таблицы

❓*Задание. Добавить новые книги из таблицы supply в таблицу book на основе сформированного выше запроса. Затем вывести для просмотра таблицу book.*  

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 0      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 0      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO book(title, author_id, price, amount) 
SELECT 
  title, 
  author_id, 
  price, 
  amount 
FROM 
  author 
  INNER JOIN supply ON author.name_author = supply.author 
WHERE 
  amount <> 0;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | NULL     | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | NULL     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | NULL     | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Запрос на обновление, вложенные запросы

❓*Задание. Занести для книги «Стихотворения и поэмы» Лермонтова жанр «Поэзия», а для книги «Остров сокровищ» Стивенсона - «Приключения». (Использовать два запроса).*  

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | Null     | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | Null     | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
SET 
  genre_id = (
    SELECT 
      genre_id 
    FROM 
      genre 
    WHERE 
      name_genre = "Поэзия"
  ) 
WHERE 
  book.title = "Стихотворения и поэмы";
UPDATE 
  book 
SET 
  genre_id = (
    SELECT 
      genre_id 
    FROM 
      genre 
    WHERE 
      name_genre = "Приключения"
  ) 
WHERE 
  book.title = "Остров сокровищ";
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Каскадное удаление записей связанных таблиц

❓*Задание. Удалить всех авторов и все их книги, общее количество книг которых меньше 20.*  

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  author 
WHERE 
  author_id IN (
    SELECT 
      author_id 
    FROM 
      book 
    GROUP BY 
      author_id 
    HAVING 
      SUM(amount) < 20
  );
SELECT 
  * 
FROM 
  author;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. Удаление записей главной таблицы с сохранением записей в зависимой

❓*Задание. Удалить все жанры, к которым относится меньше 4-х книг. В таблице book для этих жанров установить значение Null.*  

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  genre 
WHERE 
  genre_id IN (
    SELECT 
      genre_id 
    FROM 
      book 
    GROUP BY 
      genre_id 
    HAVING 
      COUNT(title) < 4
  );
SELECT 
  * 
FROM 
  genre;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| genre_id | name_genre |
|:---------------:|:---------------:|
| 1        | Роман      |
| 2        | Поэзия     |

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | NULL     | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Удаление записей, использование связанных таблиц

❓*Задание. Удалить всех авторов, которые пишут в жанре "Поэзия". Из таблицы book удалить все книги этих авторов. В запросе для отбора авторов использовать полное название жанра, а не его id.*  

*Структура и наполнение таблиц:*

*Таблица book*

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
| 9       | Доктор Живаго         | 4         | 1        | 380.80 | 4      |
| 10      | Стихотворения и поэмы | 5         | 2        | 255.90 | 4      |
| 11      | Остров сокровищ       | 6         | 3        | 599.99 | 5      |

*Таблица supply*

| supply_id | title                 | author           | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |

*Таблица author*                          
	
| author_id | name_author      |			
|:---------------:|:---------------:|		
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 3         | Есенин С.А.      |
| 4         | Пастернак Б.Л.   |				
| 5         | Лермонтов М.Ю.   |
| 6         | Стивенсон Р.Л.   |

*Таблица genre*

| genre_id | name_genre  |	
|:---------------:|:---------------:|		
| 1        | Роман       |			
| 2        | Поэзия      |			
| 3        | Приключения |		

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  author USING author 
  INNER JOIN book ON author.author_id = book.author_id 
  INNER JOIN genre ON genre.genre_id = book.genre_id 
WHERE 
  name_genre = 'Поэзия';
SELECT 
  * 
FROM 
  author;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| author_id | name_author      |
|:---------------:|:---------------:|
| 1         | Булгаков М.А.    |
| 2         | Достоевский Ф.М. |
| 6         | Стивенсон Р.Л.   |

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия      | 1         | 1        | 540.50 | 12     |
| 3       | Идиот              | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы  | 2         | 1        | 799.01 | 3      |
| 5       | Игрок              | 2         | 1        | 480.50 | 10     |
| 11      | Остров сокровищ    | 6         | 3        | 599.99 | 5      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="TwoFour"></a> 2.4 База данных «Интернет-магазин книг», запросы на выборку

В интернет-магазине продаются книги. Каждая книга имеет название, написана одним автором, относится к одному жанру, имеет определенную цену. В магазине в наличии есть несколько экземпляров каждой книги.   
Покупатель регистрируется на сайте интернет-магазина, задает свое имя и фамилию, электронную почту и город проживания. Он может сформировать один или несколько заказов, для каждого заказа написать какие-то пожелания. Каждый заказ включает одну или несколько книг, каждую книгу можно заказать в нескольких экземплярах. Затем заказ проходит ряд последовательных этапов (операций): оплачивается, упаковывается, передается курьеру или транспортной компании для транспортировки и, наконец, доставляется покупателю. Фиксируется дата каждой операции. Для каждого города известно среднее время доставки книг.  
При этом в магазине ведется учет книг, при покупке их количество уменьшается, при поступлении товара увеличивается, при исчерпании количества – оформляется заказ и пр.  
В данном уроке сначала будет построена концептуальная модель базы данных, затем ее логическая модель. Также будут определены структура и содержание таблиц базы данных «Интернет-магазин книг».

Логическая схема базы данных:

![](https://ucarecdn.com/bbf07d33-64e8-4391-8cde-4fcb75d4cec1/)

Логическая модель базы данных:

![](https://ucarecdn.com/bad26356-5e34-4945-a9d4-0748686a6b54/)

Наполнение таблиц:

![](https://ucarecdn.com/09eb90ce-ce66-446b-8337-e391caabff1c/)

✳ Шаг 5. Запросы на основе трех и более связанных таблиц

❓*Задание. Вывести все заказы Баранова Павла (id заказа, какие книги, по какой цене и в каком количестве он заказал) в отсортированном по номеру заказа и названиям книг виде.* 

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy.buy_id, 
  book.title, 
  book.price, 
  buy_book.amount 
FROM 
  client 
  INNER JOIN buy ON client.client_id = buy.client_id 
  INNER JOIN buy_book ON buy.buy_id = buy_book.buy_id 
  INNER JOIN book ON buy_book.book_id = book.book_id 
WHERE 
  name_client = "Баранов Павел" 
ORDER BY 
  buy_id, 
  title;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | title              | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1      | Идиот              | 460.00 | 1      |
| 1      | Мастер и Маргарита | 670.99 | 1      |
| 1      | Черный человек     | 570.20 | 2      |
| 4      | Игрок              | 480.50 | 1      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Посчитать, сколько раз была заказана каждая книга, для книги вывести ее автора (нужно посчитать, в каком количестве заказов фигурирует каждая книга).  Вывести фамилию и инициалы автора, название книги, последний столбец назвать Количество. Результат отсортировать сначала  по фамилиям авторов, а потом по названиям книг.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/c9356f96-1b19-42ce-8c9e-e7a8169734fc/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_author, 
  title, 
  COUNT(buy_book.amount) AS Количество 
FROM 
  author 
  INNER JOIN book USING(author_id) 
  LEFT JOIN buy_book USING(book_id) 
GROUP BY 
  book.title, 
  name_author 
ORDER BY 
  name_author, 
  title;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_author      | title                 | Количество |
|:---------------:|:---------------:|:---------------:|
| Булгаков М.А.    | Белая гвардия         | 1          |
| Булгаков М.А.    | Мастер и Маргарита    | 2          |
| Достоевский Ф.М. | Братья Карамазовы     | 0          |
| Достоевский Ф.М. | Игрок                 | 1          |
| Достоевский Ф.М. | Идиот                 | 2          |
| Есенин С.А.      | Стихотворения и поэмы | 0          |
| Есенин С.А.      | Черный человек        | 1          |
| Пастернак Б.Л.   | Лирика                | 1          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Вывести города, в которых живут клиенты, оформлявшие заказы в интернет-магазине. Указать количество заказов в каждый город, этот столбец назвать Количество. Информацию вывести по убыванию количества заказов, а затем в алфавитном порядке по названию городов.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/1e4836b9-6cf8-41bd-9f82-38b11c7882aa/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_city, 
  COUNT(buy_id) AS Количество 
FROM 
  city 
  INNER JOIN client ON city.city_id = client.city_id 
  INNER JOIN buy ON client.client_id = buy.client_id 
GROUP BY 
  name_city 
ORDER BY 
  2 DESC, 
  name_city;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_city       | Количество |
|:---------------:|:---------------:|
| Владивосток     | 2          |
| Москва          | 1          |
| Санкт-Петербург | 1          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Вывести номера всех оплаченных заказов и даты, когда они были оплачены.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/a6be5406-fcef-4a74-89bc-eb7833621092/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy_id, 
  date_step_end 
FROM 
  step 
  INNER JOIN buy_step ON step.step_id = buy_step.step_id 
WHERE 
  date_step_end IS NOT NULL 
  AND buy_step.step_id = 1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | date_step_end |
|:---------------:|:---------------:|
| 1      | 2020-02-20    |
| 2      | 2020-02-28    |
| 3      | 2020-03-05    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Вывести информацию о каждом заказе: его номер, кто его сформировал (фамилия пользователя) и его стоимость (сумма произведений количества заказанных книг и их цены), в отсортированном по номеру заказа виде. Последний столбец назвать Стоимость.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/cce071e8-3a35-4642-8fff-460f0899e4eb/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy.buy_id, 
  name_client, 
  SUM(buy_book.amount * book.price) AS Стоимость 
FROM 
  buy_book 
  INNER JOIN book ON book.book_id = buy_book.book_id 
  INNER JOIN buy ON buy.buy_id = buy_book.buy_id 
  INNER JOIN client ON client.client_id = buy.client_id 
GROUP BY 
  buy_id 
ORDER BY 
  buy_id;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | name_client    | Стоимость |
|:---------------:|:---------------:|:---------------:|
| 1      | Баранов Павел  | 2271.39   |
| 2      | Семенонов Иван | 1037.98   |
| 3      | Абрамова Катя  | 2131.49   |
| 4      | Баранов Павел  | 480.50    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. 

❓*Задание. Вывести номера заказов (buy_id) и названия этапов,  на которых они в данный момент находятся. Если заказ доставлен –  информацию о нем не выводить. Информацию отсортировать по возрастанию buy_id.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/0178ea29-ab37-4ce9-83ac-bd49d2636c20/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy_id, 
  name_step 
FROM 
  buy_step 
  INNER JOIN step ON buy_step.step_id = step.step_id 
WHERE 
  date_step_beg IS NOT NULL 
  AND date_step_end IS NULL 
ORDER BY 
  buy_id, 
  name_step;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | name_step       |
|:---------------:|:---------------:|
| 2      | Транспортировка |
| 3      | Доставка        |
| 4      | Оплата          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. 

❓*Задание. В таблице city для каждого города указано количество дней, за которые заказ может быть доставлен в этот город (рассматривается только этап Транспортировка). Для тех заказов, которые прошли этап транспортировки, вывести количество дней за которое заказ реально доставлен в город. А также, если заказ доставлен с опозданием, указать количество дней задержки, в противном случае вывести 0. В результат включить номер заказа (buy_id), а также вычисляемые столбцы Количество_дней и Опоздание. Информацию вывести в отсортированном по номеру заказа виде.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/6b3c2d87-7353-48e6-adfd-26c338886f4a/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  buy_step.buy_id, 
  DATEDIFF(date_step_end, date_step_beg) AS Количество_дней, 
  IF(
    DATEDIFF(date_step_end, date_step_beg) > city.days_delivery, 
    DATEDIFF(date_step_end, date_step_beg) - city.days_delivery, 
    0
  ) AS Опоздание 
FROM 
  buy_step 
  INNER JOIN step ON buy_step.step_id = step.step_id 
  INNER JOIN buy ON buy_step.buy_id = buy.buy_id 
  INNER JOIN client ON buy.client_id = client.client_id 
  INNER JOIN city ON client.city_id = city.city_id 
WHERE 
  buy_step.step_id = 3 
  AND date_step_end IS NOT NULL 
ORDER BY 
  buy_id;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | Количество_дней | Опоздание |
|:---------------:|:---------------:|:---------------:|
| 1      | 14              | 2         |
| 3      | 4               | 0         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 12. 

❓*Задание. Выбрать всех клиентов, которые заказывали книги Достоевского, информацию вывести в отсортированном по алфавиту виде. В решении используйте фамилию автора, а не его id.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/81b4c54e-bfb0-4582-9df9-279b6be0154e/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  DISTINCT name_client 
FROM 
  client 
  INNER JOIN buy USING(client_id) 
  INNER JOIN buy_book USING(buy_id) 
  INNER JOIN book USING(book_id) 
  INNER JOIN author USING(author_id) 
WHERE 
  author.name_author = 'Достоевский Ф.М.' 
ORDER BY 
  name_client;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_client   |
|:---------------:|
| Абрамова Катя |
| Баранов Павел |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 13. 

❓*Задание. Вывести жанр (или жанры), в котором было заказано больше всего экземпляров книг, указать это количество. Последний столбец назвать Количество.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/710494ce-e3a3-4d4b-8f10-5ab41b474b31/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_genre, 
  SUM(buy_book.amount) AS Количество 
FROM 
  genre 
  INNER JOIN book USING(genre_id) 
  INNER JOIN buy_book USING(book_id) 
GROUP BY 
  1 
HAVING 
  Количество = (
    SELECT 
      MAX(sum_amount) AS max_sum_amount 
    FROM 
      (
        SELECT 
          name_genre, 
          SUM(buy_book.amount) AS sum_amount 
        FROM 
          genre 
          INNER JOIN book ON genre.genre_id = book.genre_id 
          INNER JOIN buy_book ON book.book_id = buy_book.book_id 
        GROUP BY 
          name_genre
      ) AS query_in
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_genre | Количество |
|:---------------:|:---------------:|
| Роман      | 7          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 14. 

❓*Задание. Сравнить ежемесячную выручку от продажи книг за текущий и предыдущий годы. Для этого вывести год, месяц, сумму выручки в отсортированном сначала по возрастанию месяцев, затем по возрастанию лет виде. Название столбцов: Год, Месяц, Сумма.* 

*Фрагмент логической схемы базы данных (в запросе НЕ ОБЯЗАТЕЛЬНО использовать все таблицы):*

![](https://ucarecdn.com/843369b4-8065-4023-99bf-60a08aaafa34/)

*Информация о продажах предыдущего года хранится в архивной таблице buy_archive, которая создается в конце года на основе информации из таблиц базы данных и имеет следующую структуру:*

|Название столбца	|Описание|
|buy_archive_id		|ключевой столбец|
|buy_id	id		|заказов, выбирается из таблицы buy|
|client_id		|id клиентов, выбирается из из таблицы client|
|book_id		|id книги, выбирается из таблицы book|
|date_payment		|дата оплаты заказа, выбирается из столбца date_step_end|
|таблицы buy_step 	|этапа «Оплата» соответствующего заказа|
|price			|цена книги в текущем заказе из таблицы book (хранится, так как цена может измениться)|
|amount			|количество купленных книг в текущем заказе, из таблицы buy_book|

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  YEAR(date_payment) AS Год, 
  MONTHNAME(date_payment) AS Месяц, 
  SUM(price * amount) AS Сумма 
FROM 
  buy_archive 
GROUP BY 
  1, 
  2 
UNION ALL 
SELECT 
  YEAR(date_step_end) AS Год, 
  MONTHNAME(date_step_end) AS Месяц, 
  SUM(price * buy_book.amount) AS Сумма 
FROM 
  buy_step 
  INNER JOIN buy_book USING(buy_id) 
  INNER JOIN book USING(book_id) 
WHERE 
  date_step_end IS NOT NULL 
  AND step_id = 1 
GROUP BY 
  1, 
  2 
ORDER BY 
  2 ASC, 
  1 ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Год  | Месяц    | Сумма   |
|:---------------:|:---------------:|:---------------:|
| 2019 | February | 5626.30 |
| 2020 | February | 3309.37 |
| 2019 | March    | 6857.50 |
| 2020 | March    | 2131.49 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 15. 

❓*Задание. Для каждой отдельной книги необходимо вывести информацию о количестве проданных экземпляров и их стоимости за 2020 и 2019 год . Вычисляемые столбцы назвать Количество и Сумма. Информацию отсортировать по убыванию стоимости.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/d5c5d16e-32eb-4caa-8fc8-6982cda2ac32/)

*Информация о продажах прошлого года хранится в таблице buy_archive следующей структуры:*

![](https://ucarecdn.com/bd089cc7-acb0-442e-a276-4995f7ade4b1/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  title, 
  SUM(Количество) AS Количество, 
  SUM(Сумма) AS Сумма 
FROM 
  (
    SELECT 
      book.title, 
      SUM(buy_book.amount) AS Количество, 
      SUM(book.price * buy_book.amount) AS Сумма 
    FROM 
      book 
      INNER JOIN buy_book USING(book_id) 
      INNER JOIN buy ON buy_book.buy_id = buy.buy_id 
      INNER JOIN buy_step ON buy_step.buy_id = buy.buy_id 
      INNER JOIN step ON buy_step.step_id = step.step_id 
    WHERE 
      step.name_step = 'Оплата' 
      AND buy_step.date_step_end IS NOT NULL 
    GROUP BY 
      1 
    UNION ALL 
    SELECT 
      book.title, 
      SUM(buy_archive.amount) AS Количество, 
      SUM(
        buy_archive.price * buy_archive.amount
      ) AS Сумма 
    FROM 
      buy_archive 
      INNER JOIN book USING(book_id) 
    GROUP BY 
      1
  ) AS query_in 
GROUP BY 
  title 
ORDER BY 
  Сумма DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title                 | Количество | Сумма   |
|:---------------:|:---------------:|:---------------:|
| Братья Карамазовы     | 8          | 6247.20 |
| Мастер и Маргарита    | 6          | 4024.38 |
| Идиот                 | 5          | 2281.80 |
| Белая гвардия         | 3          | 1581.10 |
| Черный человек        | 2          | 1140.40 |
| Лирика                | 2          | 1037.98 |
| Игрок                 | 2          | 961.80  |
| Стихотворения и поэмы | 1          | 650.00  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="TwoFive"></a> 2.5 База данных «Интернет-магазин книг», запросы корректировки

✳ Шаг 2. 

❓*Задание. Включить нового человека в таблицу с клиентами. Его имя Попов Илья, его email popov@test, проживает он в Москве.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/2d95c7c4-3164-4d35-b195-6dea9308e5ae/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO client (name_client, city_id, email) 
SELECT 
  'Попов Илья', 
  city_id, 
  'popov@test' 
FROM 
  city 
WHERE 
  name_city = 'Москва';
SELECT 
  * 
FROM 
  client;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| client_id | name_client     | city_id | email          |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | Баранов Павел   | 3       | baranov@test   |
| 2         | Абрамова Катя   | 1       | abramova@test  |
| 3         | Семенонов Иван  | 2       | semenov@test   |
| 4         | Яковлева Галина | 1       | yakovleva@test |
| 5         | Попов Илья      | 1       | popov@test     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Создать новый заказ для Попова Ильи. Его комментарий для заказа: «Связаться со мной по вопросу доставки».* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/410c7a2e-696d-4865-b9b6-a176350d5cbd/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO buy(buy_description, client_id) 
SELECT 
  'Связаться со мной по вопросу доставки', 
  client_id 
FROM 
  client 
WHERE 
  name_client = 'Попов Илья';
SELECT 
  * 
FROM 
  buy;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | buy_description                       | client_id |
|:---------------:|:---------------:|:---------------:|
| 1      | Доставка только вечером               | 1         |
| 2      | NULL                                  | 3         |
| 3      | Упаковать каждую книгу по отдельности | 2         |
| 4      | NULL                                  | 1         |
| 5      | Связаться со мной по вопросу доставки | 5         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. В таблицу buy_book добавить заказ с номером 5. Этот заказ должен содержать книгу Пастернака «Лирика» в количестве двух экземпляров и книгу Булгакова «Белая гвардия» в одном экземпляре.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/b6bd319d-0d03-4b9a-86a2-98ac762fa4dc/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO buy_book(buy_id, book_id, amount) 
SELECT 
  5, 
  book_id, 
  2 
FROM 
  book 
  INNER JOIN author USING(author_id) 
WHERE 
  author.name_author LIKE 'Пастернак%' 
  AND book.title LIKE 'Лирика%' 
UNION 
SELECT 
  5, 
  book_id, 
  1 
FROM 
  book 
  INNER JOIN author USING(author_id) 
WHERE 
  author.name_author LIKE 'Булгаков%' 
  AND book.title LIKE 'Белая гвардия%';
SELECT 
  * 
FROM 
  buy_book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_book_id | buy_id | book_id | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 1      |
| 2           | 1      | 7       | 2      |
| 3           | 1      | 3       | 1      |
| 4           | 2      | 8       | 2      |
| 5           | 3      | 3       | 2      |
| 6           | 3      | 2       | 1      |
| 7           | 3      | 1       | 1      |
| 8           | 4      | 5       | 1      |
| 9           | 5      | 8       | 2      |
| 10          | 5      | 2       | 1      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. 

❓*Задание. Количество тех книг на складе, которые были включены в заказ с номером 5, уменьшить на то количество, которое в заказе с номером 5  указано.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/96d439bc-b2d4-4850-9762-ade76851aa9e/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  book 
  INNER JOIN buy_book USING(book_id) 
SET 
  book.amount = book.amount - buy_book.amount 
WHERE 
  buy_book.buy_id = 5 
  AND book.book_id = buy_book.book_id;
SELECT 
  * 
FROM 
  book;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| book_id | title                 | author_id | genre_id | price  | amount |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 4      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 0      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Создать счет (таблицу buy_pay) на оплату заказа с номером 5, в который включить название книг, их автора, цену, количество заказанных книг и  стоимость. Последний столбец назвать Стоимость. Информацию в таблицу занести в отсортированном по названиям книг виде.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/cf0254ce-b399-4abd-afa4-29c3613272b0/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE buy_pay AS 
SELECT 
  title, 
  name_author, 
  price, 
  buy_book.amount, 
  book.price * buy_book.amount AS Стоимость 
FROM 
  buy_book 
  JOIN book USING(book_id) 
  JOIN author USING(author_id) 
WHERE 
  buy_book.buy_id = 5 
ORDER BY 
  book.title;
SELECT 
  * 
FROM 
  buy_pay;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| title         | name_author    | price  | amount | Стоимость |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Белая гвардия | Булгаков М.А.  | 540.50 | 1      | 540.50    |
| Лирика        | Пастернак Б.Л. | 518.99 | 2      | 1037.98   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Создать общий счет (таблицу buy_pay) на оплату заказа с номером 5. Куда включить номер заказа, количество книг в заказе (название столбца Количество) и его общую стоимость (название столбца Итого). Для решения используйте ОДИН запрос.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/44e123c6-e706-43d9-8f5e-e54c3e35338f/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE buy_pay AS 
SELECT 
  buy_id, 
  SUM(buy_book.amount) AS Количество, 
  SUM(book.price * buy_book.amount) AS Итого 
FROM 
  buy_book 
  JOIN book USING(book_id) 
  JOIN author USING(author_id) 
WHERE 
  buy_book.buy_id = 5;
SELECT 
  * 
FROM 
  buy_pay;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_id | Количество | Итого   |
|:---------------:|:---------------:|:---------------:|
| 5      | 3          | 1578.48 |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. В таблицу buy_step для заказа с номером 5 включить все этапы из таблицы step, которые должен пройти этот заказ. В столбцы date_step_beg и date_step_end всех записей занести Null.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/b104b25f-4a80-4b07-ab1a-f73c25dc3e0b/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO buy_step(buy_id, step_id) 
SELECT 
  buy_id, 
  step_id 
FROM 
  step CROSS 
  JOIN buy 
WHERE 
  buy_id = 5;
SELECT 
  * 
FROM 
  buy_step;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | NULL          | NULL          |
| 18          | 5      | 2       | NULL          | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. В таблицу buy_step занести дату 12.04.2020 выставления счета на оплату заказа с номером 5.  
Правильнее было бы занести не конкретную, а текущую дату. Это можно сделать с помощью функции Now(). Но при этом в разные дни будут вставляться разная дата, и задание нельзя будет проверить, поэтому  вставим дату 12.04.2020.* 

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/82bcc6a0-9bef-4202-acdf-fed95bdeab67/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  buy_step 
  JOIN step USING(step_id) 
SET 
  date_step_beg = '2020-04-12' 
WHERE 
  buy_step.buy_id = 5 
  AND name_step = 'Оплата';
SELECT 
  * 
FROM 
  buy_step;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | 2020-04-12    | NULL          |
| 18          | 5      | 2       | NULL          | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. 

❓*Задание. Завершить этап «Оплата» для заказа с номером 5, вставив в столбец date_step_end дату 13.04.2020, и начать следующий этап («Упаковка»), задав в столбце date_step_beg для этого этапа ту же дату.  
Реализовать два запроса для завершения этапа и начала следующего. Они должны быть записаны в общем виде, чтобы его можно было применять для любых этапов, изменив только текущий этап. Для примера пусть это будет этап «Оплата».* 

*Фрагмент предметной области:*

![](https://ucarecdn.com/38630f8f-d5ae-4284-8133-bee549683afc/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  buy_step 
  JOIN step USING(step_id) 
SET 
  date_step_end = '2020-04-13' 
WHERE 
  buy_step.buy_id = 5 
  AND name_step = 'Оплата';
UPDATE 
  buy_step 
SET 
  date_step_beg = '2020-04-13' 
WHERE 
  buy_id = 5 
  AND step_id = (
    SELECT 
      step_id + 1 
    FROM 
      step 
    WHERE 
      name_step = 'Оплата'
  );
SELECT 
  * 
FROM 
  buy_step;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

|buy_step_id | buy_id | step_id | date_step_beg | date_step_end |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1           | 1      | 1       | 2020-02-20    | 2020-02-20    |
| 2           | 1      | 2       | 2020-02-20    | 2020-02-21    |
| 3           | 1      | 3       | 2020-02-22    | 2020-03-07    |
| 4           | 1      | 4       | 2020-03-06    | 2020-03-06    |
| 5           | 2      | 1       | 2020-02-28    | 2020-02-28    |
| 6           | 2      | 2       | 2020-02-29    | 2020-03-01    |
| 7           | 2      | 3       | 2020-03-02    | NULL          |
| 8           | 2      | 4       | NULL          | NULL          |
| 9           | 3      | 1       | 2020-03-05    | 2020-03-05    |
| 10          | 3      | 2       | 2020-03-05    | 2020-03-06    |
| 11          | 3      | 3       | 2020-03-06    | 2020-03-10    |
| 12          | 3      | 4       | 2020-03-11    | NULL          |
| 13          | 4      | 1       | 2020-03-20    | NULL          |
| 14          | 4      | 2       | NULL          | NULL          |
| 15          | 4      | 3       | NULL          | NULL          |
| 16          | 4      | 4       | NULL          | NULL          |
| 17          | 5      | 1       | 2020-04-12    | 2020-04-13    |
| 18          | 5      | 2       | 2020-04-13    | NULL          |
| 19          | 5      | 3       | NULL          | NULL          |
| 20          | 5      | 4       | NULL          | NULL          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

## 3. Базы данных и SQL запросы

### <a name="ThreeOne"></a> 3.1 База данных «Тестирование», запросы на выборку

В университете реализуется on-line тестирование по нескольким дисциплинам. Каждая дисциплина включает некоторое количество вопросов. Ответы на вопрос представлены в виде вариантов ответов, один из этих вариантов правильный.  
Студент регистрируется в системе, указав свое имя, фамилию и отчество. После этого он может проходить тестирование по одной или нескольким дисциплинам. Студент имеет несколько попыток для прохождения тестирования  (необходимо сохранять дату попытки). Каждому студенту случайным образом выбирается набор вопросов по дисциплине и формируется индивидуальный тест. Студент отвечает на вопросы, выбирая один из предложенных вариантов ответа.  
После окончания тестирования  вычисляется и сохраняется результат (в процентах) попытки.

Концептуальная схема базы данных:

![](https://ucarecdn.com/c3a958bc-1805-4da5-b4b9-e77343f65024/)

Логическая схема базы данных:

![](https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/)

✳ Шаг 2. 

❓*Задание. Вывести студентов, которые сдавали дисциплину «Основы баз данных», указать дату попытки и результат. Информацию вывести по убыванию результатов тестирования.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/d46b4a8e-ef49-4335-815b-f3d685f63a13/)

*Наполнение таблиц attempt, student, subject:*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_student, 
  date_attempt, 
  result 
FROM 
  student 
  JOIN attempt USING(student_id) 
  JOIN subject USING(subject_id) 
WHERE 
  name_subject = 'Основы баз данных' 
ORDER BY 
  3 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_student    | date_attempt | result |
|:---------------:|:---------------:|:---------------:|
| Яковлева Галина | 2020-04-21   | 100    |
| Баранов Павел   | 2020-03-23   | 67     |
| Яковлева Галина | 2020-03-26   | 0      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Вывести, сколько попыток сделали студенты по каждой дисциплине, а также средний результат попыток, который округлить до 2 знаков после запятой. Под результатом попытки понимается процент правильных ответов на вопросы теста, который занесен в столбец result.  В результат включить название дисциплины, а также вычисляемые столбцы Количество и Среднее. Информацию вывести по убыванию средних результатов.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/d8715483-b850-4ce8-8e2d-12ac8ba18d0c/)

*Структура и наполнение таблиц attempt и subject:*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_subject, 
  COUNT(attempt_id) AS Количество, 
  ROUND(
    AVG(result), 
    2
  ) AS Среднее 
FROM 
  subject 
  LEFT JOIN attempt USING(subject_id) 
GROUP BY 
  1 
ORDER BY 
  3 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_subject      | Количество | Среднее |
|:---------------:|:---------------:|:---------------:|
| Основы SQL        | 4          | 58.25   |
| Основы баз данных | 3          | 55.67   |
| Физика            | 0          | NULL    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. Вывести студентов (различных студентов), имеющих максимальные результаты попыток. Информацию отсортировать в алфавитном порядке по фамилии студента.  
Максимальный результат не обязательно будет 100%, поэтому явно это значение в запросе не задавать.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/3d7b1b34-90b4-4d76-aea0-03369872489d/)

*Структура и наполнение таблиц attempt и student:*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_student, 
  result 
FROM 
  student 
  JOIN attempt USING(student_id) 
WHERE 
  result = (
    SELECT 
      MAX(result) 
    FROM 
      attempt
  ) 
ORDER BY 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_student    | result |
|:---------------:|:---------------:|
| Семенов Иван    | 100    |
| Яковлева Галина | 100    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. 

❓*Задание. Если студент совершал несколько попыток по одной и той же дисциплине, то вывести разницу в днях между первой и последней попыткой. В результат включить фамилию и имя студента, название дисциплины и вычисляемый столбец Интервал. Информацию вывести по возрастанию разницы. Студентов, сделавших одну попытку по дисциплине, не учитывать.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/0702acbe-ec20-457d-85e4-6df22e070656/)

*Структура и наполнение таблиц:*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_student, 
  name_subject, 
  DATEDIFF(
    MAX(date_attempt), 
    MIN(date_attempt)
  ) AS Интервал 
FROM 
  attempt 
  JOIN student USING(student_id) 
  JOIN subject USING(subject_id) 
GROUP BY 
  1, 
  2 
HAVING 
  COUNT(subject_id) > 1 
ORDER BY 
  3;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_student    | name_subject      | Интервал |
|:---------------:|:---------------:|:---------------:|
| Яковлева Галина | Основы баз данных | 26       |
| Семенов Иван    | Основы SQL        | 55       |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Студенты могут тестироваться по одной или нескольким дисциплинам (не обязательно по всем). Вывести дисциплину и количество уникальных студентов (столбец назвать Количество), которые по ней проходили тестирование . Информацию отсортировать сначала по убыванию количества, а потом по названию дисциплины. В результат включить и дисциплины, тестирование по которым студенты еще не проходили, в этом случае указать количество студентов 0.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/306248a6-1b7c-4b93-8106-31a368482f0c/)

*Структура и наполнение таблиц attempt и subject:*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_subject, 
  COUNT(
    DISTINCT(student_id)
  ) AS Количество 
FROM 
  subject 
  LEFT JOIN attempt USING(subject_id) 
GROUP BY 
  1 
ORDER BY 
  2 DESC, 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_subject      | Количество |
|:---------------:|:---------------:|
| Основы SQL        | 2          |
| Основы баз данных | 2          |
| Физика            | 0          |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Случайным образом отберите 3 вопроса по дисциплине «Основы баз данных». В результат включите столбцы question_id и name_question.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/332c38fe-08e4-4c27-bc71-3b3200f43c3b/)

*Структура и наполнение таблиц question и subject:*

*таблица question*

| question_id | name_question                                                           | subject_id |
|:---------------:|:---------------:|:---------------:|
| 1           | Запрос на выборку начинается с ключевого слова:                         | 1          |
| 2           | Условие, по которому отбираются записи, задается после ключевого слова: | 1          |
| 3           | Для сортировки используется:                                            | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:                    | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:                | 1          |
| 6           | База данных - это:                                                      | 2          |
| 7           | Отношение - это:                                                        | 2          |
| 8           | Концептуальная модель используется для                                  | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?                     | 2          |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  question_id, 
  name_question 
FROM 
  question 
  JOIN subject USING(subject_id) 
WHERE 
  name_subject = 'Основы баз данных' 
ORDER BY 
  RAND() 
LIMIT 
  3;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| question_id | name_question                          |
|:---------------:|:---------------:|
| 7           | Отношение - это:                       |
| 8           | Концептуальная модель используется для |
| 6           | База данных - это:                     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Вывести вопросы, которые были включены в тест для Семенова Ивана по дисциплине «Основы SQL» 2020-05-17  (значение attempt_id для этой попытки равно 7). Указать, какой ответ дал студент и правильный он или нет (вывести Верно или Неверно). В результат включить вопрос, ответ и вычисляемый столбец  Результат.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/9cea1edc-98ee-4215-ae29-70ebf8aaea21/)

*Наполнение таблиц question, answer, testing:*

*таблица question*

| question_id | name_question                                                           | subject_id |
|:---------------:|:---------------:|:---------------:|
| 1           | Запрос на выборку начинается с ключевого слова:                         | 1          |
| 2           | Условие, по которому отбираются записи, задается после ключевого слова: | 1          |
| 3           | Для сортировки используется:                                            | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:                    | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:                | 1          |
| 6           | База данных - это:                                                      | 2          |
| 7           | Отношение - это:                                                        | 2          |
| 8           | Концептуальная модель используется для                                  | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?                     | 2          |

*таблица answer*

| answer_id | name_answer                                            | question_id | is_correct |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |

*таблица testing*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_question, 
  name_answer, 
  IF(
    is_correct = 1, 'Верно', 'Неверно'
  ) AS Результат 
FROM 
  testing AS t 
  JOIN question AS q ON t.question_id = q.question_id 
  JOIN answer AS a ON a.answer_id = t.answer_id 
WHERE 
  attempt_id = 7;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_question                                            | name_answer           | Результат |
|:---------------:|:---------------:|:---------------:|
| Запрос на выборку начинается с ключевого слова:          | INSERT                | Неверно   |
| Какой запрос выбирает все записи из таблицы student:     | SELECT * FROM student | Верно     |
| Для внутреннего соединения таблиц используется оператор: | CROSS JOIN            | Неверно   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Посчитать результаты тестирования. Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до двух знаков после запятой. Вывести фамилию студента, название предмета, дату и результат. Последний столбец назвать Результат. Информацию отсортировать сначала по фамилии студента, потом по убыванию даты попытки.*

*Логическая схема базы данных (чтобы потренироваться выбирать нужные таблицы):*

![](https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/)

*Наполнение таблиц:*

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

*таблица question*

| question_id | name_question                                                           | subject_id |
|:---------------:|:---------------:|:---------------:|
| 1           | Запрос на выборку начинается с ключевого слова:                         | 1          |
| 2           | Условие, по которому отбираются записи, задается после ключевого слова: | 1          |
| 3           | Для сортировки используется:                                            | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:                    | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:                | 1          |
| 6           | База данных - это:                                                      | 2          |
| 7           | Отношение - это:                                                        | 2          |
| 8           | Концептуальная модель используется для                                  | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?                     | 2          |

*таблица answer*

| answer_id | name_answer                                            | question_id | is_correct |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица testing*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_student, 
  name_subject, 
  date_attempt, 
  ROUND(
    (
      SUM(is_correct) / 3 * 100
    ), 
    2
  ) AS Результат 
FROM 
  attempt 
  JOIN student USING(student_id) 
  JOIN subject USING(subject_id) 
  JOIN testing USING(attempt_id) 
  JOIN answer USING(answer_id) 
GROUP BY 
  1, 
  2, 
  3 
ORDER BY 
  1, 
  3 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_student    | name_subject      | date_attempt | Результат |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Баранов Павел   | Основы SQL        | 2020-04-15   | 33.33     |
| Баранов Павел   | Основы баз данных | 2020-03-23   | 66.67     |
| Семенов Иван    | Основы SQL        | 2020-05-17   | 33.33     |
| Семенов Иван    | Основы SQL        | 2020-04-15   | 66.67     |
| Семенов Иван    | Основы SQL        | 2020-03-23   | 100.00    |
| Яковлева Галина | Основы баз данных | 2020-04-21   | 100.00    |
| Яковлева Галина | Основы баз данных | 2020-03-26   | 0.00      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. 

❓*Задание. Для каждого вопроса вывести процент успешных решений, то есть отношение количества верных ответов к общему количеству ответов, значение округлить до 2-х знаков после запятой. Также вывести название предмета, к которому относится вопрос, и общее количество ответов на этот вопрос. В результат включить название дисциплины, вопросы по ней (столбец назвать Вопрос), а также два вычисляемых столбца Всего_ответов и Успешность. Информацию отсортировать сначала по названию дисциплины, потом по убыванию успешности, а потом по тексту вопроса в алфавитном порядке.  
Поскольку тексты вопросов могут быть длинными, обрезать их 30 символов и добавить многоточие "...".*

*Логическая схема базы данных (чтобы потренироваться выбирать нужные таблицы):*

![](https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/)

*Наполнение таблиц:*

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

*таблица question*

| question_id | name_question                                                           | subject_id |
|:---------------:|:---------------:|:---------------:|
| 1           | Запрос на выборку начинается с ключевого слова:                         | 1          |
| 2           | Условие, по которому отбираются записи, задается после ключевого слова: | 1          |
| 3           | Для сортировки используется:                                            | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:                    | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:                | 1          |
| 6           | База данных - это:                                                      | 2          |
| 7           | Отношение - это:                                                        | 2          |
| 8           | Концептуальная модель используется для                                  | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?                     | 2          |

*таблица answer*

| answer_id | name_answer                                            | question_id | is_correct |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

*таблица testing*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_subject, 
  CONCAT(
    LEFT(name_question, 30), 
    '...'
  ) AS Вопрос, 
  COUNT(testing.answer_id) AS Всего_ответов, 
  ROUND(
    SUM(is_correct) / COUNT(testing.answer_id) * 100, 
    2
  ) AS Успешность 
FROM 
  subject 
  JOIN question USING(subject_id) 
  JOIN testing USING(question_id) 
  LEFT JOIN answer USING(answer_id) 
GROUP BY 
  1, 
  2 
ORDER BY 
  1, 
  4 DESC, 
  2;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_subject      | Вопрос                            | Всего_ответов | Успешность |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Основы SQL        | Условие, по которому отбираютс... | 1             | 100.00     |
| Основы SQL        | Запрос на выборку начинается с... | 4             | 75.00      |
| Основы SQL        | Какой запрос выбирает все запи... | 3             | 66.67      |
| Основы SQL        | Для сортировки используется:...   | 2             | 50.00      |
| Основы SQL        | Для внутреннего соединения таб... | 2             | 0.00       |
| Основы баз данных | База данных - это:...             | 3             | 66.67      |
| Основы баз данных | Какой тип данных не допустим в... | 2             | 50.00      |
| Основы баз данных | Концептуальная модель использу... | 2             | 50.00      |
| Основы баз данных | Отношение - это:...               | 2             | 50.00      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="ThreeTwo"></a> 3.2 База данных «Тестирование», запросы корректировки

✳ Шаг 2. 

❓*Задание. В таблицу attempt включить новую попытку для студента Баранова Павла по дисциплине «Основы баз данных». Установить текущую дату в качестве даты выполнения попытки.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/39672b19-b8ef-4e77-b7a8-236f2ac73fa0/)

*Наполнение таблиц subject, student, attempt (перед выполнением шага):*

*таблица student*    

| student_id | name_student    |  
|:---------------:|:---------------:|
| 1          | Баранов Павел   |  
| 2          | Абрамова Катя   |  
| 3          | Семенов Иван    |  
| 4          | Яковлева Галина |

*таблица subject*

| subject_id | name_subject      |
|:---------------:|:---------------:|
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO attempt(
  student_id, subject_id, date_attempt
) 
SELECT 
  student_id, 
  subject_id, 
  NOW() 
FROM 
  attempt 
  JOIN student USING(student_id) 
  JOIN subject USING(subject_id) 
WHERE 
  name_student = 'Баранов Павел' 
  AND name_subject = 'Основы баз данных';
SELECT 
  * 
FROM 
  attempt;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2022-12-07   | NULL   |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Случайным образом выбрать три вопроса (запрос) по дисциплине, тестирование по которой собирается проходить студент, занесенный в таблицу attempt последним, и добавить их в таблицу testing. id последней попытки получить как максимальное значение id из таблицы attempt.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/c3b8ce24-eaaa-48b7-96c6-6c57dc6e48ca/)

*Корректируемая таблица:*

![](https://ucarecdn.com/58cd697f-3a21-4d89-83db-c8bba6328cdf/)

*Наполнение таблиц question, attempt, testing(перед выполнением шага):*

*таблица question*    

| question_id | name_question                                              | subject_id |
|:---------------:|:---------------:|:---------------:|
| 1           | Запрос на выборку начинается с ключевого слова:            | 1          |
| 2           | Условие, по которому отбираются записи, задается после...  | 1          |
| 3           | Для сортировки используется:                               | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:       | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:   | 1          |
| 6           | База данных - это:                                         | 2          |
| 7           | Отношение - это:                                           | 2          |
| 8           | Концептуальная модель используется для                     | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?        | 2          |

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | NULL   |

*таблица testing*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO testing(attempt_id, question_id) 
SELECT 
  attempt_id, 
  question_id 
FROM 
  attempt 
  JOIN question USING(subject_id) 
WHERE 
  attempt_id = (
    SELECT 
      MAX(attempt_id) 
    FROM 
      attempt
  ) 
ORDER BY 
  RAND() 
LIMIT 
  3;
SELECT 
  * 
FROM 
  testing;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | NULL      |
| 23         | 8          | 8           | NULL      |
| 24         | 8          | 9           | NULL      |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. Студент прошел тестирование (то есть все его ответы занесены в таблицу testing), далее необходимо вычислить результат(запрос) и занести его в таблицу attempt для соответствующей попытки.  Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до целого.  
Будем считать, что мы знаем id попытки,  для которой вычисляется результат, в нашем случае это 8. В таблицу testing занесены следующие ответы пользователя:*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/3d63945a-d5c5-44c8-a3c3-0c44479f7f30/)

*Корректируемая таблица:*

![](https://ucarecdn.com/d1382132-e039-43a2-8cba-30c5f195e4b6/)

*Наполнение таблиц answer, attempt, testing(перед выполнением шага):*

*таблица answer*    

| answer_id | name_answer                                            | question_id | is_correct |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1         | UPDATE                                                 | 1           | 0          |
| 2         | SELECT                                                 | 1           | 1          |
| 3         | INSERT                                                 | 1           | 0          |
| 4         | GROUP BY                                               | 2           | 0          |
| 5         | FROM                                                   | 2           | 0          |
| 6         | WHERE                                                  | 2           | 1          |
| 7         | SELECT                                                 | 2           | 0          |
| 8         | SORT                                                   | 3           | 0          |
| 9         | ORDER BY                                               | 3           | 1          |
| 10        | RANG BY                                                | 3           | 0          |
| 11        | SELECT * FROM student                                  | 4           | 1          |
| 12        | SELECT student                                         | 4           | 0          |
| 13        | INNER JOIN                                             | 5           | 1          |
| 14        | LEFT JOIN                                              | 5           | 0          |
| 15        | RIGHT JOIN                                             | 5           | 0          |
| 16        | CROSS JOIN                                             | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным...  | 6           | 1          |
| 18        | совокупность программ для хранения иобработки ...      | 6           | 0          |
| 19        | строка                                                 | 7           | 0          |
| 20        | столбец                                                | 7           | 0          |
| 21        | таблица                                                | 7           | 1          |
| 22        | обобщенное представление пользователей о данных        | 8           | 1          |
| 23        | описание представления данных в памяти компьютера      | 8           | 0          |
| 24        | база данных                                            | 8           | 0          |
| 25        | file                                                   | 9           | 1          |
| 26        | INT                                                    | 9           | 0          |
| 27        | VARCHAR                                                | 9           | 0          |
| 28        | DATE                                                   | 9           | 0          |

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | NULL   |

*таблица testing*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  attempt 
SET 
  result = (
    SELECT 
      ROUND(
        SUM(is_correct)/ 3 * 100, 
        0
      ) 
    FROM 
      answer 
      JOIN testing USING(answer_id) 
    WHERE 
      attempt_id = 8
  ) 
WHERE 
  attempt_id = 8;
SELECT 
  * 
FROM 
  attempt;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | 67     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. 

❓*Задание. Удалить из таблицы attempt все попытки, выполненные раньше 1 мая 2020 года. Также удалить и все соответствующие этим попыткам вопросы из таблицы testing, которая создавалась следующим запросом:*

```sql
CREATE TABLE testing (
    testing_id INT PRIMARY KEY AUTO_INCREMENT, 
    attempt_id INT, 
    question_id INT, 
    answer_id INT,
    FOREIGN KEY (attempt_id)  REFERENCES attempt (attempt_id) ON DELETE CASCADE
);
```

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/a474d45f-603e-4c75-b581-8d6cdceabbd7/)

*Наполнение таблиц attempt, testing(перед выполнением шага):*

*таблица attempt*

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | 67     |

*таблица testing*

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  attempt 
WHERE 
  date_attempt < "2020-05-01";
SELECT 
  * 
FROM 
  attempt;
SELECT 
  * 
FROM 
  testing;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| attempt_id | student_id | subject_id | date_attempt | result |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 7          | 3          | 1          | 2020-05-17   | 33     |
| 8          | 1          | 2          | 2020-06-12   | 67     |

| testing_id | attempt_id | question_id | answer_id |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
| 22         | 8          | 7           | 19        |
| 23         | 8          | 6           | 17        |
| 24         | 8          | 8           | 22        |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="ThreeThree"></a> 3.3 База данных «Абитуриент», запросы на выборку

Университет состоит из совокупности факультетов (школ). Поступление абитуриентов осуществляется на образовательные программы по результатам Единого государственного экзамена (ЕГЭ). Каждая образовательная программа относится к определенному факультету, для нее определены необходимые для поступления предметы ЕГЭ, минимальный балл по этим предметам, а также план набора (количество мест) на образовательную программу.

В приемную комиссию абитуриенты подают заявления на образовательную программу, каждый абитуриент может выбрать несколько образовательных программ (но не более трех). В заявлении указывается фамилия, имя, отчество абитуриента, а также его достижения: получил ли он медаль за обучение в школе, имеет ли значок ГТО и пр. При этом за каждое достижение определен дополнительный балл. Абитуриент предоставляет сертификат с результатами сдачи  ЕГЭ. Если абитуриент выбирает образовательную программу, то у него обязательно должны быть сданы предметы, определенные на эту программу, причем балл должен быть не меньше минимального по данному предмету.

Зачисление абитуриентов осуществляется так: сначала вычисляется сумма баллов по предметам на каждую образовательную программу, добавляются баллы достижения, затем абитуриенты сортируются в порядке убывания суммы баллов и отбираются первые по количеству мест, определенному планом набора.

Концептуальная схема базы данных:

![](https://ucarecdn.com/b39b62db-8870-428b-a279-e5e0d5241195/)

Логическая схема базы данных:

![](https://ucarecdn.com/12fe86b0-6e53-4d8b-ba52-64f48d692adb/)

✳ Шаг 2. 

❓*Задание. Вывести абитуриентов, которые хотят поступать на образовательную программу «Мехатроника и робототехника» в отсортированном по фамилиям виде.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/5bafc977-00f6-4709-80b1-1ff175681d19/)

*Наполнение таблиц program, enrollee, program_enrollee:*

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица enrollee*

| enrollee_id | name_enrollee   |
|:---------------:|:---------------:|
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |

*таблица program_enrollee*

| program_enrollee_id | program_id | enrollee_id |
|:---------------:|:---------------:|:---------------:|
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_enrollee 
FROM 
  enrollee 
  JOIN program_enrollee USING(enrollee_id) 
  JOIN program USING(program_id) 
WHERE 
  name_program = 'Мехатроника и робототехника' 
ORDER BY 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_enrollee   |
|:---------------:|
| Баранов Павел   |
| Попов Илья      |
| Семенов Иван    |
| Степанова Дарья |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Вывести образовательные программы, на которые для поступления необходим предмет «Информатика». Программы отсортировать в обратном алфавитном порядке.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/8b1f2861-3ed6-4533-9ed0-10fde1ec0f92/)

*Наполнение таблиц program, subject, program_subject:*

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица subject*

| subject_id | name_subject |
|:---------------:|:---------------:|
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |

*таблица program_subject*

| program_subject_id | program_id | subject_id | min_result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_program 
FROM 
  program 
  JOIN program_subject USING(program_id) 
  JOIN subject USING(subject_id) 
WHERE 
  name_subject = 'Информатика' 
ORDER BY 
  1 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_program                        |
|:---------------:|
| Прикладная математика и информатика |
| Математика и компьютерные науки     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. Выведите количество абитуриентов, сдавших ЕГЭ по каждому предмету, максимальное, минимальное и среднее значение баллов по предмету ЕГЭ. Вычисляемые столбцы назвать Количество, Максимум, Минимум, Среднее. Информацию отсортировать по названию предмета в алфавитном порядке, среднее значение округлить до одного знака после запятой.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/b519096f-729d-43ef-b4b2-a752f8169843/)

*Наполнение таблиц subject, enrollee_subject:*

*таблица subject*

| subject_id | name_subject |
|:---------------:|:---------------:|
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |

*таблица enrollee_subject*

| enrollee_subject_id | enrollee_id | subject_id | result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_subject, 
  COUNT(enrollee_id) AS Количество, 
  MAX(result) AS Максимум, 
  MIN(result) AS Минимум, 
  ROUND(
    AVG(result), 
    1
  ) AS Среднее 
FROM 
  subject 
  JOIN enrollee_subject USING(subject_id) 
GROUP BY 
  1 
ORDER BY 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_subject | Количество | Максимум | Минимум | Среднее |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Информатика  | 4          | 94       | 75      | 82.0    |
| Математика   | 6          | 92       | 67      | 75.3    |
| Русский язык | 6          | 90       | 65      | 77.5    |
| Физика       | 5          | 90       | 41      | 69.8    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. 

❓*Задание. Вывести образовательные программы, для которых минимальный балл ЕГЭ по каждому предмету больше или равен 40 баллам. Программы вывести в отсортированном по алфавиту виде.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/c159caa8-0d39-41f8-b5bf-7ccb16669df9/)

*Наполнение таблиц program, program_subject:*

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица program_subject*

| program_subject_id | program_id | subject_id | min_result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_program 
FROM 
  program 
  JOIN program_subject USING(program_id) 
GROUP BY 
  1 
HAVING 
  MIN(min_result) >= 40 
ORDER BY 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_program                        |
|:---------------:|
| Мехатроника и робототехника         |
| Прикладная математика и информатика |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Вывести образовательные программы, которые имеют самый большой план набора,  вместе с этой величиной.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/c59b5da0-f7bc-47ae-bd7d-882a3ccd84a3/)

*Наполнение таблицы program:*

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_program, 
  plan 
FROM 
  program 
WHERE 
  plan = (
    SELECT 
      MAX(plan) 
    FROM 
      program
  );
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_program                | plan |
|:---------------:|:---------------:|
| Мехатроника и робототехника | 3    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Посчитать, сколько дополнительных баллов получит каждый абитуриент. Столбец с дополнительными баллами назвать Бонус. Информацию вывести в отсортированном по фамилиям виде.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/4bd9ba3f-142d-436f-9207-6512de694370/)

*Наполнение таблиц achievement, enrollee, enrollee_achievement:*

*таблица achievement*

| achievement_id | name_achievement      | bonus |
|:---------------:|:---------------:|:---------------:|
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |

*таблица enrollee*

| enrollee_id | name_enrollee   |
|:---------------:|:---------------:|
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |

*таблица enrollee_achievement*

| enrollee_achiev_id | enrollee_id | achievement_id |
|:---------------:|:---------------:|:---------------:|
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_enrollee, 
  SUM(
    IF(bonus IS NULL, 0, bonus)
  ) AS Бонус 
FROM 
  enrollee 
  LEFT JOIN enrollee_achievement USING(enrollee_id) 
  LEFT JOIN achievement USING(achievement_id) 
GROUP BY 
  1 
ORDER BY 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_enrollee   | Бонус |
|:---------------:|:---------------:|
| Абрамова Катя   | 0     |
| Баранов Павел   | 6     |
| Попов Илья      | 8     |
| Семенов Иван    | 5     |
| Степанова Дарья | 0     |
| Яковлева Галина | 1     |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Выведите сколько человек подало заявление на каждую образовательную программу и конкурс на нее (число поданных заявлений деленное на количество мест по плану), округленный до 2-х знаков после запятой. В запросе вывести название факультета, к которому относится образовательная программа, название образовательной программы, план набора абитуриентов на образовательную программу (plan), количество поданных заявлений (Количество) и Конкурс. Информацию отсортировать в порядке убывания конкурса.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/232b551a-2fbc-435e-85e1-513a8bea6043/)

*Наполнение таблиц department, program, program_enrollee:*

*таблица department*

| department_id | name_department         |
|:---------------:|:---------------:|
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица program_enrollee*

| program_enrollee_id | program_id | enrollee_id |
|:---------------:|:---------------:|:---------------:|
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_department, 
  name_program, 
  plan, 
  COUNT(enrollee_id) AS Количество, 
  ROUND(
    (
      COUNT(enrollee_id) / plan
    ), 
    2
  ) AS Конкурс 
FROM 
  department 
  JOIN program USING(department_id) 
  JOIN program_enrollee USING(program_id) 
GROUP BY 
  1, 
  2, 
  3 
ORDER BY 
  5 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_department         | name_program                        | plan | Количество | Конкурс |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| Школа естественных наук | Математика и компьютерные науки     | 1    | 3          | 3.00    |
| Инженерная школа        | Прикладная механика                 | 2    | 4          | 2.00    |
| Школа естественных наук | Прикладная математика и информатика | 2    | 3          | 1.50    |
| Инженерная школа        | Мехатроника и робототехника         | 3    | 4          | 1.33    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Вывести образовательные программы, на которые для поступления необходимы предмет «Информатика» и «Математика» в отсортированном по названию программ виде.*

*Логическая схемы базы данных (чтобы потренироваться выбирать таблицы для запроса):*

![](https://ucarecdn.com/98c706e5-0118-4fa9-ae09-4a934ece5bc8/)

*Наполнение таблиц:*

*таблица department*

| department_id | name_department         |
|:---------------:|:---------------:|
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица enrollee*

| enrollee_id | name_enrollee   |
|:---------------:|:---------------:|
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |

*таблица subject*

| subject_id | name_subject |
|:---------------:|:---------------:|
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |

*таблица program_subject*

| program_subject_id | program_id | subject_id | min_result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |

*таблица program_enrollee*

| program_enrollee_id | program_id | enrollee_id |
|:---------------:|:---------------:|:---------------:|
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |

*таблица enrollee_subject*

| enrollee_subject_id | enrollee_id | subject_id | result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |

*таблица achievement*

| achievement_id | name_achievement      | bonus |
|:---------------:|:---------------:|:---------------:|
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |

*таблица enrollee_achievement*

| enrollee_achiev_id | enrollee_id | achievement_id |
|:---------------:|:---------------:|:---------------:|
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_program 
FROM 
  program 
  JOIN program_subject USING(program_id) 
  JOIN subject USING(subject_id) 
WHERE 
  name_subject IN(
    'Информатика', 'Математика'
  ) 
GROUP BY 
  1 
HAVING 
  COUNT(name_program) = 2 
ORDER BY 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_program                        |
|:---------------:|
| Математика и компьютерные науки     |
| Прикладная математика и информатика |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. 

❓*Задание. Посчитать количество баллов каждого абитуриента на каждую образовательную программу, на которую он подал заявление, по результатам ЕГЭ. В результат включить название образовательной программы, фамилию и имя абитуриента, а также столбец с суммой баллов, который назвать itog. Информацию вывести в отсортированном сначала по образовательной программе, а потом по убыванию суммы баллов виде.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/4f7e6cd2-4d21-46a0-b7ba-52132f8c1fb8/)

*Наполнение таблиц:*

*таблица department*

| department_id | name_department         |
|:---------------:|:---------------:|
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица enrollee*

| enrollee_id | name_enrollee   |
|:---------------:|:---------------:|
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |

*таблица subject*

| subject_id | name_subject |
|:---------------:|:---------------:|
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |

*таблица program_subject*

| program_subject_id | program_id | subject_id | min_result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |

*таблица program_enrollee*

| program_enrollee_id | program_id | enrollee_id |
|:---------------:|:---------------:|:---------------:|
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |

*таблица enrollee_subject*

| enrollee_subject_id | enrollee_id | subject_id | result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |

*таблица achievement*

| achievement_id | name_achievement      | bonus |
|:---------------:|:---------------:|:---------------:|
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |

*таблица enrollee_achievement*

| enrollee_achiev_id | enrollee_id | achievement_id |
|:---------------:|:---------------:|:---------------:|
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_program, 
  name_enrollee, 
  SUM(result) AS itog 
FROM 
  program_enrollee 
  JOIN enrollee_subject USING(enrollee_id) 
  JOIN program_subject USING(program_id, subject_id) 
  JOIN enrollee USING(enrollee_id) 
  JOIN program USING(program_id) 
GROUP BY 
  name_program, 
  name_enrollee 
ORDER BY 
  1, 
  3 DESC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_program                        | name_enrollee   | itog |
|:---------------:|:---------------:|:---------------:|
| Математика и компьютерные науки     | Степанова Дарья | 276  |
| Математика и компьютерные науки     | Семенов Иван    | 230  |
| Математика и компьютерные науки     | Абрамова Катя   | 226  |
| Мехатроника и робототехника         | Степанова Дарья | 270  |
| Мехатроника и робототехника         | Семенов Иван    | 242  |
| Мехатроника и робототехника         | Попов Илья      | 192  |
| Мехатроника и робототехника         | Баранов Павел   | 179  |
| Прикладная математика и информатика | Семенов Иван    | 230  |
| Прикладная математика и информатика | Абрамова Катя   | 226  |
| Прикладная математика и информатика | Баранов Павел   | 213  |
| Прикладная механика                 | Степанова Дарья | 270  |
| Прикладная механика                 | Яковлева Галина | 238  |
| Прикладная механика                 | Попов Илья      | 192  |
| Прикладная механика                 | Баранов Павел   | 179  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. 

❓*Задание. Вывести название образовательной программы и фамилию тех абитуриентов, которые подавали документы на эту образовательную программу, но не могут быть зачислены на нее. Эти абитуриенты имеют результат по одному или нескольким предметам ЕГЭ, необходимым для поступления на эту образовательную программу, меньше минимального балла. Информацию вывести в отсортированном сначала по программам, а потом по фамилиям абитуриентов виде.  
Например, Баранов Павел по «Физике» набрал 41 балл, а  для образовательной программы «Прикладная механика» минимальный балл по этому предмету определен в 45 баллов. Следовательно, абитуриент на данную программу не может поступить.*

*Для этого задания в базу данных добавлена строка:*

```sql
INSERT INTO enrollee_subject (enrollee_id, subject_id, result) VALUES (2, 3, 41);
```

*Добавлен человек, который сдавал Физику, но не подал документы ни на одну образовательную программу, где этот предмет нужен.*

*Логическая схемы базы данных (чтобы потренироваться выбирать таблицы для запроса):*

![](https://ucarecdn.com/98c706e5-0118-4fa9-ae09-4a934ece5bc8/)

*Наполнение таблиц:*

*таблица department*

| department_id | name_department         |
|:---------------:|:---------------:|
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |

*таблица program*

| program_id | name_program                        | department_id | plan |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |

*таблица enrollee*

| enrollee_id | name_enrollee   |
|:---------------:|:---------------:|
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |

*таблица subject*

| subject_id | name_subject |
|:---------------:|:---------------:|
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |

*таблица program_subject*

| program_subject_id | program_id | subject_id | min_result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |

*таблица program_enrollee*

| program_enrollee_id | program_id | enrollee_id |
|:---------------:|:---------------:|:---------------:|
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |

*таблица enrollee_subject*

| enrollee_subject_id | enrollee_id | subject_id | result |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1                   | 1           | 1          | 68     |
| 2                   | 1           | 2          | 70     |
| 3                   | 1           | 3          | 41     |
| 4                   | 1           | 4          | 75     |
| 5                   | 2           | 1          | 75     |
| 6                   | 2           | 2          | 70     |
| 7                   | 2           | 4          | 81     |
| 8                   | 3           | 1          | 85     |
| 9                   | 3           | 2          | 67     |
| 10                  | 3           | 3          | 90     |
| 11                  | 3           | 4          | 78     |
| 12                  | 4           | 1          | 82     |
| 13                  | 4           | 2          | 86     |
| 14                  | 4           | 3          | 70     |
| 15                  | 5           | 1          | 65     |
| 16                  | 5           | 2          | 67     |
| 17                  | 5           | 3          | 60     |
| 18                  | 6           | 1          | 90     |
| 19                  | 6           | 2          | 92     |
| 20                  | 6           | 3          | 88     |
| 21                  | 6           | 4          | 94     |

*таблица achievement*

| achievement_id | name_achievement      | bonus |
|:---------------:|:---------------:|:---------------:|
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |

*таблица enrollee_achievement*

| enrollee_achiev_id | enrollee_id | achievement_id |
|:---------------:|:---------------:|:---------------:|
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  name_program, 
  name_enrollee 
FROM 
  enrollee 
  JOIN program_enrollee USING(enrollee_id) 
  JOIN program USING(program_id) 
  JOIN program_subject USING(program_id) 
  JOIN subject USING(subject_id) 
  JOIN enrollee_subject USING(subject_id, enrollee_id) 
WHERE 
  result < min_result 
GROUP BY 
  1, 
  2 
ORDER BY 
  1, 
  2;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| name_program                | name_enrollee |
|:---------------:|:---------------:|
| Мехатроника и робототехника | Баранов Павел |
| Прикладная механика         | Баранов Павел |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="ThreeFour"></a> 3.4 База данных «Абитуриент», запросы корректировки

✳ Шаг 2. 

❓*Задание. Создать вспомогательную таблицу applicant,  куда включить id образовательной программы, id абитуриента, сумму баллов абитуриентов (столбец itog) в отсортированном сначала по id образовательной программы, а потом по убыванию суммы баллов виде (использовать запрос из предыдущего урока).*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/f80c65d2-82b4-4ae7-8036-3181302256ee/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE applicant AS 
SELECT 
  program_id, 
  enrollee_subject.enrollee_id, 
  SUM(result) AS itog 
FROM 
  program_enrollee 
  JOIN enrollee_subject USING(enrollee_id) 
  JOIN program_subject USING(program_id, subject_id) 
  JOIN enrollee USING(enrollee_id) 
  JOIN program USING(program_id) 
GROUP BY 
  1, 
  2 
ORDER BY 
  1, 
  3 DESC;
SELECT 
  * 
FROM 
  applicant;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| program_id | enrollee_id | itog |
|:---------------:|:---------------:|:---------------:|
| 1          | 3           | 230  |
| 1          | 2           | 226  |
| 1          | 1           | 213  |
| 2          | 6           | 276  |
| 2          | 3           | 230  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 238  |
| 3          | 5           | 192  |
| 3          | 1           | 179  |
| 4          | 6           | 270  |
| 4          | 3           | 242  |
| 4          | 5           | 192  |
| 4          | 1           | 179  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Из таблицы applicant, созданной на предыдущем шаге, удалить записи, если абитуриент на выбранную образовательную программу не набрал минимального балла хотя бы по одному предмету (использовать запрос из предыдущего урока).*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/823d0242-0982-4087-b52b-94aabc9bbb94/)

*таблица applicant:*

![](https://ucarecdn.com/de0838ba-43ec-4cf8-a237-fad5de177b5a/)

✔`РЕШЕНИЕ` ⤵️

```sql
DELETE FROM 
  applicant USING applicant 
  JOIN program_subject USING(program_id) 
  JOIN enrollee_subject USING(subject_id, enrollee_id) 
WHERE 
  result < min_result;
SELECT 
  * 
FROM 
  applicant;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| program_id | enrollee_id | itog |
|:---------------:|:---------------:|:---------------:|
| 1          | 3           | 230  |
| 1          | 2           | 226  |
| 1          | 1           | 213  |
| 2          | 6           | 276  |
| 2          | 3           | 230  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 238  |
| 3          | 5           | 192  |
| 4          | 6           | 270  |
| 4          | 3           | 242  |
| 4          | 5           | 192  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. Повысить итоговые баллы абитуриентов в таблице applicant на значения дополнительных баллов (использовать запрос из предыдущего урока).*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/14d04390-f8c1-4245-be43-dfb319b12ffc/)

*Структура корректируемой таблицы:*

![](https://ucarecdn.com/72ed7dbb-3a6c-450f-8825-37071fd73eb3/)

✔`РЕШЕНИЕ` ⤵️

```sql
UPDATE 
  applicant 
  JOIN (
    SELECT 
      enrollee_id, 
      IFNULL(
        SUM(bonus), 
        0
      ) AS Bonus2 
    FROM 
      enrollee_achievement 
      JOIN achievement USING(achievement_id) 
    GROUP BY 
      enrollee_id
  ) AS t USING(enrollee_id) 
SET 
  itog = itog + Bonus2;
SELECT 
  * 
FROM 
  applicant;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| program_id | enrollee_id | itog |
|:---------------:|:---------------:|:---------------:|
| 1          | 3           | 235  |
| 1          | 2           | 226  |
| 1          | 1           | 219  |
| 2          | 6           | 276  |
| 2          | 3           | 235  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 239  |
| 3          | 5           | 200  |
| 4          | 6           | 270  |
| 4          | 3           | 247  |
| 4          | 5           | 200  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. 

❓*Задание. Поскольку при добавлении дополнительных баллов, абитуриенты по каждой образовательной программе могут следовать не в порядке убывания суммарных баллов, необходимо создать новую таблицу applicant_order на основе таблицы applicant. При создании таблицы данные нужно отсортировать сначала по id образовательной программы, потом по убыванию итогового балла. А таблицу applicant, которая была создана как вспомогательная, необходимо удалить.*

*Структура корректируемой таблицы:*

![](https://ucarecdn.com/72ed7dbb-3a6c-450f-8825-37071fd73eb3/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE applicant_order AS 
SELECT 
  program_id, 
  enrollee_id, 
  itog 
FROM 
  applicant 
ORDER BY 
  1, 
  3 DESC;
SELECT 
  * 
FROM 
  applicant_order;
DROP 
  TABLE applicant;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| program_id | enrollee_id | itog |
|:---------------:|:---------------:|:---------------:|
| 1          | 3           | 235  |
| 1          | 2           | 226  |
| 1          | 1           | 219  |
| 2          | 6           | 276  |
| 2          | 3           | 235  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 239  |
| 3          | 5           | 200  |
| 4          | 6           | 270  |
| 4          | 3           | 247  |
| 4          | 5           | 200  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. 

❓*Задание. Включить в таблицу applicant_order новый столбец str_id целого типа , расположить его перед первым.*

*Структура корректируемой таблицы:*

![](https://ucarecdn.com/56d55eb1-112b-406f-a961-a656d00f3258/)

✔`РЕШЕНИЕ` ⤵️

```sql
ALTER TABLE 
  applicant_order 
ADD 
  str_id int FIRST;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| str_id | program_id | enrollee_id | itog |
|:---------------:|:---------------:|:---------------:|:---------------:|
| Null   | 1          | 3           | 235  |
| Null   | 1          | 2           | 226  |
| Null   | 1          | 1           | 219  |
| Null   | 2          | 6           | 276  |
| Null   | 2          | 3           | 235  |
| Null   | 2          | 2           | 226  |
| Null   | 3          | 6           | 270  |
| Null   | 3          | 4           | 239  |
| Null   | 3          | 5           | 200  |
| Null   | 4          | 6           | 270  |
| Null   | 4          | 3           | 247  |
| Null   | 4          | 5           | 200  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Занести в столбец str_id таблицы applicant_order нумерацию абитуриентов, которая начинается с 1 для каждой образовательной программы.*

*Структура корректируемой таблицы:*

![](https://ucarecdn.com/53f4570a-9e0b-4ae7-934b-d74795b99693/)

✔`РЕШЕНИЕ` ⤵️

```sql
SET 
  @row_num := 1;
SET 
  @num_pr := 0;
UPDATE 
  applicant_order 
SET 
  str_id = IF(
    program_id = @num_pr, 
    @row_num := @row_num + 1, 
    @row_num := 1 
    AND @num_pr := @num_pr + 1
  );
SELECT 
  * 
FROM 
  applicant_order;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| str_id | program_id | enrollee_id | itog |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1      | 1          | 3           | 235  |
| 2      | 1          | 2           | 226  |
| 3      | 1          | 1           | 219  |
| 1      | 2          | 6           | 276  |
| 2      | 2          | 3           | 235  |
| 3      | 2          | 2           | 226  |
| 1      | 3          | 6           | 270  |
| 2      | 3          | 4           | 239  |
| 3      | 3          | 5           | 200  |
| 1      | 4          | 6           | 270  |
| 2      | 4          | 3           | 247  |
| 3      | 4          | 5           | 200  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. 

❓*Задание. Создать таблицу student,  в которую включить абитуриентов, которые могут быть рекомендованы к зачислению  в соответствии с планом набора. Информацию отсортировать сначала в алфавитном порядке по названию программ, а потом по убыванию итогового балла.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/21cacbbd-ab78-4347-b1a4-1df3791c875c/)

✔`РЕШЕНИЕ` ⤵️

```sql
CREATE TABLE student 
SELECT 
  name_program, 
  name_enrollee, 
  itog 
FROM 
  enrollee 
  JOIN applicant_order USING(enrollee_id) 
  JOIN program USING(program_id) 
WHERE 
  str_id <= plan 
ORDER BY 
  name_program, 
  itog DESC;
SELECT 
  * 
FROM 
  student;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

|name_program                        | name_enrollee   | itog |
|:---------------:|:---------------:|:---------------:|
| Математика и компьютерные науки     | Степанова Дарья | 276  |
| Мехатроника и робототехника         | Степанова Дарья | 270  |
| Мехатроника и робототехника         | Семенов Иван    | 247  |
| Мехатроника и робототехника         | Попов Илья      | 200  |
| Прикладная математика и информатика | Семенов Иван    | 235  |
| Прикладная математика и информатика | Абрамова Катя   | 226  |
| Прикладная механика                 | Степанова Дарья | 270  |
| Прикладная механика                 | Яковлева Галина | 239  |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

### <a name="ThreeFive"></a> 3.5 База данных "Учебная аналитика по курсу"

Курс на платформе Stepik состоит из нескольких модулей, каждый модуль включает несколько уроков, для каждого урока хранится информация о его положении в модуле. Каждый урок состоит из последовательности шагов. Каждый шаг имеет свой тип (это может быть текст, задание на SQL и пр.) и также порядковый номер в уроке.

Пользователи регистрируются на курсе, указывают свое имя. Когда пользователь проходит курс на платформе Stepik, все его действия оставляют "цифровой след": какие задания и когда он выполнил, сколько попыток сделал, правильно ли решил задание. Также хранятся все его комментарии. Если пользователь проходит курс и получает сертификат, то сохраняется дата его выдачи. Вся эта информация является первичной для учебной аналитики.

Учебная аналитика – это измерение, сбор, анализ и представление данных об обучающихся и их действиях на online платформе с целью понимания и оптимизации учебного процесса и той среды, где этот процесс происходит.

Для данного урока была создана база данных с полным описанием структуры курса. Учебная аналитика же включена в базу не в полном объеме, а только для некоторой группы пользователей из-за большого объема данных. Так, например, информация о решениях 17000 пользователей по нашему курсу за полгода его существования содержит 534500 записей. 

Пользователей для базы данных урока мы отобрали так:

отбросили всех, кто не выполнил ни одного задания (их оказалось 8800);
сгруппировали оставшихся пользователей в зависимости от количества решенных заданий, вот что получилось (считаем, что те, кто не отсылал задания больше месяца, покинули курс):

|	|Всего	|Закончили обучение или покинули курс |Активные пользователи|
|:---------------:|:---------------:|:---------------:|:---------------:|
|Выполнили все задания	|116	|75	|41|
|Получили сертификат	|617	|470	|147|
|Третий модуль	|225	|220	|5|
|Второй модуль	|940	|762	|178|
|Первый модуль, 5-7 урок	|1077	|891	|186|
|Первый модуль, 4 урок	|701	|589	|112|
|Первый модуль, 3 урок	|823	|670	|153|
|Первый модуль, 2 урок	|1268	|1044	|224|
|Первый модуль, 1 урок	|2430	|2020	|410|

+ затем отобрали типичных представителей групп более или менее пропорционально численности каждой группы (имена пользователей, конечно, заменили);
+ поскольку пользователи отправляли от 1 до 1000 решений за время прохождения курса, в базу включили только попытки  шагов, относящихся к урокам 1.2, 2.2 и 2.4.
Получилось 64 пользователя и более 2000 их попыто

[Наполнение таблиц](https://stepik.org/lesson/404275/step/1?unit=393473)

✳ Шаг 2. 

❓*Задание. Отобрать все шаги, в которых рассматриваются вложенные запросы (то есть в названии шага упоминаются вложенные запросы). Указать к какому уроку и модулю они относятся. Для этого вывести 3 поля:*   
+ *в поле Модуль указать номер модуля и его название через пробел;*  
+ *в поле Урок указать номер модуля, порядковый номер урока (lesson_position) через точку и название урока через пробел;*  
+ *в поле Шаг указать номер модуля, порядковый номер урока (lesson_position) через точку, порядковый номер шага (step_position) через точку и название шага через пробел.*

*Длину полей Модуль и Урок ограничить 19 символами, при этом слишком длинные надписи обозначить многоточием в конце (16 символов - это номер модуля или урока, пробел и  название Урока или Модуля к ним присоединить "..."). Информацию отсортировать по возрастанию номеров модулей, порядковых номеров уроков и порядковых номеров шагов.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/da5f161d-0dd9-497c-a9fd-3c3a94ee45b8/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  CONCAT(
    LEFT(
      CONCAT(module_id, ' ', module_name), 
      16
    ), 
    '...'
  ) AS Модуль, 
  CONCAT(
    LEFT(
      CONCAT(
        module_id, '.', lesson_position, ' ', 
        lesson_name
      ), 
      16
    ), 
    '...'
  ) AS Урок, 
  CONCAT(
    module_id, '.', lesson_position, '.', 
    step_position, ' ', step_name
  ) AS Шаг 
FROM 
  module 
  JOIN lesson USING(module_id) 
  JOIN step USING(lesson_id) 
WHERE 
  step_name LIKE '%ложенн% запрос%' 
ORDER BY 
  module_id, 
  lesson_id, 
  step_id;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Модуль              | Урок                | Шаг                                                         |
|:---------------:|:---------------:|:---------------:|
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.2 Вложенный запрос, возвращающий одно значение          |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.3 Использование вложенного запроса в выражении          |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.4 Вложенный запрос, оператор IN                         |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.5 Вложенный запрос, операторы ANY и ALL                 |
| 1 Основы реляцио... | 1.4 Вложенные за... | 1.4.6 Вложенный запрос после SELECT                         |
| 1 Основы реляцио... | 1.5 Запросы корр... | 1.5.5 Добавление записей, вложенные запросы                 |
| 2 Запросы SQL к ... | 2.2 Запросы на в... | 2.2.7 Запросы для нескольких таблиц со вложенными запросами |
| 2 Запросы SQL к ... | 2.2 Запросы на в... | 2.2.8 Вложенные запросы в операторах соединения             |
| 2 Запросы SQL к ... | 2.3 Запросы корр... | 2.3.5 Запрос на обновление, вложенные запросы               |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 3. 

❓*Задание. Заполнить таблицу step_keyword следующим образом: если ключевое слово есть в названии шага, то включить в step_keyword строку с id шага и id ключевого слова.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/ac7f46e6-bc33-4aa9-9240-c35f638eee4f/)

✔`РЕШЕНИЕ` ⤵️

```sql
INSERT INTO step_keyword(step_id, keyword_id) 
SELECT 
  step_id, 
  keyword_id 
FROM 
  keyword CROSS 
  JOIN step 
WHERE 
  regexp_instr(
    step_name, 
    concat('\\b', keyword_name, '\\b')
  );
SELECT 
  * 
FROM 
  step_keyword;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| step_id | keyword_id |
|:---------------:|:---------------:|
| 38      | 1          |
| 81      | 3          |
| 82      | 4          |
| 82      | 5          |
| 82      | 6          |
| 81      | 7          |
| 82      | 7          |
| 83      | 7          |
| 83      | 8          |
| 47      | 10         |
| 47      | 11         |
| 42      | 15         |
| 43      | 16         |
| 44      | 16         |
| 42      | 17         |
| 43      | 18         |
| 46      | 18         |
| 43      | 19         |
| 88      | 26         |
| 112     | 27         |
| 113     | 27         |
| 37      | 28         |
| 37      | 29         |
| 18      | 30         |
| 36      | 30         |
| 19      | 31         |
| 18      | 32         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 4. 

❓*Задание. Реализовать поиск по ключевым словам. Вывести шаги, с которыми связаны ключевые слова MAX и AVG одновременно. Для шагов указать id модуля, позицию урока в модуле, позицию шага в уроке через точку, после позиции шага перед заголовком - пробел. Позицию шага в уроке вывести в виде двух цифр (если позиция шага меньше 10, то перед цифрой поставить 0). Столбец назвать Шаг. Информацию отсортировать по первому столбцу в алфавитном порядке.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/11b91b0f-e8c1-42b2-a34d-1e8ad5e41960/)

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT 
  CONCAT(
    module_id, 
    '.', 
    lesson_position, 
    IF(
      step_position < 10, 
      CONCAT('.0', step_position), 
      CONCAT('.', step_position)
    ), 
    ' ', 
    step_name
  ) AS Шаг 
FROM 
  step_keyword 
  JOIN step USING(step_id) 
  JOIN lesson USING(lesson_id) 
  JOIN module USING(module_id) 
  JOIN keyword USING(keyword_id) 
WHERE 
  keyword_name like '%AVG%' 
  OR keyword_name like '%MAX%' 
GROUP BY 
  step_id 
HAVING 
  COUNT(keyword_name) = 2 
ORDER BY 
  step_position;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Шаг                                                     |
|:---------------:|
| 1.3.04 Выборка данных, групповые функции MIN, MAX и AVG |
| 1.4.06 Вложенный запрос после SELECT                    |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 5. Выборка данных по нескольким условиям, оператор CASE

❓*Задание. Посчитать, сколько студентов относится к каждой группе. Столбцы назвать Группа, Интервал, Количество. Указать границы интервала.*

✔`РЕШЕНИЕ` ⤵️

```sql
SELECT  
    CASE
        WHEN rate <= 10 THEN "I"
        WHEN rate <= 15 THEN "II"
        WHEN rate <= 27 THEN "III"
        ELSE "IV"
    END AS Группа, 
    CASE
        WHEN rate <= 10 THEN "от 0 до 10"
        WHEN rate <= 15 THEN "от 11 до 15"
        WHEN rate <= 27 THEN "от 16 до 27"
        ELSE "больше 27"
    END AS Интервал, COUNT(student_id) AS Количество
FROM 
  (
    SELECT 
      student_id, 
      COUNT(*) AS rate 
    FROM 
      (
        SELECT 
          student_id, 
          step_id 
        FROM 
          step_student 
        WHERE 
          result = "correct" 
        GROUP BY 
          student_id, 
          step_id
      ) query_in 
    GROUP BY 
      student_id 
    ORDER BY 
      2
  ) query_in_1 
GROUP BY 
  Группа, 
  Интервал;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Группа | Интервал    | Количество |
|:---------------:|:---------------:|:---------------:|
| I      | от 0 до 10  | 10         |
| II     | от 11 до 15 | 27         |
| III    | от 16 до 27 | 9          |
| IV     | больше 27   | 18         |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 6. Табличные выражения, оператор WITH

❓*Задание. Исправить запрос примера так: для шагов, которые  не имеют неверных ответов,  указать 100 как процент успешных попыток, если же шаг не имеет верных ответов, указать 0. Информацию отсортировать сначала по возрастанию успешности, а затем по названию шага в алфавитном порядке.*

✔`РЕШЕНИЕ` ⤵️

```sql
WITH get_count_correct (st_n_c, count_correct) AS (
  SELECT 
    step_name, 
    count(*) 
  FROM 
    step 
    INNER JOIN step_student USING (step_id) 
  WHERE 
    result = "correct" 
  GROUP BY 
    step_name
), 
get_count_wrong (st_n_w, count_wrong) AS (
  SELECT 
    step_name, 
    count(*) 
  FROM 
    step 
    INNER JOIN step_student USING (step_id) 
  WHERE 
    result = "wrong" 
  GROUP BY 
    step_name
) 
SELECT 
  st_n_c AS Шаг, 
  CASE WHEN ROUND(
    count_correct / (count_correct + count_wrong)* 100
  ) IS NULL THEN 100 ELSE ROUND(
    count_correct / (count_correct + count_wrong)* 100
  ) END AS Успешность 
FROM 
  get_count_correct 
  LEFT JOIN get_count_wrong ON st_n_c = st_n_w 
UNION 
SELECT 
  st_n_w AS Шаг, 
  CASE WHEN ROUND(
    count_correct / (count_correct + count_wrong)* 100
  ) IS NULL THEN 0 ELSE ROUND(
    count_correct / (count_correct + count_wrong)* 100
  ) END AS Успешность 
FROM 
  get_count_correct 
  RIGHT JOIN get_count_wrong ON st_n_c = st_n_w 
ORDER BY 
  Успешность + 0, 
  1 ASC;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Шаг                                                                      | Успешность |
|:---------------:|:---------------:|
| Задание. Работа с архивной таблицей, оператор UNION, часть 1             | 0          |
| Выборка данных, оператор LIKE                                            | 19         |
| Вложенные запросы в операторах соединения                                | 32         |
| Задание. Вывести самый популярный жанр                                   | 33         |
| Запросы для нескольких таблиц с группировкой                             | 33         |
| Задание. Вывести заказы, доставленные с опозданием                       | 35         |
| Задание. Вывести информацию о движении каждого заказа                    | 36         |
| Запросы для нескольких таблиц со вложенными запросами                    | 36         |
| Задание. Вывести подробную информацию о каждом заказе                    | 37         |
| Выборка данных, вычисляемые столбцы, логические функции                  | 44         |
| Операция соединение, использование USING()                               | 45         |
| Перекрестное соединение CROSS JOIN                                       | 45         |
| Задание. Вывести города, в которых живут клиенты магазина                | 48         |
| Задание. Посчитать, сколько раз была заказана каждая книга               | 48         |
| Запросы на основе трех и более связанных таблиц                          | 49         |
| Выборка данных с сортировкой                                             | 53         |
| Внешнее соединение LEFT и RIGHT OUTER JOIN                               | 55         |
| Запросы на выборку из нескольких таблиц                                  | 58         |
| Выборка данных, вычисляемые столбцы, математические функции              | 59         |
| Задание. Вывести клиентов, которые заказывали книги определенного автора | 63         |
| Задание. Вывести информацию об оплате каждого заказа                     | 65         |
| Выборка данных, логические операции                                      | 67         |
| Проектирование концептуальной модели базы данных                         | 70         |
| Выборка данных, операторы BETWEEN, IN                                    | 72         |
| Выборка данных с созданием вычисляемого столбца                          | 74         |
| Выборка отдельных столбцов                                               | 76         |
| Соединение INNER JOIN                                                    | 78         |
| Выборка данных по условию                                                | 81         |
| Выборка отдельных столбцов и присвоение им новых имен                    | 84         |
| Выборка всех данных из таблицы                                           | 87         |
| Задание. Работа с архивной таблицей, оператор UNION, часть 2             | 100        |
| Построение логической схемы базы данных                                  | 100        |

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 7. 

❓*Задание. Вычислить прогресс пользователей по курсу. Прогресс вычисляется как отношение верно пройденных шагов к общему количеству шагов в процентах, округленное до целого. В нашей базе данные о решениях занесены не для всех шагов, поэтому общее количество шагов определить как количество различных шагов в таблице step_student.  
Тем пользователям, которые прошли все шаги (прогресс = 100%) выдать "Сертификат с отличием". Тем, у кого прогресс больше или равен 80% - "Сертификат". Для остальных записей в столбце Результат задать пустую строку ("").  
Информацию отсортировать по убыванию прогресса, затем по имени пользователя в алфавитном порядке.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/e32cf2e7-200e-4ba9-9a7c-86244317d7fb/)

✔`РЕШЕНИЕ` ⤵️

```sql
SET 
  @max = (
    SELECT 
      COUNT(DISTINCT step_id) 
    FROM 
      step_student
  );
WITH table_result(s_n, result_student) AS (
  SELECT 
    student_name, 
    ROUND(
      COUNT(DISTINCT step_id) / @max * 100
    ) 
  FROM 
    student 
    JOIN step_student USING(student_id) 
  WHERE 
    result = "correct" 
  GROUP BY 
    student_name 
  ORDER BY 
    2 DESC
) 
SELECT 
  s_n AS Студент, 
  result_student AS Прогресс, 
  CASE WHEN result_student < 80 THEN '' WHEN result_student BETWEEN 80 
  AND 99 THEN 'Сертификат' ELSE 'Сертификат с отличием' END AS Результат 
FROM 
  table_result 
ORDER BY 
  2 DESC, 
  1;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Студент    | Прогресс | Результат             |
|:---------------:|:---------------:|:---------------:|
| student_60 | 100      | Сертификат с отличием |
| student_15 | 94       | Сертификат            |
| student_18 | 94       | Сертификат            |
|...| | |
| student_29 | 25       |                       |
| student_47 | 25       |                       |

Affected rows: 64

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 8. Оконные функции, оператор OVER, ORDER BY

❓*Задание. Для студента с именем student_61 вывести все его попытки: название шага, результат и дату отправки попытки (submission_time). Информацию отсортировать по дате отправки попытки и указать, сколько минут прошло между отправкой соседних попыток. Название шага ограничить 20 символами и добавить "...". Столбцы назвать Студент, Шаг, Результат, Дата_отправки, Разница.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/7eeaa225-2f02-4721-9d0a-6c3e0beda68d/)

✔`РЕШЕНИЕ` ⤵️

```sql
WITH sd AS (
  SELECT 
    student_name, 
    step_id, 
    result, 
    submission_time AS Дата, 
    submission_time - LAG(submission_time) OVER(
      ORDER BY 
        submission_time
    ) AS Разница 
  FROM 
    step_student 
    JOIN student USING(student_id) 
  WHERE 
    student_name LIKE 'student_61'
) 
SELECT 
  student_name AS Студент, 
  concat(
    LEFT(step_name, 20), 
    '...'
  ) AS Шаг, 
  result AS Результат, 
  FROM_UNIXTIME(Дата) AS Дата_отправки, 
  IF(
    Разница IS NULL, 
    SEC_TO_TIME(0), 
    SEC_TO_TIME(Разница)
  ) AS Разница 
FROM 
  step 
  JOIN sd ON sd.step_id = step.step_id 
ORDER BY 
  Дата_отправки;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Студент    | Шаг                     | Результат | Дата_отправки       | Разница          |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| student_61 | Выборка всех данных ... | correct   | 2020-08-27 14:22:14 | 0:00:00          |
| student_61 | Выборка отдельных ст... | correct   | 2020-08-27 14:23:53 | 0:01:39          |
| student_61 | Выборка отдельных ст... | correct   | 2020-08-27 14:28:41 | 0:04:48          |
| student_61 | Выборка данных с соз... | wrong     | 2020-08-27 14:33:57 | 0:05:16          |
| student_61 | Выборка данных с соз... | wrong     | 2020-08-27 14:34:24 | 0:00:27          |
|...| | | | |
| student_61 | Выборка данных с сор... | correct   | 2020-08-27 16:14:15 | 0:01:24          |
| student_61 | Соединение INNER JOI... | correct   | 2020-09-01 07:25:39 | 4 days, 15:11:24 |
| student_61 | Внешнее соединение L... | wrong     | 2020-09-01 09:53:30 | 2:27:51          |
| student_61 | Внешнее соединение L... | correct   | 2020-09-01 09:53:50 | 0:00:20          |
| student_61 | Перекрестное соедине... | wrong     | 2020-09-01 10:45:30 | 0:51:40          |
| student_61 | Перекрестное соедине... | wrong     | 2020-09-01 10:46:21 | 0:00:51          |
| student_61 | Перекрестное соедине... | correct   | 2020-09-01 10:47:55 | 0:01:34          |

Affected rows: 43

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 9. 

❓*Задание. Посчитать среднее время, за которое пользователи проходят урок по следующему алгоритму:*
*+для каждого пользователя вычислить время прохождения шага как сумму времени, потраченного на каждую попытку (время попытки - это разница между временем отправки задания и временем начала попытки), при этом попытки, которые длились больше 4 часов не учитывать, так как пользователь мог просто оставить задание открытым в браузере, а вернуться к нему на следующий день;*
*+для каждого студента посчитать общее время, которое он затратил на каждый урок;*
*+вычислить среднее время выполнения урока в часах, результат округлить до 2-х знаков после запятой;*
*+вывести информацию по возрастанию времени, пронумеровав строки, для каждого урока указать номер модуля и его позицию в нем.*
*Столбцы результата назвать Номер, Урок, Среднее_время.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/46f3ad63-48e6-43d0-94a0-3c6b1379d124/)

✔`РЕШЕНИЕ` ⤵️

```sql
WITH table1 AS (
  SELECT 
    lesson_id, 
    student_id, 
    SUM(submission_time - attempt_time) AS Время 
  FROM 
    step 
    JOIN step_student USING(step_id) 
  WHERE 
    submission_time - attempt_time <= 14400 
  GROUP BY 
    lesson_id, 
    student_id
), 
table2 AS (
  SELECT 
    lesson_id, 
    round(
      AVG(Время)/ 3600, 
      2
    ) AS Среднее_время 
  FROM 
    table1 
  GROUP BY 
    lesson_id
) 
SELECT 
  ROW_NUMBER() OVER(
    ORDER BY 
      Среднее_время
  ) AS Номер, 
  CONCAT(
    module_id, '.', lesson_position, ' ', 
    lesson_name
  ) AS Урок, 
  Среднее_время 
FROM 
  table2 
  JOIN lesson USING(lesson_id) 
ORDER BY 
  Среднее_время;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Номер | Урок                                                        | Среднее_время |
|:---------------:|:---------------:|:---------------:|
| 1     | 2.2 Запросы на выборку, соединение таблиц                   | 2.37          |
| 2     | 1.2 Выборка данных                                          | 2.65          |
| 3     | 2.4 База данных "Интернет-магазин книг", запросы на выборку | 3.65          |

Affected rows: 3

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 10. Оконные функции, оператор OVER, PARTITION BY

❓*Задание. Вычислить рейтинг каждого студента относительно студента, прошедшего наибольшее количество шагов в модуле (вычисляется как отношение количества пройденных студентом шагов к максимальному количеству пройденных шагов, умноженное на 100). Вывести номер модуля, имя студента, количество пройденных им шагов и относительный рейтинг. Относительный рейтинг округлить до одного знака после запятой. Столбцы назвать Модуль, Студент, Пройдено_шагов и Относительный_рейтинг  соответственно. Информацию отсортировать сначала по возрастанию номера модуля, потом по убыванию относительного рейтинга и, наконец, по имени студента в алфавитном порядке.*

✔`РЕШЕНИЕ` ⤵️

```sql
WITH table1 AS (
  SELECT 
    module_id AS Модуль, 
    student_name AS Студент, 
    COUNT(DISTINCT step_id) AS Пройдено_шагов 
  FROM 
    student 
    JOIN step_student USING(student_id) 
    JOIN step USING(step_id) 
    JOIN lesson USING(lesson_id) 
  WHERE 
    result = 'correct' 
  GROUP BY 
    module_id, 
    student_name
) 
SELECT 
  Модуль, 
  Студент, 
  Пройдено_шагов, 
  ROUND(
    (
      Пройдено_шагов / MAX(Пройдено_шагов) OVER (PARTITION BY Модуль)
    ) * 100, 
    1
  ) AS Относительный_рейтинг 
FROM 
  table1 
ORDER BY 
  Модуль, 
  Относительный_рейтинг DESC, 
  Студент;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Модуль | Студент    | Пройдено_шагов | Относительный_рейтинг |
|:---------------:|:---------------:|:---------------:|:---------------:|
| 1      | student_1  | 11             | 100.0                 |
| 1      | student_10 | 11             | 100.0                 |
| 1      | student_11 | 11             | 100.0                 |
|...| | | |
| 1      | student_47 | 8              | 72.7                  |
| 2      | student_60 | 21             | 100.0                 |
| 2      | student_15 | 19             | 90.5                  |
| 2      | student_18 | 19             | 90.5                  |
| 2      | student_27 | 19             | 90.5                  |
| 2      | student_30 | 19             | 90.5                  |
| 2      | student_31 | 19             | 90.5                  |
| 2      | student_36 | 19             | 90.5                  |
| 2      | student_39 | 19             | 90.5                  |
| 2      | student_4  | 19             | 90.5                  |
| 2      | student_43 | 19             | 90.5                  |
| 2      | student_44 | 19             | 90.5                  |
| 2      | student_46 | 19             | 90.5                  |
| 2      | student_49 | 19             | 90.5                  |
|...| | | |
| 2      | student_48 | 5              | 23.8                  |
| 2      | student_42 | 4              | 19.0                  |
| 2      | student_61 | 3              | 14.3                  |
| 2      | student_13 | 2              | 9.5                   |
| 2      | student_26 | 2              | 9.5                   |

Affected rows: 95

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 11. 

❓*Задание. Проанализировать, в каком порядке и с каким интервалом пользователь отправлял последнее верно выполненное задание каждого урока. В базе занесены попытки студентов  для трех уроков курса, поэтому анализ проводить только для этих уроков.*
*Для студентов прошедших как минимум по одному шагу в каждом уроке, найти последний пройденный шаг каждого урока - крайний шаг, и указать:*
*+ имя студента;*
*+ номер урока, состоящий из номера модуля и через точку позиции каждого урока в модуле;*
*+ время отправки  - время подачи решения на проверку;*
*+ разницу во времени отправки между текущим и предыдущим крайним шагом в днях, при этом для первого шага поставить прочерк ("-"), а количество дней округлить до целого в большую сторону.*
*Столбцы назвать  Студент, Урок,  Макс_время_отправки и Интервал  соответственно. Отсортировать результаты по имени студента в алфавитном порядке, а потом по возрастанию времени отправки.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/83dcbaba-e030-4299-9c1b-9d25a3dd5d67/)

✔`РЕШЕНИЕ` ⤵️

```sql
WITH raw_table AS (
  SELECT 
    student_id, 
    step_position, 
    lesson_id, 
    submission_time, 
    MAX(submission_time) OVER(
      PARTITION BY lesson_id, student_id
    ) AS Макс_время_отправки 
  FROM 
    step_student 
    JOIN step USING(step_id) 
  WHERE 
    student_id IN(
      SELECT 
        student_id 
      FROM 
        step_student 
        JOIN step USING(step_id) 
      WHERE 
        result = 'correct' 
      GROUP BY 
        student_id 
      HAVING 
        COUNT(DISTINCT lesson_id) = 3
    ) 
    AND result = 'correct'
), 
filter_table AS (
  SELECT 
    student_id, 
    lesson_id, 
    from_unixtime(
      Макс_время_отправки
    ) AS Макс_время_отправки, 
    IFNULL(
      CEILING(
        (
          Макс_время_отправки - lag(
            Макс_время_отправки
          ) OVER(
            PARTITION BY student_id 
            ORDER BY 
              Макс_время_отправки
          )
        )/ 86400
      ), 
      '-'
    ) AS Интервал 
  FROM 
    raw_table 
  WHERE 
    submission_time = Макс_время_отправки
), 
res_table AS (
  SELECT 
    student_name AS Студент, 
    concat(module_id, '.', lesson_position) AS Урок, 
    Макс_время_отправки, 
    Интервал 
  FROM 
    filter_table 
    JOIN student USING(student_id) 
    JOIN lesson USING(lesson_id)
) 
SELECT 
  * 
FROM 
  res_table 
ORDER BY 
  Студент, 
  Макс_время_отправки;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Студент    | Урок | Макс_время_отправки | Интервал |
|:---------------:|:---------------:|:---------------:|:---------------:|
| student_15 | 1.2  | 2020-05-20 12:35:57 | -        |
| student_15 | 2.4  | 2020-06-08 07:10:24 | 19       |
| student_15 | 2.2  | 2020-08-18 12:47:03 | 72       |
| student_18 | 1.2  | 2020-04-17 03:22:14 | -        |
| student_18 | 2.2  | 2020-06-18 07:25:44 | 63       |
| student_18 | 2.4  | 2020-06-18 07:34:14 | 1        |
| student_20 | 1.2  | 2020-05-28 12:08:53 | -        |
| student_20 | 2.2  | 2020-06-17 15:55:29 | 21       |
| student_20 | 2.4  | 2020-06-18 09:48:39 | 1        |
| student_23 | 1.2  | 2020-05-24 18:15:27 | -        |
| student_23 | 2.2  | 2020-06-01 04:37:16 | 8        |
| student_23 | 2.4  | 2020-06-01 04:42:36 | 1        |
| student_24 | 1.2  | 2020-04-14 16:16:22 | -        |
| student_24 | 2.2  | 2020-05-11 12:28:49 | 27       |
| student_24 | 2.4  | 2020-05-13 12:20:39 | 2        |
| student_27 | 1.2  | 2020-08-12 10:18:47 | -        |
| student_27 | 2.2  | 2020-08-14 17:14:51 | 3        |
| student_27 | 2.4  | 2020-08-20 12:23:34 | 6        |
| student_30 | 1.2  | 2020-08-10 08:38:49 | -        |
| student_30 | 2.2  | 2020-08-16 12:53:39 | 7        |
| student_30 | 2.4  | 2020-08-19 11:41:49 | 3        |
| student_31 | 1.2  | 2020-06-13 09:03:39 | -        |
| student_31 | 2.2  | 2020-07-02 16:43:36 | 20       |
| student_31 | 2.4  | 2020-07-05 17:18:56 | 4        |
| student_36 | 1.2  | 2020-08-04 07:25:30 | -        |
| student_36 | 2.2  | 2020-08-07 11:39:12 | 4        |
| student_36 | 2.4  | 2020-08-07 20:33:02 | 1        |
| student_39 | 1.2  | 2020-05-31 12:35:10 | -        |
| student_39 | 2.2  | 2020-06-02 09:47:15 | 2        |
| student_39 | 2.4  | 2020-06-02 17:06:41 | 1        |
| student_4  | 1.2  | 2020-05-31 17:46:27 | -        |
| student_4  | 2.2  | 2020-07-27 17:12:45 | 57       |
| student_4  | 2.4  | 2020-07-29 09:21:24 | 2        |
| student_43 | 1.2  | 2020-07-16 21:19:13 | -        |
| student_43 | 2.4  | 2020-08-06 13:02:44 | 21       |
| student_43 | 2.2  | 2020-08-08 20:11:52 | 3        |
| student_44 | 1.2  | 2020-05-26 14:23:39 | -        |
| student_44 | 2.2  | 2020-06-02 11:07:52 | 7        |
| student_44 | 2.4  | 2020-06-06 21:57:20 | 5        |
| student_46 | 1.2  | 2020-05-26 13:02:10 | -        |
| student_46 | 2.4  | 2020-06-03 20:30:01 | 9        |
| student_46 | 2.2  | 2020-06-03 20:54:34 | 1        |
| student_49 | 1.2  | 2020-07-11 16:31:12 | -        |
| student_49 | 2.2  | 2020-07-15 05:00:03 | 4        |
| student_49 | 2.4  | 2020-07-16 04:57:51 | 1        |
| student_50 | 1.2  | 2020-07-01 08:16:41 | -        |
| student_50 | 2.2  | 2020-08-10 08:26:49 | 41       |
| student_50 | 2.4  | 2020-09-09 12:44:00 | 31       |
| student_51 | 1.2  | 2020-09-03 07:24:26 | -        |
| student_51 | 2.2  | 2020-09-07 19:31:01 | 5        |
| student_51 | 2.4  | 2020-09-10 13:12:11 | 3        |
| student_52 | 1.2  | 2020-08-24 18:30:55 | -        |
| student_52 | 2.2  | 2020-09-07 13:51:02 | 14       |
| student_52 | 2.4  | 2020-09-07 22:16:19 | 1        |
| student_53 | 1.2  | 2020-07-11 09:32:33 | -        |
| student_53 | 2.2  | 2020-07-17 12:34:54 | 7        |
| student_53 | 2.4  | 2020-07-19 05:09:32 | 2        |
| student_56 | 1.2  | 2020-07-15 12:20:48 | -        |
| student_56 | 2.2  | 2020-08-06 10:22:13 | 22       |
| student_56 | 2.4  | 2020-08-20 09:18:46 | 14       |
| student_59 | 1.2  | 2020-08-17 19:29:09 | -        |
| student_59 | 2.2  | 2020-08-21 10:35:18 | 4        |
| student_59 | 2.4  | 2020-08-22 10:39:29 | 2        |
| student_60 | 1.2  | 2020-09-01 12:54:58 | -        |
| student_60 | 2.2  | 2020-09-02 15:34:45 | 2        |
| student_60 | 2.4  | 2020-09-03 10:53:13 | 1        |
| student_9  | 1.2  | 2020-05-01 05:40:11 | -        |
| student_9  | 2.2  | 2020-05-05 09:29:20 | 5        |
| student_9  | 2.4  | 2020-05-06 10:52:38 | 2        |

Affected rows: 69

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 12. 

❓*Задание. Для студента с именем student_59 вывести следующую информацию по всем его попыткам:*
*+ информация о шаге: номер модуля, символ '.', позиция урока в модуле, символ '.', позиция шага в модуле;*
*+ порядковый номер попытки для каждого шага - определяется по возрастанию времени отправки попытки;*
*+ результат попытки;*
*+ время попытки (преобразованное к формату времени) - определяется как разность между временем отправки попытки и времени ее начала, в случае если попытка длилась более 1 часа, то время попытки заменить на среднее время всех попыток пользователя по всем шагам без учета тех, которые длились больше 1 часа;*
*+ относительное время попытки  - определяется как отношение времени попытки (с учетом замены времени попытки) к суммарному времени всех попыток  шага, округленное до двух знаков после запятой .*
*Столбцы назвать  Студент,  Шаг, Номер_попытки, Результат, Время_попытки и Относительное_время. Информацию отсортировать сначала по возрастанию id шага, а затем по возрастанию номера попытки (определяется по времени отправки попытки).  
Важно. Все вычисления производить в секундах, округлять и переводить во временной формат только для вывода результата.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/a1d75640-3d9e-4f16-9f02-2868a5a9570e/)

✔`РЕШЕНИЕ` ⤵️

```sql
WITH res_tab AS(
  SELECT 
    student_name AS Студент, 
    CONCAT(
      module_id, '.', lesson_position, '.', 
      step_position
    ) AS Шаг, 
    ROW_NUMBER() OVER(
      PARTITION BY step_id 
      ORDER BY 
        submission_time
    ) AS Номер_попытки, 
    result AS Результат, 
    CASE WHEN submission_time - attempt_time > 3600 THEN (
      SELECT 
        AVG(submission_time - attempt_time) 
      FROM 
        step_student 
        JOIN student ON step_student.student_id = student.student_id 
        AND student_name = 'student_59' 
      WHERE 
        submission_time - attempt_time <= 3600
    ) ELSE submission_time - attempt_time END AS timestamp_attempt, 
    step_id, 
    submission_time 
  FROM 
    step_student 
    JOIN student ON step_student.student_id = student.student_id 
    AND student_name = 'student_59' 
    JOIN step USING(step_id) 
    JOIN lesson USING(lesson_id)
) 
SELECT 
  Студент, 
  Шаг, 
  Номер_попытки, 
  Результат, 
  SEC_TO_TIME(
    round(timestamp_attempt)
  ) AS Время_попытки, 
  ROUND(
    timestamp_attempt / (
      SUM(timestamp_attempt) OVER(PARTITION BY Шаг)
    ) * 100, 
    2
  ) AS Относительное_время 
FROM 
  res_tab 
ORDER BY 
  step_id, 
  submission_time;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Студент    | Шаг    | Номер_попытки | Результат | Время_попытки | Относительное_время |
|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|:---------------:|
| student_59 | 1.2.2  | 1             | correct   | 0:00:28       | 100.00              |
| student_59 | 1.2.3  | 1             | correct   | 0:01:11       | 100.00              |
| student_59 | 1.2.4  | 1             | correct   | 0:06:09       | 100.00              |
| student_59 | 1.2.5  | 1             | correct   | 0:02:24       | 100.00              |
| student_59 | 1.2.6  | 1             | wrong     | 0:09:42       | 90.37               |
| student_59 | 1.2.6  | 2             | wrong     | 0:00:05       | 0.78                |
| student_59 | 1.2.6  | 3             | wrong     | 0:00:23       | 3.57                |
| student_59 | 1.2.6  | 4             | wrong     | 0:00:10       | 1.55                |
| student_59 | 1.2.6  | 5             | correct   | 0:00:20       | 3.11                |
|...| | | | | |
| student_59 | 2.4.7  | 1             | correct   | 0:21:18       | 100.00              |
| student_59 | 2.4.8  | 1             | correct   | 0:33:02       | 100.00              |
| student_59 | 2.4.9  | 1             | wrong     | 0:18:12       | 71.75               |
| student_59 | 2.4.9  | 2             | correct   | 0:07:10       | 28.25               |
| student_59 | 2.4.10 | 1             | correct   | 0:05:32       | 100.00              |
| student_59 | 2.4.11 | 1             | correct   | 0:40:27       | 100.00              |
| student_59 | 2.4.12 | 1             | correct   | 0:07:10       | 100.00              |
| student_59 | 2.4.13 | 1             | correct   | 0:07:15       | 100.00              |

Affected rows: 58

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

✳ Шаг 13. 

❓*Задание. Online курс обучающиеся могут проходить по различным траекториям, проследить за которыми можно по способу решения ими заданий шагов курса. Большинство обучающихся за несколько попыток получают правильный ответ и переходят к следующему шагу. Но есть такие, что остаются на шаге, выполняя несколько верных попыток, или переходят к следующему, оставив нерешенные шаги.  
Выделив эти "необычные" действия обучающихся, можно проследить их траекторию работы с курсом и проанализировать задания, для которых эти действия выполнялись, а затем их как-то изменить.   
Для этой цели необходимо выделить группы обучающихся по способу прохождения шагов:*
*+ I группа - это те пользователи, которые после верной попытки решения шага делают неверную (скорее всего для того, чтобы поэкспериментировать или проверить, как работают примеры);*
*+ II группа - это те пользователи, которые делают больше одной верной попытки для одного шага (возможно, улучшают свое решение или пробуют другой вариант);*
*+ III группа - это те пользователи, которые не смогли решить задание какого-то шага (у них все попытки по этому шагу - неверные).*
*Вывести группу (I, II, III), имя пользователя, количество шагов, которые пользователь выполнил по соответствующему способу. Столбцы назвать Группа, Студент, Количество_шагов. Отсортировать информацию по возрастанию номеров групп, потом по убыванию количества шагов и, наконец, по имени студента в алфавитном порядке.*

*Фрагмент логической схемы базы данных:*

![](https://ucarecdn.com/c91b0e6e-cd41-495e-857e-89c3630da9ce/)

✔`РЕШЕНИЕ` ⤵️

```sql
WITH qr AS (
  SELECT 
    student_name, 
    step_id, 
    count(result) AS sm 
  FROM 
    step_student 
    INNER JOIN student USING(student_id) 
  WHERE 
    result = "correct" 
  GROUP BY 
    1, 
    2 
  HAVING 
    count(result) > 1
) 
SELECT 
  "I" AS Группа, 
  student_name AS Студент, 
  count(step_id) AS Количество_шагов 
FROM 
  (
    SELECT 
      student_name, 
      step_id, 
      IF(
        result = "correct" 
        AND submission_time < MAX(submission_time) OVER (
          PARTITION BY student_name, step_id
        ), 
        IF(
          LEAD(result) OVER (
            PARTITION BY student_id, 
            step_id 
            ORDER BY 
              submission_time
          ) = "wrong", 
          1, 
          0
        ), 
        0
      ) AS change_res 
    FROM 
      step_student 
      INNER JOIN student USING(student_id)
  ) qr1 
WHERE 
  change_res = 1 
GROUP BY 
  1, 
  2 
UNION 
SELECT 
  "II" AS Группа, 
  student_name AS Студент, 
  count(step_id) AS Количество_шагов 
FROM 
  qr 
GROUP BY 
  1, 
  2 
UNION 
SELECT 
  "III" AS Группа, 
  student_name AS Студент, 
  count(DISTINCT step_id) AS Количество_шагов 
FROM 
  (
    SELECT 
      student_id, 
      step_id, 
      SUM(new_result) OVER (PARTITION BY student_id, step_id) AS sum_result 
    FROM 
      (
        SELECT 
          student_id, 
          step_id, 
          IF(result = "wrong", 0, 1) AS new_result 
        FROM 
          step_student
      ) qr_1
  ) qr_2 
  INNER JOIN student USING(student_id) 
WHERE 
  sum_result = 0 
GROUP BY 
  student_id 
ORDER BY 
  Группа, 
  Количество_шагов DESC, 
  Студент;
```

🔎 `РЕЗУЛЬТАТ` ⤵️

| Группа | Студент    | Количество_шагов |
|:---------------:|:---------------:|:---------------:|
| I      | student_15 | 2                |
| I      | student_53 | 2                |
| I      | student_11 | 1                |
|...| | |
| I      | student_9  | 1                |
| II     | student_53 | 4                |
| II     | student_62 | 4                |
| II     | student_34 | 3                |
|...| | |
| II     | student_59 | 1                |
| III    | student_24 | 3                |
| III    | student_33 | 1                |
| III    | student_42 | 1                |
|...| | |
| III    | student_64 | 1                |

Affected rows: 32

┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉┉

## 4. SQL запросы пользователей
Оставлю, чтобы повторить)
### <a name="FourOne"></a> 4.1 База данных «Интернет-магазин книг», часть 1
### <a name="FourTwo"></a> 4.2 База данных «Интернет-магазин книг», часть 2
### <a name="FourThree"></a> 4.3 База данных «Интернет-магазин книг», часть 3
### <a name="FourFour"></a> 4.4 База данных «Тестирование»
